# Фаза 1: Имплементация на Математически Поправки

**Дата:** 2026-02-06  
**Базирано на:** issue-resolutions-2026-02-05.json

## Обобщение

Фаза 1 адресира фундаменталните математически изчисления в AI Diet системата. Всички промени са внедрени в `worker.js` и са експонирани към AI модела чрез обновения analysis prompt.

---

## Issue #7: Унифициран Активност Скор

### Проблем
Объркване в activity factor изчисленията - няколко различни метрики без ясна корелация.

### Решение
Създадена е нова функция `calculateUnifiedActivityScore()` която:
- Мапва дневна активност към скала 1-3
- Извлича спортни дни от седмицата (0-7)
- Комбинира двете в унифициран скор 1-10

### Формула
```
combinedScore = min(10, max(1, dailyActivityLevel + sportDays))

където:
- dailyActivityLevel: "Ниско"=1, "Средно"=2, "Високо"=3
- sportDays: извлечени от sportActivity стринга
```

### Примери
| Дневна Активност | Спортна Активност | Комбиниран Скор |
|------------------|-------------------|-----------------|
| Високо (3)       | Ниска 1-2 дни (1.5) | 4.5 → 5       |
| Ниско (1)        | Средна 2-4 дни (3)  | 4             |
| Средно (2)       | Висока 5-7 дни (6)  | 8             |
| Високо (3)       | Висока 5-7 дни (6)  | 9             |

### Интеграция
- AI prompt показва детайлно изчислението
- Нова скала използвана в TDEE калкулациите
- Лесно разбираема и консистентна метрика

---

## Issue #10: TDEE Множители

### Проблем
Дублирани дефиниции на activity factors, нереалистични прескоци между нива.

### Решение
Обновена функция `calculateTDEE()` с:
- Плавни множители за скала 1-10
- По-реалистични стъпки между нивата
- Legacy поддръжка за стари стрингови нива

### Множители (1-10 скала)
```javascript
{
  1: 1.2,    // Sedentary
  2: 1.3,
  3: 1.375,  // Light
  4: 1.45,
  5: 1.525,
  6: 1.6,    // Moderate
  7: 1.675,
  8: 1.75,   // Very active
  9: 1.85,
  10: 1.95   // Extremely active
}
```

### Предимства
- ✓ Елиминирани дублирани дефиниции
- ✓ По-точни изчисления при междинни нива
- ✓ Плавен преход между стъпките
- ✓ Backwards compatible

---

## Issue #9: Безопасен Калориен Дефицит

### Проблем
Нереалистични TDEE примери, липса на ясно ограничение за дефицит.

### Решение
Създадена функция `calculateSafeDeficit()`:
- **Максимален дефицит: 25%** (hardcoded граница)
- **Стандартен дефицит: 18%** (консервативен за повечето хора)
- AI може да коригира при специфични стратегии

### Формула
```javascript
maxDeficitCalories = TDEE × 0.75  // 25% max deficit
targetCalories = TDEE × 0.82      // 18% standard deficit
```

### Специални Случаи
AI модел може да коригира дефицита при:
- Интермитентно гладуване
- Кето диета с фастинг дни
- Медицински контролирани програми

**Важно:** AI трябва да обоснове всяка корекция над 20% дефицит!

---

## Issue #2 & #28: Макронутриенти

### Проблем
- Circular logic в изчисленията
- Некоректни протеинови формули
- Няма разлика между мъже и жени

### Решение
Създадена функция `calculateMacronutrientRatios()`:

#### Протеин (пол-специфичен)
```
Мъже:
- Активност ≥7: 2.0 g/kg
- Активност ≥5: 1.6 g/kg
- Активност <5: 1.2 g/kg

Жени:
- Активност ≥7: 1.8 g/kg
- Активност ≥5: 1.4 g/kg
- Активност <5: 1.0 g/kg

Корекции:
- Мускулна маса: +20%
- Отслабване: +10% (за запазване на мускули)
```

#### Въглехидрати и Мазнини
Разпределение според активност:
- **Висока активност (≥7):** 60% въглехидрати, 40% мазнини
- **Средна активност (4-6):** 50% въглехидрати, 50% мазнини
- **Ниска активност (<4):** 40% въглехидрати, 60% мазнини

#### Не Циркулярна Логика
```
1. Изчисли протеин в грамове (g/kg × тегло)
2. Конвертирай в калории (грамове × 4)
3. Изчисли процент (калории / общи калории × 100)
4. Разпредели останалото между carbs/fats
5. ВАЛИДИРАЙ: protein% + carbs% + fats% = 100%
```

### Примери

**Жена, 70кг, активност скор 5:**
- Протеин: 1.5 g/kg × 70kg = 105g → 22%
- Въглехидрати: 39%
- Мазнини: 39%

**Мъж, 85кг, активност скор 9:**
- Протеин: 2.2 g/kg × 85kg = 187g → 35%
- Въглехидрати: 39%
- Мазнини: 26%

---

## AI Prompt Интеграция

### Преди
AI получаваше само сурови данни без референтни изчисления.

### Сега
AI prompt включва секция **"BACKEND РЕФЕРЕНТНИ ИЗЧИСЛЕНИЯ"** с:

1. **Унифициран активност скор** (детайлно)
   - Дневна активност → скор
   - Спортна активност → дни
   - Комбиниран скор с интерпретация

2. **BMR** (Mifflin-St Jeor)
   - Формула показана експлицитно
   - Изчислена стойност

3. **TDEE** (с нови множители)
   - TDEE стойност
   - Activity factor използван
   - Връзка с unified score

4. **Безопасен дефицит**
   - Целеви калории (18% дефицит)
   - Максимален дефицит (25%)
   - Забележка за AI корекции

5. **Базови макронутриенти**
   - Протеин % и g/kg (пол-специфичен)
   - Въглехидрати %
   - Мазнини %
   - Валидация (сума = 100%)

### AI Инструкции
AI модел е инструктиран да:
- **ВИДИ** backend изчисленията като референция
- **ПОТВЪРДИ** или **КОРИГИРА** базирано на холистичен анализ
- **ОБЯСНИ** всяка корекция с reasoning

---

## Тестване

### Валидационен Тест
Създаден `/tmp/test_phase1.js` който валидира:

✓ Unified activity score (1-10 скала)  
✓ BMR изчисления (Mifflin-St Jeor)  
✓ TDEE с нови множители  
✓ Безопасен дефицит (≤25%)  
✓ Макронутриенти (сума = 100%)  
✓ Пол-специфични протеини  

### Тестови Сценарии
1. **Ниска активност:** Дневна:Ниско + Спорт:0 дни → Скор:1
2. **Висока активност:** Дневна:Високо + Спорт:5-7 дни → Скор:9
3. **Мъж, висока активност:** Протеин 2.2 g/kg

Всички тестове минават успешно ✓

---

## Файлове Променени

### worker.js
**Нови функции:**
- `calculateUnifiedActivityScore(data)` - lines ~190-234
- `calculateTDEE(bmr, activityLevel)` - updated lines ~236-277
- `calculateMacronutrientRatios(data, activityScore)` - lines ~295-371
- `calculateSafeDeficit(tdee, goal)` - lines ~373-395

**Обновени секции:**
- `generateAnalysisPrompt()` - добавена BACKEND РЕФЕРЕНТНИ ИЗЧИСЛЕНИЯ секция

### Backwards Compatibility
- Legacy TDEE множители запазени (string-based)
- Нови функции не променят съществуващи сигнатури
- AI prompt поддържа и старите и новите формати

---

## Следващи Стъпки

Фаза 1 е завършена. Препоръчани следващи действия:

1. **Мониторинг:** Проследяване на AI генерирани планове за качество
2. **A/B тест:** Сравнение на стари vs нови изчисления
3. **Фаза 2:** AI модел подобрения (медикаменти, chronotype, success rate)

---

## Ключови Метрики

| Метрика | Преди | Сега | Подобрение |
|---------|-------|------|------------|
| Activity метрика | Категориална (5 нива) | Числова (1-10) | По-прецизна |
| TDEE множители | 5 фиксирани | 10 плавни | По-реалистични |
| Дефицит граница | Неясна | 25% max | Ясно дефинирана |
| Протеин калкулация | Циркулярна | Процентна | Не циркулярна |
| Пол-специфичност | Не | Да | Персонализирана |
| AI visibility | Липсва | Пълна | Информирани решения |

---

**Статус:** ✅ ЗАВЪРШЕНО  
**Дата на завършване:** 2026-02-06  
**Следваща фаза:** Фаза 2 - AI Модел Подобрения
