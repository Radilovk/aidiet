<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –Ω–∞ Local Storage –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #10b981; }
        h2 { color: #333; border-bottom: 2px solid #10b981; padding-bottom: 10px; }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #059669; }
        pre {
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –Ω–∞ Local Storage –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</h1>
    
    <div class="test-section">
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ LocalStorage</h2>
        <div id="localStorage-test"></div>
        <button onclick="testLocalStorage()">–¢–µ—Å—Ç–≤–∞–π LocalStorage</button>
    </div>

    <div class="test-section">
        <h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ API Endpoints</h2>
        <div id="api-test"></div>
        <button onclick="testAPIEndpoints()">–¢–µ—Å—Ç–≤–∞–π API</button>
    </div>

    <div class="test-section">
        <h2>3. –°–∏–º—É–ª–∞—Ü–∏—è –Ω–∞ Plan Generation</h2>
        <div id="plan-test"></div>
        <button onclick="testPlanGeneration()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¢–µ—Å—Ç–æ–≤ –ü–ª–∞–Ω</button>
    </div>

    <div class="test-section">
        <h2>4. –°–∏–º—É–ª–∞—Ü–∏—è –Ω–∞ Chat Request</h2>
        <div id="chat-test"></div>
        <button onclick="testChatRequest()">–¢–µ—Å—Ç–≤–∞–π Chat</button>
    </div>

    <div class="test-section">
        <h2>5. –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ LocalStorage –î–∞–Ω–Ω–∏</h2>
        <div id="storage-view"></div>
        <button onclick="viewStorageData()">–ü–æ–∫–∞–∂–∏ –î–∞–Ω–Ω–∏</button>
        <button onclick="clearStorageData()">–ò–∑—á–∏—Å—Ç–∏ –î–∞–Ω–Ω–∏</button>
    </div>

    <script>
        const WORKER_URL = 'https://aidiet.radilov-k.workers.dev';

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Test 1: LocalStorage functionality
        function testLocalStorage() {
            clearResults('localStorage-test');
            
            try {
                // Test write
                const testData = { test: true, timestamp: Date.now() };
                localStorage.setItem('test_data', JSON.stringify(testData));
                addResult('localStorage-test', '‚úì –ó–∞–ø–∏—Å –≤ localStorage: –£—Å–ø–µ—à–µ–Ω', 'success');
                
                // Test read
                const retrieved = JSON.parse(localStorage.getItem('test_data'));
                if (retrieved.test === true) {
                    addResult('localStorage-test', '‚úì –ß–µ—Ç–µ–Ω–µ –æ—Ç localStorage: –£—Å–ø–µ—à–Ω–æ', 'success');
                }
                
                // Test delete
                localStorage.removeItem('test_data');
                addResult('localStorage-test', '‚úì –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –æ—Ç localStorage: –£—Å–ø–µ—à–Ω–æ', 'success');
                
                // Check available storage
                const storageKeys = Object.keys(localStorage);
                addResult('localStorage-test', `üìä –ë—Ä–æ–π –∑–∞–ø–∏—Å–∏ –≤ localStorage: ${storageKeys.length}`, 'info');
                
            } catch (error) {
                addResult('localStorage-test', `‚úó –ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            }
        }

        // Test 2: Check API endpoints
        async function testAPIEndpoints() {
            clearResults('api-test');
            
            addResult('api-test', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ API endpoints...', 'info');
            
            // Test if old endpoints are removed
            try {
                const response = await fetch(`${WORKER_URL}/api/get-plan?userId=test`);
                if (response.status === 404) {
                    addResult('api-test', '‚úì /api/get-plan –ø—Ä–∞–≤–∏–ª–Ω–æ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç (404)', 'success');
                } else {
                    addResult('api-test', `‚ö†Ô∏è /api/get-plan –≤—Å–µ –æ—â–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ (${response.status})`, 'error');
                }
            } catch (error) {
                addResult('api-test', `‚úó –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞: ${error.message}`, 'error');
            }
        }

        // Test 3: Test plan generation (mock data)
        async function testPlanGeneration() {
            clearResults('plan-test');
            
            const mockUserData = {
                name: "Test User",
                age: 30,
                weight: 75,
                height: 175,
                gender: "–ú—ä–∂",
                goal: "–û—Ç—Å–ª–∞–±–≤–∞–Ω–µ",
                sportActivity: "–°—Ä–µ–¥–Ω–∞ (2‚Äì4 –¥–Ω–∏ —Å–µ–¥–º–∏—á–Ω–æ)",
                sleepHours: 7,
                waterIntake: "2-3 –ª–∏—Ç—Ä–∞",
                stressLevel: "–°—Ä–µ–¥–µ–Ω"
            };
            
            addResult('plan-test', '–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –∑–∞—è–≤–∫–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–ª–∞–Ω...', 'info');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/generate-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(mockUserData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.plan) {
                        addResult('plan-test', '‚úì –ü–ª–∞–Ω –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                        addResult('plan-test', `User ID: ${result.userId}`, 'info');
                        
                        // Save to localStorage
                        localStorage.setItem('dietPlan', JSON.stringify(result.plan));
                        localStorage.setItem('userId', result.userId);
                        localStorage.setItem('userData', JSON.stringify(mockUserData));
                        
                        addResult('plan-test', '‚úì –ü–ª–∞–Ω –∑–∞–ø–∞–∑–µ–Ω –≤ localStorage', 'success');
                        
                        // Show plan summary
                        if (result.plan.summary) {
                            addResult('plan-test', 
                                `–ü–ª–∞–Ω: ${result.plan.summary.dailyCalories} –∫–∞–ª–æ—Ä–∏–∏/–¥–µ–Ω`, 
                                'info'
                            );
                        }
                    } else {
                        addResult('plan-test', '‚úó –û—Ç–≥–æ–≤–æ—Ä—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ –≤–∞–ª–∏–¥–µ–Ω –ø–ª–∞–Ω', 'error');
                    }
                } else {
                    addResult('plan-test', `‚úó HTTP –≥—Ä–µ—à–∫–∞: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('plan-test', `‚úó –ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            }
        }

        // Test 4: Test chat request with full context
        async function testChatRequest() {
            clearResults('chat-test');
            
            // Check if we have data in localStorage
            const userData = localStorage.getItem('userData');
            const dietPlan = localStorage.getItem('dietPlan');
            
            if (!userData || !dietPlan) {
                addResult('chat-test', '‚ö†Ô∏è –ú–æ–ª—è, –ø—ä—Ä–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ –ø–ª–∞–Ω (–¢–µ—Å—Ç 3)', 'error');
                return;
            }
            
            const chatHistory = [];
            const testMessage = "–ö–∞–∫–≤–æ –º–æ–≥–∞ –¥–∞ —è–º –∑–∞ –∑–∞–∫—É—Å–∫–∞?";
            
            addResult('chat-test', '–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ chat –∑–∞—è–≤–∫–∞ —Å –ø—ä–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç...', 'info');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: testMessage,
                        userData: JSON.parse(userData),
                        userPlan: JSON.parse(dietPlan),
                        conversationHistory: chatHistory,
                        mode: 'consultation'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        addResult('chat-test', '‚úì Chat –∑–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞', 'success');
                        addResult('chat-test', `–û—Ç–≥–æ–≤–æ—Ä: ${result.response.substring(0, 200)}...`, 'info');
                        
                        if (result.conversationHistory) {
                            addResult('chat-test', 
                                `‚úì –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ (${result.conversationHistory.length} —Å—ä–æ–±—â–µ–Ω–∏—è)`, 
                                'success'
                            );
                        }
                    } else {
                        addResult('chat-test', '‚úó –û—Ç–≥–æ–≤–æ—Ä—ä—Ç –Ω–µ –µ —É—Å–ø–µ—à–µ–Ω', 'error');
                    }
                } else {
                    addResult('chat-test', `‚úó HTTP –≥—Ä–µ—à–∫–∞: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('chat-test', `‚úó –ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
            }
        }

        // Test 5: View storage data
        function viewStorageData() {
            const container = document.getElementById('storage-view');
            container.innerHTML = '';
            
            const keys = ['userId', 'userData', 'dietPlan', 'chatHistory'];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                const div = document.createElement('div');
                div.className = 'test-result info';
                
                if (data) {
                    const preview = data.length > 200 ? data.substring(0, 200) + '...' : data;
                    div.innerHTML = `<strong>${key}:</strong> (${data.length} —Å–∏–º–≤–æ–ª–∞)<br><pre>${preview}</pre>`;
                } else {
                    div.innerHTML = `<strong>${key}:</strong> <em>–Ω—è–º–∞ –¥–∞–Ω–Ω–∏</em>`;
                }
                
                container.appendChild(div);
            });
        }

        function clearStorageData() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ –æ—Ç localStorage?')) {
                localStorage.clear();
                addResult('storage-view', '‚úì –í—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ —Å–∞ –∏–∑—Ç—Ä–∏—Ç–∏', 'success');
                setTimeout(() => viewStorageData(), 500);
            }
        }

        // Auto-run on load
        window.onload = function() {
            testLocalStorage();
            viewStorageData();
        };
    </script>
</body>
</html>
