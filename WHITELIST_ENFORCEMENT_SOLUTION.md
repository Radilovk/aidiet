# Решение: Прилагане на whitelist от archprompt.txt и meallogic.txt

## Проблем
Неразрешени храни (напр. заешко месо/rabbit) се появяват в хранителните планове, въпреки че не са в списъка с позволени храни (whitelist) дефинирани в archprompt.txt и meallogic.txt.

## Първопричина
Промптовете споменават Правило R12 (прилагане на whitelist), но не правят списъците достатъчно ясни в инструкциите за AI, и няма backend валидация, която да улови нарушенията.

## Решение

### 1. Експлицитни Whitelist Секции в AI Промптите
Добавени са подробни WHITELIST секции в двете функции за генериране на промпти:
- `generateMealPlanChunkPrompt()` - за прогресивно генериране
- `generateMealPlanPrompt()` - за едностъпково генериране

#### Разрешени Белтъци (WHITELIST PROTEIN):
- яйца (eggs)
- пилешко (chicken)
- говеждо (beef)
- постна свинска (lean pork)
- риба (white fish, скумрия/mackerel, риба тон/canned tuna)
- кисело мляко (yogurt - plain, несладко)
- извара (cottage cheese - plain)
- сирене (cheese - умерено)
- боб (beans)
- леща (lentils)
- нахут (chickpeas)
- грах (peas)

#### Забранени Белтъци (извън whitelist):
- **пуешко месо (turkey meat)** - HARD BAN (строго забранено)
- **заешко (rabbit)** - извън whitelist
- **патица (duck)** - извън whitelist
- **гъска (goose)** - извън whitelist
- **агне (lamb)** - извън whitelist
- **дивеч (game meat)** - извън whitelist

### 2. Backend Валидация

Добавена е автоматична проверка в `validatePlan()` функцията:

```javascript
// Константи за whitelist валидация
const ADLE_V8_NON_WHITELIST_PROTEINS = [
  'заеш', 'rabbit', 'зайч',
  'патиц', 'патешк', 'duck',
  'гъс', 'goose',
  'агн', 'lamb',
  'дивеч', 'елен', 'deer', 'wild boar', 'глиган'
];
```

#### Как работи валидацията:
1. Проверява всяко ястие в плана за наличие на неразрешени белтъци
2. Ако открие такъв без обосновка "Reason:", връща **грешка**
3. Ако открие такъв С обосновка "Reason:", връща **предупреждение** за проверка
4. Използва правилно съпоставяне на думи в кирилица (с регулярни изрази)

### 3. Правило R12 - Прилагане

От meallogic.txt Rule R12:
```
R12: Извън-whitelist добавяне: По подразбиране=само whitelist. 
     Извън-whitelist САМО ако обективно нужно (MODE/медицинско/наличност), 
     mainstream/универсално, налично в България. 
     Добави ред: Reason: ...
```

Това правило сега се прилага на две нива:
1. **AI ниво**: Промптът инструктира AI да използва само whitelist храни
2. **Backend ниво**: Валидацията проверява дали AI е спазил whitelist-а

### 4. Примери

#### ❌ ГРЕШКА - Неразрешена храна без обосновка:
```json
{
  "name": "Заешко рагу",
  "description": "Заешко месо със зеленчуци"
}
```
**Резултат**: Грешка - "Съдържа ЗАЕШКО което НЕ е в whitelist (ADLE v8 R12)"

#### ✅ ПРЕДУПРЕЖДЕНИЕ - Неразрешена храна с обосновка:
```json
{
  "name": "Заешко рагу",
  "description": "Заешко месо със зеленчуци. Reason: Клиентът има медицинска нужда от диетично месо."
}
```
**Резултат**: Предупреждение - "Съдържа заешко с обосновка - проверете дали е валидна"

#### ✅ OK - Разрешена храна:
```json
{
  "name": "Пилешко филе с броколи",
  "description": "Печено пилешко филе със зелени зеленчуци"
}
```
**Резултат**: Няма грешки или предупреждения

### 5. Тестване

Създаден е тестов скрипт `test-whitelist-validation.js` с 6 тестови случая:
- ✅ Валидни храни от whitelist (пилешко, говеждо)
- ✅ Невалидни храни извън whitelist (заешко, патица, агне)
- ✅ Невалидни храни с обосновка "Reason:"

**Резултат**: 6/6 теста успешно преминати

### 6. Сигурност

Кодът е прегледан и подобрен за сигурност:
- Добавена е `escapeRegex()` функция за предотвратяване на ReDoS атаки
- Добавена е `hasReasonJustification()` helper функция за по-добра поддръжка
- Подобрени са съобщенията за грешки (показват реалната открита дума)
- CodeQL сканиране: **0 проблема**

## Резултат

Сега системата:
1. ✅ Дава **ясни инструкции** на AI за позволените храни
2. ✅ **Валидира** генерираните планове автоматично
3. ✅ **Съобщава** грешки когато се използват неразрешени храни без обосновка
4. ✅ **Позволява** изключения с обосновка "Reason:" когато е обективно необходимо
5. ✅ Работи **надеждно** с български език и кирилица

## Как се използва

### За разработчици:
Валидацията е автоматична. При генериране на план, `validatePlan()` ще провери за нарушения и ще върне грешки/предупреждения.

### За AI модела:
AI моделът вижда експлицитните whitelist-и в промпта и трябва да спазва списъка. Ако трябва да използва храна извън whitelist-а, трябва да добави "Reason: ..." в description-а.

### За потребители:
Потребителите ще виждат само валидни хранителни планове с храни от whitelist-а (или с обосновани изключения).

## Файлове променени
- `worker.js`: Добавени whitelist секции в промптите и backend валидация
- `.gitignore`: Изключен тестовият скрипт от git
- `test-whitelist-validation.js`: Нов тестов скрипт (не се комитва)

## Дата
2026-02-03
