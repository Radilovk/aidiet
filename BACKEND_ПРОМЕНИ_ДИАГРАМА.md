# Визуална Диаграма: Backend Промени в Генериране на План

**Дата:** 2026-02-17

---

## 🔄 ПРЕДИ ПРОМЯНАТА: Стар Процес

```
┌─────────────────────────────────────────────────────────────────┐
│                      STEP 1: АНАЛИЗ                              │
│                                                                  │
│  ВХОД: userData (1,000 токена)                                  │
│  PROMPT: Hardcoded в worker.js                                  │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: analysis (524 токена)                                   │
│         ↓ включва ВСИЧКИ проблеми (+ "Normal")                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    STEP 2: СТРАТЕГИЯ                             │
│                                                                  │
│  ВХОД: userData + ПЪЛЕН analysis (524 токена)                   │
│        + ADLE правила (200 реда) ← ДУБЛИКАТ!                    │
│  PROMPT: Hardcoded в worker.js                                  │
│  ────────────────────────────────────────────                   │
│  ТОКЕНИ: 1,524                                                  │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: strategy (695 токена)                                   │
│  KV ОПЕРАЦИИ: 0 READ, 0 WRITE                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                 STEP 3: ПЛАН ЗА СЕДМИЦАТА                       │
│                    (1 ГОЛЯМА ЗАЯВКА)                            │
│                                                                  │
│  ВХОД: userData + ПЪЛЕН analysis (524 токена)                   │
│        + ПЪЛЕН strategy (695 токена)                            │
│        + ADLE правила (200 реда) ← ДУБЛИКАТ ОТНОВО!             │
│        + Whitelist (1 KV READ)                                  │
│        + Blacklist (1 KV READ)                                  │
│  PROMPT: Hardcoded в worker.js                                  │
│  ────────────────────────────────────────────                   │
│  ТОКЕНИ: 2,500                                                  │
│  ────────────────────────────────────────────                   │
│  МЕТОД: Генерира ВСИЧКИ 7 ДНИ наведнъж                         │
│         ↓ 1 грешка = целият план се проваля                     │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: weekPlan (7 дни)                                        │
│  KV ОПЕРАЦИИ: 2 READ (whitelist + blacklist)                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    STEP 4: ОБОБЩЕНИЕ                             │
│                                                                  │
│  ВХОД: userData + analysis + strategy + weekPlan               │
│        + Whitelist (1 KV READ) ← ОТНОВО!                        │
│        + Blacklist (1 KV READ) ← ОТНОВО!                        │
│        + Supplement guidelines (50 реда) ← ДУБЛИКАТ!            │
│  PROMPT: Hardcoded, нечетки изисквания                          │
│  ────────────────────────────────────────────                   │
│  ТОКЕНИ: 1,775                                                  │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: summary (често < 3 recommendations)                     │
│  KV ОПЕРАЦИИ: 2 READ (whitelist + blacklist повторно)           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   AI LOGGING (9 AI calls)                       │
│                                                                  │
│  4-5 KV WRITE операции на AI call                              │
│  9 AI calls × 4-5 = 36-45 KV WRITE операции                    │
│                                                                  │
│  ❌ ПРОБЛЕМ: 1,000 WRITE/ден ÷ 36 = ~27 планове/ден            │
└─────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
TOTAL ПРЕДИ:
- INPUT ТОКЕНИ:   4,799 токена/план
- KV READ:        4 операции
- KV WRITE:       36 операции (AI logging)
- AI CALLS:       4 (но големи)
- CAPACITY:       ~27 планове/ден (WRITE bottleneck)
- AI COST:        $2.76/план (GPT-4)
═══════════════════════════════════════════════════════════════════
```

---

## 🚀 СЛЕД ПРОМЯНАТА: Нов Процес

```
┌─────────────────────────────────────────────────────────────────┐
│                      STEP 1: АНАЛИЗ                              │
│                                                                  │
│  ВХОД: userData (1,000 токена)                                  │
│  PROMPT: Custom от KV ✅ (може да се променя без deploy)        │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: analysis (филтриран, БЕЗ "Normal")                      │
│         + НОВИ ПОЛЕТА:                                          │
│           - currentHealthStatus (с 10% underestimate)           │
│           - forecastPessimistic (1 година)                      │
│           - forecastOptimistic (1 година)                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    STEP 2: СТРАТЕГИЯ                             │
│                                                                  │
│  ВХОД: userData + COMPACT analysis (327 токена) ✅              │
│        БЕЗ ADLE дубликат ✅                                      │
│  PROMPT: Custom от KV ✅                                        │
│  ────────────────────────────────────────────                   │
│  ТОКЕНИ: 327 (вместо 1,524) = -78.6% 🎉                        │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: strategy                                                │
│  KV ОПЕРАЦИИ: 2 READ (whitelist + blacklist, КЕШИРАНИ)         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ╔═══════════════════════════════════════════════╗
        ║   STEP 3: ПРОГРЕСИВНА ГЕНЕРАЦИЯ (4 CHUNKS)    ║
        ╚═══════════════════════════════════════════════╝
                              ↓
┌──────────────────────────────┐  ┌──────────────────────────────┐
│      CHUNK 1: ДНИ 1-2        │  │      CHUNK 2: ДНИ 3-4        │
│                              │  │                              │
│ ВХОД: COMPACT analysis       │  │ ВХОД: COMPACT analysis       │
│       COMPACT strategy       │  │       COMPACT strategy       │
│       (494 токена) ✅        │  │       + Контекст дни 1-2     │
│ БЕЗ ADLE дубликат ✅         │  │       (494 токена) ✅        │
│ Whitelist/blacklist от КЕШ  │  │ Whitelist/blacklist от КЕШ  │
│                              │  │                              │
│ ИЗХОД: Дни 1-2 ✅            │  │ ИЗХОД: Дни 3-4 ✅            │
│ KV: 0 READ (от кеш)          │  │ KV: 0 READ (от кеш)          │
└──────────────────────────────┘  └──────────────────────────────┘
                ↓                                  ↓
┌──────────────────────────────┐  ┌──────────────────────────────┐
│      CHUNK 3: ДНИ 5-6        │  │       CHUNK 4: ДЕН 7         │
│                              │  │                              │
│ ВХОД: COMPACT analysis       │  │ ВХОД: COMPACT analysis       │
│       COMPACT strategy       │  │       COMPACT strategy       │
│       + Контекст дни 1-4     │  │       + Контекст дни 1-6     │
│       (494 токена) ✅        │  │       (494 токена) ✅        │
│ Whitelist/blacklist от КЕШ  │  │ Whitelist/blacklist от КЕШ  │
│                              │  │                              │
│ ИЗХОД: Дни 5-6 ✅            │  │ ИЗХОД: Ден 7 ✅              │
│ KV: 0 READ (от кеш)          │  │ KV: 0 READ (от кеш)          │
└──────────────────────────────┘  └──────────────────────────────┘
                              ↓
        ╔═══════════════════════════════════════════════╗
        ║  ОБЕДИНЯВАНЕ: weekPlan (7 дни) ✅             ║
        ║  ⚠️ Ако 1 chunk се провали → fallback само    ║
        ║     за този chunk, останалите OK!             ║
        ╚═══════════════════════════════════════════════╝
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    STEP 4: ОБОБЩЕНИЕ                             │
│                                                                  │
│  ВХОД: COMPACT контекст (141 токена) ✅                         │
│        Whitelist/blacklist от КЕШ (0 KV READ) ✅                │
│        БЕЗ supplement guidelines дубликат ✅                     │
│  PROMPT: Custom от KV с ТОЧНИ минимални изисквания ✅           │
│          "МИН 3 recommendations, МИН 3 forbidden"               │
│  ────────────────────────────────────────────                   │
│  ТОКЕНИ: 141 (вместо 1,775) = -92% 🎉                          │
│  ────────────────────────────────────────────                   │
│  ИЗХОД: summary (валиден, мин 3 за всичко)                      │
│  KV ОПЕРАЦИИ: 0 READ (от кеш)                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              AI LOGGING (7 AI calls, ХИБРИД)                    │
│                                                                  │
│  Успешни calls → Cache API (24h, БЕЗ KV WRITE)                 │
│  Error calls → Cache API + KV (permanent)                       │
│                                                                  │
│  ✅ ПОДОБРЕНИЕ: 0-4 KV WRITE (само errors)                      │
│     1,000 WRITE/ден ÷ 4 = ~250-500 планове/ден 🎉              │
└─────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
TOTAL СЛЕД:
- INPUT ТОКЕНИ:   1,962 токена/план (-59.1%) 🎉
- KV READ:        2 операции (whitelist+blacklist, кеширани)
- KV WRITE:       0-4 операции (само errors)
- AI CALLS:       7 (но по-малки, по-ефективни)
- CAPACITY:       ~250-500 планове/ден (+9-18x) 🎉
- AI COST:        $0/план (Gemini FREE tier) 🎉
═══════════════════════════════════════════════════════════════════
```

---

## 📊 СРАВНИТЕЛНА ТАБЛИЦА: ПРЕДИ vs СЛЕД

```
┌──────────────────────────┬─────────────┬─────────────┬──────────────┐
│       МЕТРИКА            │    ПРЕДИ    │    СЛЕД     │  ПОДОБРЕНИЕ  │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ INPUT ТОКЕНИ             │   4,799     │   1,962     │   -59.1%     │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ KV READ операции         │      4      │      2      │   -50%       │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ KV WRITE операции        │     36      │     0-4     │   -89-100%   │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ AI calls                 │      4      │      7      │   +75%       │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ Планове/ден (capacity)   │    ~27      │   ~250-500  │   +9-18x     │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ AI разходи (GPT-4)       │   $2.76     │     $0*     │   -100%      │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ Промпти                  │  Hardcoded  │  KV custom  │   Flexible   │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ Error handling           │   All/None  │  Per-chunk  │   Robust     │
├──────────────────────────┼─────────────┼─────────────┼──────────────┤
│ Разнообразие на менюто   │   Лошо      │  По-добро   │   Better     │
└──────────────────────────┴─────────────┴─────────────┴──────────────┘

* С Gemini 2.0 Flash FREE tier
```

---

## 🔑 КЛЮЧОВИ РАЗЛИКИ В ПОТОКА НА ДАННИТЕ

### ПРЕДИ: Линеен, Монолитен Подход
```
[userData] ──┐
             ├─→ [Step 1] ──→ [Full Analysis (524t)]
             │                          ↓
             ├─→ [Step 2] ←─────────────┘
             │     ↓                    ┌─→ [ADLE Rules (200 lines)]
             │   [Full Strategy (695t)]─┤   [DUPLICATED!]
             │     ↓                    └─────────────┐
             ├─→ [Step 3] ←─────────────┬─────────────┤
             │     ↓                    │             │
             │   [WeekPlan (7 days)]    │             │
             │     ↓                    │             │
             └─→ [Step 4] ←─────────────┴─────────────┘
                   ↓
             [Summary] ←──────── [Supplement Guidelines (50 lines)]
                                 [DUPLICATED!]

ПРОБЛЕМ:
❌ Много дублиран контекст
❌ Големи token counts
❌ 1 грешка = провал
```

### СЛЕД: Компактен, Chunk-Based Подход
```
[userData] ──┐
             ├─→ [Step 1] ──→ [Filtered Analysis]
             │                 ↓ + New Fields (forecasts)
             │                 ↓
             ├─→ [Step 2] ←─── [COMPACT Analysis (327t)]
             │     ↓            БЕЗ дубликати ✅
             │   [Strategy]
             │     ↓
             │   [COMPACT Strategy (167t)]
             │     ↓
             ├─→ [Step 3.1] ←─ [COMPACT Context (494t)]
             │     ↓ Days 1-2
             ├─→ [Step 3.2] ←─ [COMPACT + Previous Days]
             │     ↓ Days 3-4
             ├─→ [Step 3.3] ←─ [COMPACT + Previous Days]
             │     ↓ Days 5-6
             ├─→ [Step 3.4] ←─ [COMPACT + Previous Days]
             │     ↓ Day 7
             │   [WeekPlan (7 days)]
             │     ↓
             └─→ [Step 4] ←─── [COMPACT Everything (141t)]
                   ↓            От КЕШ ✅
             [Summary]

ПОДОБРЕНИЕ:
✅ Минимален контекст
✅ Малки token counts
✅ Partial failures OK
```

---

## 💡 ПРАКТИЧЕСКИ ПРИМЕР: Токени в Действие

### Стъпка 2 (Strategy) - ПРЕДИ vs СЛЕД

#### ПРЕДИ:
```javascript
// Prompt input:
const strategyPrompt = `
Данни за потребител: ${JSON.stringify(userData)}  // ~800 токена

Анализ на здравословното състояние:
${JSON.stringify(analysis)}  // 524 токена - ПЪЛЕН обект!
// Включва:
// - bmr: 1650
// - tdee: 2310
// - recommendedCalories: 1850
// - keyProblems: [
//     {severity: "High", description: "висок холестерол..."},
//     {severity: "Normal", description: "нормално тегло..."},  ← ИЗЛИШНО
//     {severity: "Medium", description: "инсулинова резистентност..."}
//   ]
// - nutritionalDeficiencies: [
//     {nutrient: "Витамин D", description: "много дълъг текст..."},
//     ...
//   ]
// - metabolism: {
//     rate: "бавен",
//     description: "много дълго описание...",  ← ИЗЛИШНО
//     ...
//   }
// + още много полета...

ADLE ХРАНИ И ПРАВИЛА:
${ADLERules}  // 200 реда текст

...инструкции...
`;

// TOTAL: ~1,524 токена
```

#### СЛЕД:
```javascript
// Prompt input:
const strategyPrompt = `
Данни за потребител: ${JSON.stringify(userData)}  // ~800 токена

Анализ (компактен):
${JSON.stringify(analysisCompact)}  // 327 токена - COMPACT!
// Включва САМО:
// {
//   "bmr": 1650,
//   "tdee": 2310,
//   "calories": 1850,
//   "keyProblems": ["висок холестерол", "инсулинова резистентност"],
//   "deficiencies": ["Витамин D", "Магнезий"],
//   "metabolism": "бавен"
// }
// БЕЗ descriptions, БЕЗ Normal severity, БЕЗ излишни полета

БЕЗ ADLE дубликат!  // Вече е в Step 3

...инструкции...
`;

// TOTAL: ~327 токена (-78.6%)
```

---

## 🎯 ЗАКЛЮЧЕНИЕ

### Промените в Backend Участието:

**ПРЕДИ:**
- Backend изпращаше **ПЪЛНИ** обекти на всяка стъпка
- Дублирани правила и guidelines във всяка заявка
- **1 голяма заявка** за meal plan (all-or-nothing)
- Hardcoded промпти → трудна персонализация

**СЛЕД:**
- Backend изпраща **COMPACT** обекти (само нужното)
- Премахнати дубликати → всичко само 1х
- **4 малки заявки** за meal plan (chunk-based)
- KV custom промпти → лесна персонализация

### Резултат:
✅ 59% по-малко токени → $0 разходи  
✅ 9-18x повече капацитет → 250-500 планове/ден  
✅ По-добро error handling → partial failures OK  
✅ По-лесна поддръжка → промпти в KV  

⚠️ Complexity увеличена → 7 AI calls вместо 4  
⚠️ KV logging проблем → 36 WRITE ops (решен с Cache API)  

---

**Автор:** GitHub Copilot  
**Дата:** 2026-02-17  
**Версия:** 1.0 - Визуална диаграма
