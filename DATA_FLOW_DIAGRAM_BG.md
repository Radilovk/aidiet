# Визуална Диаграма на Потока от Данни при Генериране на План

## 📊 Общ Преглед на Архитектурата

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ГЕНЕРИРАНЕ НА ХРАНИТЕЛЕН ПЛАН                    │
│                         (4 основни стъпки)                          │
└─────────────────────────────────────────────────────────────────────┘

Данни от потребителя (questionnaire)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  СТЪПКА 1: АНАЛИЗ (Analysis)                                        │
│  Функция: generateAnalysisPrompt()                                  │
│  Промпт: admin_analysis_prompt.txt                                  │
│                                                                     │
│  ВХОД:                                                              │
│  • Пълен профил на потребителя (name, age, weight, height, goal)   │
│  • Здравни данни (sleep, stress, medications, allergies)           │
│  • Активност, хранителни навици, предпочитания                     │
│                                                                     │
│  ИЗХОД (analysis):                                                  │
│  • bmi, bmiCategory                                                 │
│  • bmr, tdee, recommendedCalories                                   │
│  • macroRatios (protein %, carbs %, fats %, fiber g)               │
│  • macroGrams (protein g, carbs g, fats g)                         │
│  • metabolicProfile, psychoProfile, successChance                   │
│  • healthRisks[], nutritionalNeeds[]                                │
│  • keyProblems[] (title, severity, description)                    │
│  • waterDeficit, physiologicalPhase                                 │
└─────────────────────────────────────────────────────────────────────┘
         │
         │ Компресия: analysis → analysisCompact
         │ (524 токена → 327 токена, -37.6%)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ЩО СЕ ПРЕНАСЯ КЪМ СТЪПКА 2?                                        │
│                                                                     │
│  analysisCompact = {                                                │
│    bmr: number                                                      │
│    tdee: number                                                     │
│    recommendedCalories: number                                      │
│    macroRatios: "Protein: X%, Carbs: Y%, Fats: Z%"                 │
│    macroGrams: "Protein: Xg, Carbs: Yg, Fats: Zg"                  │
│    metabolicProfile: "(първи 200 символа)..."                      │
│    healthRisks: "(първи 3 риска)"                                  │
│    nutritionalNeeds: "(първи 3 нужди)"                             │
│    psychologicalProfile: "(първи 150 символа)..."                  │
│    successChance: number                                            │
│    keyProblems: "(първи 3 проблема)"                               │
│  }                                                                  │
│                                                                     │
│  ПЪЛНИЯТ ОБЕКТ analysis НЕ се изпраща!                              │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  СТЪПКА 2: СТРАТЕГИЯ (Strategy)                                     │
│  Функция: generateStrategyPrompt()                                  │
│  Промпт: admin_strategy_prompt.txt                                  │
│                                                                     │
│  ВХОД:                                                              │
│  • Потребителски данни (data)                                       │
│  • analysisCompact (компресирана версия на анализа)                 │
│                                                                     │
│  ИЗХОД (strategy):                                                  │
│  • dietaryModifier, modifierReasoning                               │
│  • dietType, weeklyMealPattern                                      │
│  • weeklyScheme (meals per day for each day)                        │
│  • mealTiming {pattern, fastingWindows, chronotypeGuidance}        │
│  • keyPrinciples[], foodsToInclude[], foodsToAvoid[]               │
│  • calorieDistribution, macroDistribution                           │
│  • hydrationStrategy, supplementRecommendations[]                   │
│  • psychologicalSupport[]                                           │
│  • communicationStyle {temperament, tone, approach}                 │
│  • mealCountJustification, afterDinnerMealJustification            │
└─────────────────────────────────────────────────────────────────────┘
         │
         │ Компресия: strategy → strategyCompact + analysisCompact
         │ (695 токена → 167 токена, -76%)
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ЩО СЕ ПРЕНАСЯ КЪМ СТЪПКА 3?                                        │
│                                                                     │
│  strategyCompact = {                                                │
│    dietType: string                                                 │
│    weeklyMealPattern: string                                        │
│    mealTiming: string (pattern from mealTiming.pattern)            │
│    keyPrinciples: "principle1; principle2; principle3..."           │
│    foodsToInclude: "food1, food2, food3..."                        │
│    foodsToAvoid: "food1, food2, food3..."                          │
│    calorieDistribution: string                                      │
│    macroDistribution: string                                        │
│    weeklyScheme: object (full)                                      │
│  }                                                                  │
│                                                                     │
│  analysisCompact = {                                                │
│    macroRatios: "Protein: X%, Carbs: Y%, Fats: Z%"                 │
│    macroGrams: "Protein: Xg, Carbs: Yg, Fats: Zg"                  │
│    fiber: "Xg"                                                      │
│  }                                                                  │
│                                                                     │
│  ПЪЛНИТЕ ОБЕКТИ analysis и strategy НЕ се изпращат!                 │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  СТЪПКА 3: ХРАНИТЕЛЕН ПЛАН (Meal Plan)                              │
│  Функция: generateMealPlanChunkPrompt()                             │
│  Промпт: admin_meal_plan_prompt.txt                                 │
│                                                                     │
│  4 ПОД-СТЪПКИ (прогресивна генерация):                              │
│  • 3.1: Ден 1-2                                                     │
│  • 3.2: Ден 3-4                                                     │
│  • 3.3: Ден 5-6                                                     │
│  • 3.4: Ден 7                                                       │
│                                                                     │
│  ВХОД (за всяка под-стъпка):                                        │
│  • Потребителски данни (data)                                       │
│  • strategyCompact (компресирана версия на стратегията)             │
│  • analysisCompact (само макроси и фибри)                           │
│  • bmr, recommendedCalories                                         │
│  • previousDays (от предходните под-стъпки)                         │
│  • cachedFoodLists (whitelist/blacklist)                            │
│                                                                     │
│  ИЗХОД (mealPlan):                                                  │
│  • weekPlan {                                                       │
│      monday: { meals: [...] },                                      │
│      tuesday: { meals: [...] },                                     │
│      ...,                                                           │
│      sunday: { meals: [...] }                                       │
│    }                                                                │
│  • Всяко meal: {name, time, calories, macros, ingredients, recipe} │
└─────────────────────────────────────────────────────────────────────┘
         │
         │ Селективно извличане на данни
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ЩО СЕ ПРЕНАСЯ КЪМ СТЪПКА 4?                                        │
│                                                                     │
│  От Стъпка 1 (analysis):                                            │
│    • bmr                                                            │
│    • recommendedCalories                                            │
│    • keyProblems (като текст)                                       │
│                                                                     │
│  От Стъпка 2 (strategy):                                            │
│    • psychologicalSupport[] (първи 3)                               │
│    • supplementRecommendations[]                                    │
│    • hydrationStrategy                                              │
│    • foodsToInclude[]                                               │
│    • foodsToAvoid[]                                                 │
│                                                                     │
│  От Стъпка 3 (mealPlan):                                            │
│    • weekPlan (пълен седмичен план)                                 │
│                                                                     │
│  От Потребителски Данни:                                            │
│    • allergies, medications, medicalHistory                         │
│                                                                     │
│  Динамични Данни от KV:                                             │
│    • dynamicWhitelistSection (разрешени храни)                      │
│    • dynamicBlacklistSection (забранени храни)                      │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  СТЪПКА 4: ОБОБЩЕНИЕ (Summary)                                      │
│  Функция: generateMealPlanSummaryPrompt()                           │
│  Промпт: admin_summary_prompt.txt                                   │
│                                                                     │
│  ВХОД:                                                              │
│  • Данни от всички предходни стъпки (виж горе)                     │
│  • Изчислени средни стойности (avgCalories, avgProtein, и т.н.)    │
│                                                                     │
│  ИЗХОД (summary):                                                   │
│  • summary {bmr, dailyCalories, macros}                             │
│  • recommendations[] (МИН 3 препоръчителни храни)                   │
│  • forbidden[] (МИН 3 забранени храни)                              │
│  • psychology[] (съвети за мотивация)                               │
│  • waterIntake (хидратация)                                         │
│  • supplements[] (добавки с дозировка)                              │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ЗАВЪРШЕН ХРАНИТЕЛЕН ПЛАН                      │
│                                                                     │
│  {                                                                  │
│    analysis: {...},        // От Стъпка 1                          │
│    strategy: {...},        // От Стъпка 2                          │
│    weekPlan: {...},        // От Стъпка 3                          │
│    summary: {...},         // От Стъпка 4                          │
│    recommendations: [...], // От Стъпка 4                          │
│    forbidden: [...],       // От Стъпка 4                          │
│    psychology: [...],      // От Стъпка 4                          │
│    waterIntake: "...",     // От Стъпка 4                          │
│    supplements: [...]      // От Стъпка 4                          │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔍 Детайлен Поток на Компресия

### Стъпка 1 → Стъпка 2: Компресия на Анализа

```
┌──────────────────────────────────────────┐
│  ПЪЛЕН АНАЛИЗ (analysis)                 │
│  ~524 токена                             │
├──────────────────────────────────────────┤
│  • bmi: 25.5                             │
│  • bmiCategory: "Наднормено тегло"       │
│  • bmr: 1650                             │
│  • tdee: 2310                            │
│  • recommendedCalories: 1965             │
│  • macroRatios: {                        │
│      protein: 30,                        │
│      carbs: 40,                          │
│      fats: 30,                           │
│      fiber: 35                           │
│    }                                     │
│  • macroGrams: {                         │
│      protein: 147,                       │
│      carbs: 196,                         │
│      fats: 65                            │
│    }                                     │
│  • metabolicProfile: "Нормална          │
│    метаболитна скорост с добра          │
│    адаптивност. Има потенциал за        │
│    ефективно отслабване при правилен    │
│    подход. Препоръчва се умерен         │
│    калориен дефицит..."                 │
│  • healthRisks: [                        │
│      "Риск от диабет тип 2",            │
│      "Сърдечно-съдов риск",             │
│      "Чернодробна стеатоза",            │
│      "Артрит",                           │
│      "Апнея при сън"                     │
│    ]                                     │
│  • nutritionalNeeds: [                   │
│      "Повишен прием на омега-3",        │
│      "Витамин D добавка",                │
│      "Магнезий за сън",                  │
│      "Пробиотици за храносмилане",      │
│      "Антиоксиданти"                     │
│    ]                                     │
│  • psychologicalProfile: "Клиентът      │
│    демонстрира високо ниво на           │
│    мотивация и самодисциплина.          │
│    Има реалистични очаквания и          │
│    разбира че промените отнемат време.  │
│    Препоръчва се позитивен подход..."   │
│  • successChance: 75                     │
│  • keyProblems: [                        │
│      {                                   │
│        title: "Хронична хипертония",   │
│        severity: "Critical",             │
│        severityValue: 85,                │
│        description: "..."                │
│      },                                  │
│      {                                   │
│        title: "Инсулинова резистентност",│
│        severity: "Risky",                │
│        severityValue: 70,                │
│        description: "..."                │
│      },                                  │
│      {                                   │
│        title: "Лош сън",                │
│        severity: "Borderline",           │
│        severityValue: 55,                │
│        description: "..."                │
│      }                                   │
│    ]                                     │
│  • waterDeficit: {...}                   │
│  • и още полета...                       │
└──────────────────────────────────────────┘
              │
              │ КОМПРЕСИЯ
              │ worker.js:4524-4549
              ▼
┌──────────────────────────────────────────┐
│  КОМПАКТЕН АНАЛИЗ (analysisCompact)      │
│  ~327 токена (-37.6%)                    │
├──────────────────────────────────────────┤
│  • bmr: 1650                             │
│  • tdee: 2310                            │
│  • recommendedCalories: 1965             │
│  • macroRatios: "Protein: 30%,          │
│      Carbs: 40%, Fats: 30%"             │
│  • macroGrams: "Protein: 147g,          │
│      Carbs: 196g, Fats: 65g"            │
│  • metabolicProfile: "Нормална          │
│      метаболитна скорост с добра        │
│      адаптивност. Има потенциал за      │
│      ефективно отслабване при прав..."  │
│      (ПЪРВИ 200 СИМВОЛА)                │
│  • healthRisks: "Риск от диабет тип 2;  │
│      Сърдечно-съдов риск;               │
│      Чернодробна стеатоза"              │
│      (ПЪРВИ 3 РИСКА)                    │
│  • nutritionalNeeds: "Повишен прием на  │
│      омега-3; Витамин D добавка;        │
│      Магнезий за сън"                    │
│      (ПЪРВИ 3 НУЖДИ)                    │
│  • psychologicalProfile: "Клиентът      │
│      демонстрира високо ниво на         │
│      мотивация и самодисциплина. Има    │
│      реалистични очаквания..."          │
│      (ПЪРВИ 150 СИМВОЛА)                │
│  • successChance: 75                     │
│  • keyProblems: "Хронична хипертония    │
│      (Critical); Инсулинова             │
│      резистентност (Risky); Лош сън    │
│      (Borderline)"                      │
│      (ПЪРВИ 3 ПРОБЛЕМА)                 │
└──────────────────────────────────────────┘
```

### Стъпка 2 → Стъпка 3: Компресия на Стратегията

```
┌──────────────────────────────────────────┐
│  ПЪЛНА СТРАТЕГИЯ (strategy)              │
│  ~695 токена                             │
├──────────────────────────────────────────┤
│  • dietaryModifier: "Средиземноморски"  │
│  • dietType: "Средиземноморска диета"   │
│  • weeklyMealPattern: "3+1 модел"        │
│  • mealTiming: {                         │
│      pattern: "3 основни + 1 леко",     │
│      fastingWindows: "14:10",           │
│      flexibility: "Висока",              │
│      chronotypeGuidance: "..."          │
│    }                                     │
│  • keyPrinciples: [                      │
│      "Фокус върху зеленчуци и плодове", │
│      "Здравословни мазнини от          │
│       маслиново масло и риба",          │
│      "Умерен прием на пълнозърнести",   │
│      "Ограничаване на червено месо",    │
│      "Хидратация с вода и билкови чай"  │
│    ]                                     │
│  • foodsToInclude: [                     │
│      "Риба (сьомга, сардини)",          │
│      "Маслиново масло",                  │
│      "Авокадо",                          │
│      "Зелени листни зеленчуци",         │
│      "Орехи и семена",                   │
│      "Киноа, ориз",                      │
│      "Домати, краставици"                │
│    ]                                     │
│  • foodsToAvoid: [                       │
│      "Рафинирани захари",                │
│      "Преработени меса",                 │
│      "Бързи храни",                      │
│      "Газирани напитки",                 │
│      "Бели хлябове"                      │
│    ]                                     │
│  • calorieDistribution: "30% закуска,   │
│      40% обяд, 25% вечеря, 5% снакове"  │
│  • macroDistribution: "30/40/30"         │
│  • weeklyScheme: {                       │
│      monday: {meals: 4, description: ""}, │
│      tuesday: {meals: 4, description: ""},│
│      ...                                 │
│    }                                     │
│  • hydrationStrategy: "2.5л вода..."     │
│  • supplementRecommendations: [...]      │
│  • psychologicalSupport: [...]           │
│  • и още полета...                       │
└──────────────────────────────────────────┘
              │
              │ КОМПРЕСИЯ
              │ worker.js:1541-1551
              ▼
┌──────────────────────────────────────────┐
│  КОМПАКТНА СТРАТЕГИЯ (strategyCompact)   │
│  ~167 токена (-76%)                      │
├──────────────────────────────────────────┤
│  • dietType: "Средиземноморска диета"   │
│  • weeklyMealPattern: "3+1 модел"        │
│  • mealTiming: "3 основни + 1 леко"     │
│      (САМО pattern)                      │
│  • keyPrinciples: "Фокус върху          │
│      зеленчуци и плодове; Здравословни  │
│      мазнини от маслиново масло и риба; │
│      Умерен прием на пълнозърнести;     │
│      Ограничаване на червено месо;      │
│      Хидратация с вода и билкови чай"   │
│      (ВСИЧКИ, обединени с ;)            │
│  • foodsToInclude: "Риба (сьомга,       │
│      сардини), Маслиново масло,         │
│      Авокадо, Зелени листни зеленчуци,  │
│      Орехи и семена, Киноа, ориз,       │
│      Домати, краставици"                 │
│      (ВСИЧКИ, обединени с ,)            │
│  • foodsToAvoid: "Рафинирани захари,    │
│      Преработени меса, Бързи храни,     │
│      Газирани напитки, Бели хлябове"    │
│      (ВСИЧКИ, обединени с ,)            │
│  • calorieDistribution: "30% закуска,   │
│      40% обяд, 25% вечеря, 5% снакове"  │
│  • macroDistribution: "30/40/30"         │
│  • weeklyScheme: {...}                   │
│      (ПЪЛЕН ОБЕКТ)                      │
└──────────────────────────────────────────┘
```

---

## 🎯 Къде да Правите Промени?

### Вариант 1: САМО промяна на промптовете

```
┌─────────────────────────────────────────────────────────────┐
│  КОЙ ФАЙЛ ДА РЕДАКТИРАТЕ?                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  За промяна на данните в Стъпка 2:                         │
│  → Редактирайте: KV/prompts/admin_strategy_prompt.txt      │
│  → Добавете/премахнете placeholders като:                  │
│     ${analysisData.bmr}                                     │
│     ${analysisData.temperament}                             │
│                                                             │
│  За промяна на данните в Стъпка 3:                         │
│  → Редактирайте: KV/prompts/admin_meal_plan_prompt.txt     │
│  → Добавете/премахнете placeholders като:                  │
│     ${strategyData.keyPrinciples}                           │
│     ${analysisData.macroGrams}                              │
│                                                             │
│  За промяна на данните в Стъпка 4:                         │
│  → Редактирайте: KV/prompts/admin_summary_prompt.txt       │
│  → Добавете/премахнете placeholders като:                  │
│     ${strategyData.psychologicalSupport}                    │
│     ${weekPlan}                                             │
│                                                             │
│  След редактиране:                                          │
│  → Качете към KV: ./KV/upload-kv-keys.sh                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Вариант 2: Промяна на worker.js

```
┌─────────────────────────────────────────────────────────────┐
│  КЪДЕ ДА РЕДАКТИРАТЕ worker.js?                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  За промяна на данните от Стъпка 1→2:                      │
│  → Функция: generateStrategyPrompt()                        │
│  → Ред: 4520-4638                                           │
│  → Обект: analysisCompact (ред 4524-4549)                  │
│                                                             │
│  За промяна на данните от Стъпка 2→3:                      │
│  → Функция: generateMealPlanChunkPrompt()                   │
│  → Ред: 1511-1779                                           │
│  → Обекти: strategyCompact (ред 1541-1551)                 │
│             analysisCompact (ред 1555-1563)                 │
│                                                             │
│  За промяна на данните от Стъпка 3→4:                      │
│  → Функция: generateMealPlanSummaryPrompt()                 │
│  → Ред: 2009-2133                                           │
│  → Не използва compact обекти, директно извлича полета     │
│                                                             │
│  ВАЖНО: След промяна на worker.js, трябва да:              │
│  1. Обновите default промпта във функцията                 │
│  2. Обновите replacePromptVariables() извикването          │
│  3. Обновите съответния KV файл (admin_*_prompt.txt)       │
│  4. Качете промпта към KV: ./KV/upload-kv-keys.sh          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## ⚡ Оптимизация на Токени

### Защо се използват компактни формати?

```
БЕЗ компресия:
┌────────────────────────────────────┐
│  Стъпка 1 → Стъпка 2               │
│  Пълен analysis: ~524 токена       │
│                                    │
│  Стъпка 2 → Стъпка 3               │
│  Пълна strategy: ~695 токена       │
│  Използва се 4 пъти (4 под-стъпки) │
│  Общо: 695 × 4 = 2780 токена       │
│                                    │
│  ОБЩО ВХОДНИ ТОКЕНИ: ~4799         │
└────────────────────────────────────┘

С компресия (ТЕКУЩА):
┌────────────────────────────────────┐
│  Стъпка 1 → Стъпка 2               │
│  Компактен analysis: ~327 токена   │
│  Спестяване: -37.6%                │
│                                    │
│  Стъпка 2 → Стъпка 3               │
│  Компактна strategy: ~167 токена   │
│  Използва се 4 пъти                │
│  Общо: 167 × 4 = 668 токена        │
│  Спестяване: -76%                  │
│                                    │
│  ОБЩО ВХОДНИ ТОКЕНИ: ~1962         │
│  ОБЩО СПЕСТЯВАНЕ: -59.1%           │
└────────────────────────────────────┘

РЕЗУЛТАТ:
✅ По-ниска цена (по-малко входни токени)
✅ По-бързо генериране
✅ Запазено качество (AI получава всички нужни данни)
```

### Когато да добавите повече данни?

```
┌────────────────────────────────────────────────────────┐
│  ДОБРЕ: Добавяте критични полета                       │
│  Пример: Темперамент за персонализация на комуникация │
│                                                        │
│  ЛОШО: Добавяте ВСИЧКИ полета                         │
│  Пример: Целия analysis обект (524 токена)            │
│                                                        │
│  ПРЕПОРЪКА:                                            │
│  • Добавяйте само НЕОБХОДИМИТЕ данни                  │
│  • Използвайте съкратени версии на дълги текстове     │
│  • Обединявайте масиви в string с разделител          │
│  • Тествайте дали промените подобряват качеството     │
└────────────────────────────────────────────────────────┘
```

---

## 📖 Заключение

Системата използва **многостъпкова архитектура с компресия на данни** за оптимизация на токени и разходи, като същевременно запазва качеството на генерирания план.

**Ключови моменти:**
1. Всяка стъпка получава САМО необходимите данни от предходните стъпки
2. Данните се компресират чрез съкращаване на текстове и обединяване на масиви
3. Контролът на данните може да се прави **САМО чрез промптовете** (препоръчително)
4. Промяна на `worker.js` е нужна само ако искате да добавите нови полета или да промените структурата на компактните обекти

За повече информация, вижте [DATA_FLOW_EXPLANATION_BG.md](./DATA_FLOW_EXPLANATION_BG.md).
