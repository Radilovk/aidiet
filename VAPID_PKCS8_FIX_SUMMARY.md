# VAPID PKCS8 Error Fix Summary

## Date: February 16, 2026

## Problem
The push notification system was failing with the error:
```
Error sending push notification: DataError: Invalid PKCS8 input.
```

This error occurred when attempting to send push notifications to users who had subscribed to receive them.

## Root Cause

The issue was caused by a mismatch between the format of VAPID keys generated by the `web-push` library and the format expected by the Web Crypto API:

1. **Key Generation**: The `web-push generate-vapid-keys` command generates keys in **raw base64url format**:
   - Public key: 65 bytes (0x04 + 32 bytes x-coordinate + 32 bytes y-coordinate)
   - Private key: 32 bytes (the scalar `d` value)

2. **Code Implementation**: The original code attempted to import these keys using the `'pkcs8'` format:
   ```javascript
   const privateKeyUint8 = base64UrlToUint8Array(vapidPrivateKey);
   const cryptoKey = await crypto.subtle.importKey(
     'pkcs8',  // ‚ùå Wrong format for raw keys!
     privateKeyUint8,
     { name: 'ECDSA', namedCurve: 'P-256' },
     false,
     ['sign']
   );
   ```

3. **The Incompatibility**: According to the Web Crypto API specification:
   - EC private keys **cannot** be imported using `'raw'` format
   - EC private keys **must** be imported using either `'pkcs8'` or `'jwk'` format
   - The raw 32-byte private key from `web-push` is neither PKCS8 nor JWK format

## Solution

The fix converts the raw VAPID keys to JWK (JSON Web Key) format before importing them into the Web Crypto API.

### Implementation

1. **Added `vapidKeysToJWK()` Function**:
   ```javascript
   function vapidKeysToJWK(publicKeyBase64Url, privateKeyBase64Url) {
     // Decode the public key (65 bytes: 0x04 + 32 bytes x + 32 bytes y)
     const publicKeyBytes = base64UrlToUint8Array(publicKeyBase64Url);
     
     if (publicKeyBytes.length !== 65 || publicKeyBytes[0] !== 0x04) {
       throw new Error('Invalid VAPID public key format. Expected 65 bytes starting with 0x04.');
     }
     
     // Extract x and y coordinates (32 bytes each)
     const x = publicKeyBytes.slice(1, 33);
     const y = publicKeyBytes.slice(33, 65);
     
     // The private key is the scalar d (32 bytes)
     const d = base64UrlToUint8Array(privateKeyBase64Url);
     
     if (d.length !== 32) {
       throw new Error('Invalid VAPID private key format. Expected 32 bytes.');
     }
     
     // Create JWK object
     const jwk = {
       kty: 'EC',
       crv: 'P-256',
       x: uint8ArrayToBase64Url(x),
       y: uint8ArrayToBase64Url(y),
       d: uint8ArrayToBase64Url(d)
     };
     
     return jwk;
   }
   ```

2. **Updated `sendWebPushNotification()` Function**:
   ```javascript
   // Import VAPID private key for signing
   // Convert raw VAPID keys (from web-push generate-vapid-keys) to JWK format
   const privateKeyJwk = vapidKeysToJWK(vapidPublicKey, vapidPrivateKey);
   const cryptoKey = await crypto.subtle.importKey(
     'jwk',  // ‚úÖ Correct format!
     privateKeyJwk,
     { name: 'ECDSA', namedCurve: 'P-256' },
     false,
     ['sign']
   );
   ```

### JWK Structure

The conversion creates a proper JWK object with the following structure:
```json
{
  "kty": "EC",
  "crv": "P-256",
  "x": "<base64url x coordinate>",
  "y": "<base64url y coordinate>",
  "d": "<base64url private key>"
}
```

## Testing

The fix has been thoroughly tested:

1. **Syntax Validation**: Passed Node.js syntax check
2. **Key Format Validation**: Verified correct handling of 65-byte public keys and 32-byte private keys
3. **Web Crypto API Import**: Successfully imported real VAPID keys generated by `web-push`
4. **Signing Test**: Successfully signed test data using the imported key
5. **Code Review**: No issues found
6. **Security Scan**: No vulnerabilities detected

### Test Results
```
Testing Web Crypto API import with real VAPID keys...

‚úÖ JWK created successfully
‚úÖ Key imported successfully into Web Crypto API!
   Key type: private
   Algorithm: ECDSA
   Named curve: P-256
   Usages: sign

‚úÖ Signing test successful!
   Signature length: 64 bytes

üéâ All tests passed! The fix is working correctly.
```

## Benefits

1. **No Changes Required**: Users can continue using standard VAPID keys from `web-push generate-vapid-keys`
2. **Automatic Conversion**: The worker code handles the conversion transparently
3. **Standards Compliant**: Uses JWK format which is the standard for Web Crypto API
4. **Better Error Handling**: Validates key formats with clear error messages

## Documentation Updates

Updated the following documentation files:
- `PUSH_NOTIFICATIONS_SETUP.md` - Added troubleshooting section explaining the fix
- `PUSH_NOTIFICATIONS_GUIDE_BG.md` - Added Bulgarian explanation of the fix

## Impact

This fix resolves the critical push notification failure and allows:
- Chat message notifications to be sent automatically
- Water reminder notifications to be scheduled
- Meal reminder notifications to be delivered
- Custom admin notifications to reach users

## References

- [Web Crypto API - SubtleCrypto.importKey()](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey)
- [JSON Web Key (JWK) RFC 7517](https://tools.ietf.org/html/rfc7517)
- [VAPID Specification RFC 8292](https://tools.ietf.org/html/rfc8292)
- [Web Push Protocol RFC 8291](https://tools.ietf.org/html/rfc8291)

## Files Changed

1. `worker.js` - Added conversion function and updated key import
2. `PUSH_NOTIFICATIONS_SETUP.md` - Added troubleshooting documentation
3. `PUSH_NOTIFICATIONS_GUIDE_BG.md` - Added Bulgarian documentation

## Conclusion

The VAPID PKCS8 error has been successfully resolved by implementing proper key format conversion from raw base64url to JWK format. The fix is backwards compatible, requires no changes from users, and has been thoroughly tested and validated.
