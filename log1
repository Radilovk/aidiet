================================================================================
AI КОМУНИКАЦИОННИ ЛОГОВЕ - ПОСЛЕДЕН ПЛАН
(Съхранени в Cache API - автоматично изтриване след 24 часа)
================================================================================

Дата на експорт: 2026-02-19T23:21:21.614Z
Сесия: session_1771542914910_6f60edcd
Общо стъпки: 7

================================================================================
СТЪПКА 1: step1_analysis
ID на сесия: session_1771542914910_6f60edcd
================================================================================

--- ИЗПРАТЕНИ ДАННИ ---
Времева марка: 2026-02-19T23:15:15.025Z
Провайдър: google
Модел: gemini-2.0-flash
Дължина на промпт: 12303 символа
Приблизителни входни токени: 3491
Максимални изходни токени: 4000

--- КЛИЕНТСКИ ДАННИ ---
{
  "name": "kakadu",
  "gender": "Жена",
  "age": "35",
  "height": "165",
  "weight": "70",
  "email": "test@example.com",
  "goal": "Отслабване",
  "lossKg": "5",
  "sleepHours": "7–8",
  "sleepInterrupt": "Не",
  "chronotype": "Сутрешен",
  "dailyActivityLevel": "Средно",
  "stressLevel": "Средно",
  "sportActivity": "Средна (2–4 дни седмично)",
  "waterIntake": "1.5–2 л",
  "drinksSweet": "Рядко",
  "drinksAlcohol": "Рядко",
  "weightChange": "Не",
  "dietHistory": "Не",
  "overeatingFrequency": "Понякога",
  "foodCravings": [
    "Сладко"
  ],
  "foodTriggers": [
    "Стрес"
  ],
  "eatingHabits": [
    "Не закусвам"
  ],
  "compensationMethods": [
    "Не"
  ],
  "socialComparison": "Рядко",
  "dietPreference": [
    "Средиземноморска"
  ],
  "dietDislike": "Няма",
  "dietLove": "Плодове и зеленчуци",
  "medicalConditions": [
    "Нямам"
  ],
  "medications": "Не",
  "additionalNotes": "Тестов режим активиран"
}

--- ПРОМПТ ---
CRITICAL INSTRUCTION: You MUST respond with ONLY a valid JSON object. 
Do not include any explanatory text, markdown formatting, or anything outside the JSON structure.
Your response must start with { or [ and end with } or ].
NO text before the JSON. NO text after the JSON. ONLY JSON.

Ти си експертен клиничен диетолог, ендокринолог и психолог.

ТВОЯТА ЗАДАЧА: Направи професионален, комплексен анализ на здравословни, психо-емоционалния и метаболитен профил на клиента.

ФОКУС: Анализирай КОРЕЛАЦИИТЕ между всички фактори и определи оптималните калорийни и макронутриентни нужди базирани на цялостната клинична картина.

═══ КЛИЕНТСКИ ПРОФИЛ ═══
{userData: JSON object with fields - name, age, gender, height, weight, goal, lossKg, sleepHours, sleepInterrupt, chronotype, sportActivity, dailyActivityLevel, stressLevel, waterIntake, drinksSweet, drinksAlcohol, overeatingFrequency, eatingHabits, foodCravings, foodTriggers, compensationMethods, socialComparison, medicalConditions, medications, medicationsDetails, weightChange, weightChangeDetails, dietHistory, dietType, dietResult, dietPreference, dietDislike, dietLove, additionalNotes}

СКАЛИ (фиксирани входни стойности):
- stressLevel: 1–3
- dailyActivityLevel: 1–3 (вече се ползва в унифицирания активност скор)
- severity за т.8 и т.9: 1–3 (вътрешна оценка на модела по правила по-долу)

{Conditionally shown if additionalNotes exists:
⚠️ МАКСИМАЛЕН ПРИОРИТЕТ: Следната информация е предоставена директно от потребителя и ТРЯБВА да бъде взета предвид при ЦЕЛИЯ анализ, изчисления и препоръки.
Това може да променя критично анализа, стратегията и плана!

ДОПЪЛНИТЕЛНИ БЕЛЕЖКИ ОТ {name}:
{additionalNotes}

⚠️ ЗАДЪЛЖИТЕЛНО: Анализирай как тази информация влияе на:
1. Изчисленията на BMR/TDEE/Калории
2. Избора на диетична стратегия
3. Психологическия профил
4. Медицинските противопоказания
5. Храните и храненията в плана
═══════════════════════════════════════════════════════════════"}

═══ БАЗОВА ИНФОРМАЦИЯ ЗА ИЗЧИСЛЕНИЯ ═══
Основни физически параметри (за референция):
- Тегло: {weight} кг
- Височина: {height} см
- Възраст: {age} години
- Пол: {gender}
- Цел: {goal}
{Conditionally shown if lossKg exists: "- Желано отслабване: {lossKg} кг"}

═══ BACKEND РЕФЕРЕНТНИ ИЗЧИСЛЕНИЯ (Issues #2, #7, #9, #10, #28 - Feb 2026) ═══
{Backend auto-calculated values section - computed from calculateUnifiedActivityScore(), calculateBMR(), calculateTDEE(), calculateSafeDeficit(), calculateMacronutrientRatios()}

УНИФИЦИРАН АКТИВНОСТ СКОР (Issue #7):
- Дневна активност: {dailyActivityLevel} → {dailyScore}/3
- Спортна активност: {sportActivity} → ~{sportDays} дни
- КОМБИНИРАН СКОР: {combinedScore}/10 ({activityLevel})
- Формула: дневна активност (1-3) + спортни дни → скала 1-10

БАЗОВИ КАЛКУЛАЦИИ:
- BMR (Mifflin-St Jeor): {bmr} kcal
  * Мъж: 10×{weight} + 6.25×{height} - 5×{age} + 5
  * Жена: 10×{weight} + 6.25×{height} - 5×{age} - 161

- TDEE (Issue #10): {tdee} kcal
  * BMR × {activityFactor} (фактор за активност скор {combinedScore})
  * Нов множител базиран на 1-10 скала (не дублирани дефиниции)

- БЕЗОПАСЕН ДЕФИЦИТ (Issue #9): {targetCalories} kcal
  * Максимален дефицит: 25% ({maxDeficitCalories} kcal минимум)
  * Стандартен дефицит: {deficitPercent}%
  * AI може да коригира за специални стратегии (интермитентно гладуване и др.)

БАЗОВИ МАКРОНУТРИЕНТИ (Issue #2, #28 - НЕ циркулярна логика):
- Протеин: {protein}% ({proteinGramsPerKg}g/kg за {gender})
  * Протеинови нужди според пол: {gender}
  * Коригирано според активност скор {combinedScore}
- Въглехидрати: {carbs}%
- Мазнини: {fats}%
- СУМА: {protein + carbs + fats}% (валидирано = 100%)
- Формула: процентно разпределение базирано на активност и цел

БАЗОВА ХИПОТЕЗА ЗА ПСИХОПРОФИЛ И ТЕМПЕРАМЕНТ:
    - Анализирай данните за:
      * Хранителни желания: {foodCravings as JSON array}
      * Тригери: {foodTriggers as JSON array}
      * Копинг механизми: {compensationMethods as JSON array}
      * Социално сравнение: {socialComparison}
    - Определи вероятен темперамент с процент вероятност (само ако >80% вероятност)
    - Възможни типове: Холерик, Сангвиник, Флегматик, Меланхолик

РЕФЕРЕНТНИТЕ изчисления са само ОТПРАВНА ТОЧКА за валидация. В разширения анализ налагаш корекции и определяш финалните стойности според комплексния анализ като най-вече го съобразяваш с целта, физиологията и здравословното състояние.

═══ ТВОЯТА ЗАДАЧА - РАЗШИРЕН АНАЛИЗ ═══

Направи специализиран, комплексен АНАЛИЗ, включващ следните стъпки:

1. BMI АНАЛИЗ:
   - Изчисли BMI = тегло(kg) / (височина(m))²
   - Категоризирай: Поднормено (<18.5), Нормално (18.5-25), Наднормено (25-30), Затлъстяване (>30)
   - Анализирай в съответствие

2. БАЗОВ МЕТАБОЛИЗЪМ (BMR) И TDEE:
   - ВЗЕМИ референтните BMR и TDEE от секцията „BACKEND РЕФЕРЕНТНИ ИЗЧИСЛЕНИЯ“ като базови стойности.
   - НЕ преизчислявай формулата втори път.
   - Провери консистентност: дали BMR/TDEE съответстват на {weight}, {height}, {age}, {gender}, {combinedScore}.
   - Реалните корекции (±10–20%) се правят САМО в т.12 „КОРЕКЦИЯ НА РЕАЛЕН МЕТАБОЛИЗЪМ“.

3. СТАНДАРТ ЗА РАЗПРЕДЕЛЯНЕ НА МАКРОСИ:
   - ВЗЕМИ базовите проценти от „БАЗОВИ МАКРОНУТРИЕНТИ“ като отправна точка.
   - НЕ генерирай финални проценти тук.
   - Тук само:
     (а) провери логиката им спрямо целта, активността, здравето и поведението;
     (б) опиши какви корекции са вероятни и защо;
   - Финалните проценти и грамове се определят САМО в т.13.

4. НИВО НА АКТИВНОСТ (скала 1-10):
   - Вече изчислено: {combinedScore}/10 ({activityLevel})
   - Анализирай как това влияе на калорийни нужди

5. ФИЗИОЛОГИЧНА ФАЗА В ЖИВОТА:
   - Възраст: {age} години
   - Определи фаза: Млад възрастен (18-30), Зряла възраст (31-50), Средна възраст (51-65), Напреднала възраст (65+)
   - Влияние на метаболизъм и хормонален профил

6. ДНЕВЕН ВОДЕН ДЕФИЦИТ (Water Gap):
   - Формула: (Тегло × множител) + базова нужда (базиран на активност)
   - Нужда: ({weight} × множител) + базова = изчислена нужда литра
   - Текущ прием: {waterIntake}
   - Изчисли дефицит и влияние върху липолизата

8. ОТРИЦАТЕЛНИ ЗДРАВОСЛОВНИ ФАКТОРИ (тежест 1-3):
   (изброй всички вредни фактори, категорично пречещи на здравето.Оцени всеки по скала 1-3)

9. ПРЕЧЕЩИ ФАКТОРИ ЗА ПОСТИГАНЕ НА ЦЕЛТА (тежест 1-3):
   (изброй всички вредни фактори, категорично пречещи за постигане на {goal}.Оцени всеки по скала 1-3)
   - Оцени всеки по скала 1-3

10. общи отрицателни ФАКТОРИ:
    - Където има дублиране на фактори при 8. и 9. Събери оценките за тежест. по този начин, ако имаме стрес и на двете места 3та степен, сетресът става общ отрицателен фактор степен 6

11. ОПРЕДЕЛЯНЕ НА ПСИХОПРОФИЛ:
    - В обект "psychoProfile" попълваш темперамент САМО ако вероятността е >80%.
    - Ако вероятността е <80%, остави temperament празен (""), но запази probability.
    - В текстово поле "psychologicalProfile" направи детайлен анализ на психологическия профил (независимо дали има temperament).
    - Използвай психопрофила в следващите точки:
      * т.11a „РЕАКТИВНОСТ НА МЕТАБОЛИЗМА"
      * т.12 „КОРЕКЦИЯ НА РЕАЛЕН МЕТАБОЛИЗЪМ"
      * т.13 „ПРЕПОРЪЧИТЕЛНИ КАЛОРИИ И МАКРОСИ"
      * successChance (обвържи поведението/тригери със изпълнимост)
      * прогнозите т.16–17 (като модератор на придържане)


11a. РЕАКТИВНОСТ НА МЕТАБОЛИЗМА:
    - Анализирай спрямо:
      * Активност скор: {combinedScore}/10
      * Физиологична фаза: {age} год.
      * Психопрофил (от т.11)
      * История на диети: {dietHistory}, {dietType}, {dietResult}
      * Хронотип: {chronotype}
      * Стрес: {stressLevel}
    - Определи: Бавен/Среден/Бърз метаболизъм
    - Адаптивност към промени: Ниска/Средна/Висока

12. КОРЕКЦИЯ НА РЕАЛЕН МЕТАБОЛИЗЪМ:
    - Коригирай BMR/TDEE според:
      * Всички фактори и информация, които сметнеш за определящи
      * Точки 4, 5, 11, 11a
      * Качество на сън: {sleepHours}ч, {sleepInterrupt}
      * Хронотип: {chronotype}
      * Стрес: {stressLevel}
      * Здравен статус и медикаменти
    - Определи РЕАЛЕН метаболизъм (може да е различен от изчисления)

13. ИЗЧИСЛЯВАНЕ НА ПРЕПОРЪЧИТЕЛНИ КАЛОРИИ И МАКРОСИ:
    - Базирай на:
      * Всички фактори и информация, които сметнеш за определящи
      * Коригиран метаболизъм (т.12)
      * Реактивност (т.11a)
      * Активност, възраст, психопрофил
      * Хронотип и оптимални енергийни прозорци
      * Здравен статус и медикаменти
    - Определи ФИНАЛНИ препоръки

14. КРИТИЧНИ ПРОБЛЕМИ (3-6 бр.):
    - Започни от сумарния риск (т.10)
    - Включи най-тежките от т.9 и т.8
    - Представи ги по КРИТИЧЕН И ПЛАШЕЩ начин
    - САМО Borderline/Risky/Critical severity

15. ЗДРАВОСЛОВНО СЪСТОЯНИЕ В МОМЕНТА:
    - Базирано на целия анализ
    - Изведи с 20% ЗАНИЖЕНО (по-песимистична оценка за мотивация)
    - Скала: 0-100

16. ПРОГНОЗА - ПЕСИМИСТИЧНА (1 година):
    - Ако клиентът ПРОДЪЛЖИ по същия начин
    - Какви здравни рискове ще се развият
    - Къде ще бъде след 12 месеца (тегло, здраве, енергия)

17. ПРОГНОЗА - ОПТИМИСТИЧНА (1 година):
    - След подобряване на ВСИЧКИ проблемни параметри
    - Какви подобрения са възможни
    - Къде може да бъде след 12 месеца (тегло, здраве, енергия)

ВАЖНО (логика без дублиране + аргументация):
- В ключовите текстови полета (description/correction/metabolicProfile/psychologicalProfile/impactOnLipolysis/health) добавяй кратка, но плътна причинно-следствена аргументация (1–3 изречения), като изрично назоваваш кои входни ключове използваш (напр. stressLevel, sleepHours, drinksAlcohol, medicationsDetails).
- Не въвеждай нови JSON ключове. Аргументацията се вгражда в съществуващите текстови полета.

═══ ФОРМАТ НА ОТГОВОР ═══

{
  "bmi": число,
  "bmiCategory": "текст категория",
  "bmr": число,
  "tdee": число,
  "recommendedCalories": число,
  "macroRatios": {
    "protein": число процент,
    "carbs": число процент,
    "fats": число процент,
    "fiber": число грамове дневно
  },
  "macroGrams": {
    "protein": число грамове,
    "carbs": число грамове,
    "fats": число грамове
  },
  "activityLevel": "ниво 1-10 и описание",
  "physiologicalPhase": "фаза според възраст и влияние",
  "waterDeficit": {
    "dailyNeed": "литри дневно (формула)",
    "currentIntake": "текущ прием",
    "deficit": "дефицит в литри",
    "impactOnLipolysis": "влияние върху отслабването"
  },
  "negativeHealthFactors": [
    {
      "factor": "фактор",
      "severity": число 1-3,
      "description": "описание"
    }
  ],
  "hinderingFactors": [
    {
      "factor": "фактор",
      "severity": число 1-3,
      "description": "описание"
    }
  ],
  "cumulativeRiskScore": "сума на общи отрицателни фактори",
  "psychoProfile": {
    "temperament": "тип (само ако >80% вероятност)",
    "probability": число процент
  },
  "metabolicReactivity": {
    "speed": "Бавен/Среден/Бърз",
    "adaptability": "Ниска/Средна/Висока"
  },
  "correctedMetabolism": {
    "realBMR": число,
    "realTDEE": число,
    "correction": "описание на корекцията",
    "correctionPercent": "+/-X%"
  },
  "metabolicProfile": "анализ на профил спрямо цел и здраве ",
  "healthRisks": ["риск 1", "риск 2", "риск 3"],
  "nutritionalNeeds": ["нужда 1", "нужда 2", "нужда 3"],
  "psychologicalProfile": "детайлен анализ на психологическия профил",
  "successChance": число (-100 до 100),
  "currentHealthStatus": {
    "score": число 0-100 (ЗАНИЖЕНО с 10%),
    "description": "текущо състояние",
    "keyIssues": ["проблем 1", "проблем 2"]
  },
  "forecastPessimistic": {
    "timeframe": "12 месеца",
    "weight": "прогнозно тегло",
    "health": "прогнозно здраве",
    "risks": ["риск 1", "риск 2", "риск 3", "риск 4", "риск 5"]
  },
  "forecastOptimistic": {
    "timeframe": "12 месеца",
    "weight": "прогнозно тегло",
    "health": "прогнозно здраве",
    "improvements": ["подобрение 1", "подобрение 2", "подобрение 3", "подобрение 4", "подобрение 5"]
  },
  "keyProblems": [
    {
      "title": "заглавие (кратко)",
      "description": "КРИТИЧНО и ПЛАШЕЩО описание защо е проблем",
      "severity": "Borderline/Risky/Critical",
      "severityValue": число 0-100,
      "category": "Sleep/Nutrition/Hydration/Stress/Activity/Medical",
      "impact": "въздействие върху здравето и целта"
    }
  ]
}

Бъди КОНКРЕТЕН за {name}. Обяснявай ЗАЩО и КАК, не просто "добър" или "лош".
ВАЖНО: Направи анализ, който е индивидуализиран и базиран на ВСИЧКИ предоставени данни.

--- ПОЛУЧЕН ОТГОВОР ---
Времева марка: 2026-02-19T23:15:26.221Z
Успех: Да
Време за отговор: 11180 ms
Дължина на отговор: 5145 символа
Приблизителни изходни токени: 0

--- AI ОТГОВОР ---
```json
{
  "bmi": 27.8,
  "bmiCategory": "Наднормено",
  "bmr": 1400.0,
  "tdee": 1820.0,
  "recommendedCalories": 1547.0,
  "macroRatios": {
    "protein": 35.0,
    "carbs": 35.0,
    "fats": 30.0,
    "fiber": 30.0
  },
  "macroGrams": {
    "protein": 135.1,
    "carbs": 135.1,
    "fats": 51.6,
    "fiber": 30.0
  },
  "activityLevel": "4/10 (Лека активност)",
  "physiologicalPhase": "Зряла възраст (31-50)",
  "waterDeficit": {
    "dailyNeed": "2.5 литра дневно",
    "currentIntake": "1.5 литра",
    "deficit": "1.0 литра",
    "impactOnLipolysis": "Недостатъчната хидратация може да забави процеса на липолиза, тъй като водата е важна за метаболитните процеси и транспорта на мазнини."
  },
  "negativeHealthFactors": [
    {
      "factor": "Честа консумация на сладки напитки",
      "severity": 2,
      "description": "Високият прием на захар може да доведе до инсулинова резистентност и увеличаване на телесните мазнини."
    },
    {
      "factor": "Високо ниво на стрес",
      "severity": 3,
      "description": "Хроничният стрес може да повиши нивата на кортизол, което води до увеличаване на апетита и складиране на мазнини в областта на корема."
    }
  ],
  "hinderingFactors": [
    {
      "factor": "Често преяждане",
      "severity": 3,
      "description": "Преяждането може да саботира усилията за отслабване, тъй като води до излишък на калории и може да бъде свързано с емоционален дистрес."
    },
    {
      "factor": "Хранителни желания",
      "severity": 2,
      "description": "Силните хранителни желания могат да доведат до консумация на висококалорични и нездравословни храни, което затруднява придържането към диетата."
    }
  ],
  "cumulativeRiskScore": "5",
  "psychoProfile": {
    "temperament": "",
    "probability": 70.0
  },
  "metabolicReactivity": {
    "speed": "Среден",
    "adaptability": "Средна"
  },
  "correctedMetabolism": {
    "realBMR": 1350.0,
    "realTDEE": 1755.0,
    "correction": "Намаление на BMR и TDEE поради стрес и нередовен сън. Намаленият сън и високият стрес понижават метаболитните процеси. Това се отразява с 5% надолу от базовите изчисления.",
    "correctionPercent": "-5%"
  },
  "metabolicProfile": "Метаболитният профил показва умерена активност и нужда от лек дефицит за постигане на целта за отслабване. Важно е да се вземе предвид стресът, съня, и хранителните навици.",
  "healthRisks": ["Инсулинова резистентност", "Сърдечно-съдови заболявания", "Метаболитен синдром"],
  "nutritionalNeeds": ["Увеличен прием на фибри", "Достатъчен прием на протеин", "Намаляване на приема на захар"],
  "psychologicalProfile": "При наличие на нередовен сън и стрес, е възможно емоционално хранене. Преяждането е често срещано. Намаляването на хранителните желания ще намали преяждането.",
  "successChance": 40,
  "currentHealthStatus": {
    "score": 64,
    "description": "Текущото здравословно състояние е умерено добро, но има рискови фактори, които трябва да бъдат адресирани. Стресът и нездравословните хранителни навици влияят негативно.",
    "keyIssues": ["Стрес", "Нездравословно хранене"]
  },
  "forecastPessimistic": {
    "timeframe": "12 месеца",
    "weight": "85 кг",
    "health": "Влошено здравословно състояние, повишен риск от диабет тип 2 и сърдечно-съдови заболявания",
    "risks": ["Повишено кръвно налягане", "Висок холестерол", "Затлъстяване на черния дроб", "Диабет тип 2", "Сърдечно-съдови заболявания"]
  },
  "forecastOptimistic": {
    "timeframe": "12 месеца",
    "weight": "68 кг",
    "health": "Отлично здравословно състояние, подобрена енергия и настроение, намален риск от хронични заболявания",
    "improvements": ["Нормализиране на кръвното налягане", "Намаляване на холестерола", "Подобрена инсулинова чувствителност", "Повишена енергия", "Подобрено настроение"]
  },
  "keyProblems": [
    {
      "title": "Високо ниво на стрес",
      "description": "Хроничният стрес води до повишени нива на кортизол, което увеличава апетита за нездравословни храни и складирането на мазнини. Това може да доведе до сериозни здравословни проблеми.",
      "severity": "Risky",
      "severityValue": 75,
      "category": "Stress",
      "impact": "Повишен риск от сърдечно-съдови заболявания, диабет тип 2 и депресия."
    },
    {
      "title": "Често преяждане",
      "description": "Преяждането води до излишък на калории, което води до наддаване на тегло и увеличава риска от затлъстяване. Освен това, емоционалното преяждане може да бъде свързано с емоционален дистрес и да влоши психологическото състояние.",
      "severity": "Critical",
      "severityValue": 85,
      "category": "Nutrition",
      "impact": "Увеличен риск от затлъстяване, метаболитен синдром и емоционални проблеми."
    },
    {
      "title": "Недостатъчен прием на вода",
      "description": "Недостатъчната хидратация може да забави метаболизма и да намали ефективността на процеса на отслабване. Освен това, дехидратацията може да доведе до умора и главоболие.",
      "severity": "Borderline",
      "severityValue": 60,
      "category": "Hydration",
      "impact": "Намалена ефективност на метаболизма, умора и главоболие."
    }
  ]
}
```
