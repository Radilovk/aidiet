# üöÄ –ë—ä—Ä–∑–∞ –†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è: Backend –ò–∑—á–∏—Å–ª–µ–Ω–∏—è

## –ö–∞–∫–≤–æ —Å–µ –ò–∑—á–∏—Å–ª—è–≤–∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ?

–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–ª–∞–Ω, backend **–ê–í–¢–û–ú–ê–¢–ò–ß–ù–û** –∏–∑—á–∏—Å–ª—è–≤–∞ 5 –±–∞–∑–æ–≤–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è:

| # | –ü–æ–∫–∞–∑–∞—Ç–µ–ª | –§–æ—Ä–º—É–ª–∞ | Issue |
|---|-----------|---------|-------|
| 1 | **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç –°–∫–æ—Ä** | –¥–Ω–µ–≤–Ω–∞ (1-3) + —Å–ø–æ—Ä—Ç –¥–Ω–∏ (0-7) ‚Üí 1-10 | #7 |
| 2 | **BMR** | Mifflin-St Jeor (–∑–∞–≤–∏—Å–∏ –æ—Ç –ø–æ–ª) | - |
| 3 | **TDEE** | BMR √ó –º–Ω–æ–∂–∏—Ç–µ–ª (1.2-1.95) | #10 |
| 4 | **–ë–µ–∑–æ–ø–∞—Å–µ–Ω –î–µ—Ñ–∏—Ü–∏—Ç** | TDEE √ó 0.82 (18% –¥–µ—Ñ–∏—Ü–∏—Ç, –º–∞–∫—Å 25%) | #9 |
| 5 | **–ú–∞–∫—Ä–æ –°—ä–æ—Ç–Ω–æ—à–µ–Ω–∏—è** | –ü—Ä–æ—Ç–µ–∏–Ω (–ø–æ–ª+–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç), Carbs, Fats ‚Üí 100% | #2, #28 |

---

## –ö—ä–¥–µ —Å–µ –ò–∑—á–∏—Å–ª—è–≤–∞?

**–§–∞–π–ª:** `worker.js`

**–§—É–Ω–∫—Ü–∏–∏:**
```javascript
calculateUnifiedActivityScore(data)  // –†–µ–¥ 284-320
calculateBMR(data)                   // –†–µ–¥ 244-268
calculateTDEE(bmr, score)            // –†–µ–¥ 330-363
calculateSafeDeficit(tdee, goal)     // –†–µ–¥ 464-486
calculateMacronutrientRatios(...)    // –†–µ–¥ 393-456
```

**–ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –≤:**
```javascript
generateAnalysisPrompt(data, env)    // –†–µ–¥ 4061-4518
  ‚îî‚îÄ Backend –∏–∑—á–∏—Å–ª–µ–Ω–∏—è             // –†–µ–¥ 4264-4310
```

---

## –ö–æ–≥–∞ —Å–µ –ò–∑—á–∏—Å–ª—è–≤–∞?

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–µ–¥–∏ –°—Ç—ä–ø–∫–∞ 1 (Analysis)**

```
handleGeneratePlan() 
  ‚îî‚îÄ generatePlanMultiStep()
       ‚îî‚îÄ generateAnalysisPrompt()     ‚Üê –¢–£–ö —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞
            ‚îú‚îÄ calculateUnifiedActivityScore()
            ‚îú‚îÄ calculateBMR()
            ‚îú‚îÄ calculateTDEE()
            ‚îú‚îÄ calculateSafeDeficit()
            ‚îî‚îÄ calculateMacronutrientRatios()
```

---

## –ö–∞–∫–≤–æ –ü–æ–ª—É—á–∞–≤–∞ AI?

AI –ø–æ–ª—É—á–∞–≤–∞ **–†–ï–§–ï–†–ï–ù–¢–ù–ò –ò–ó–ß–ò–°–õ–ï–ù–ò–Ø** –≤ —Ç–µ–∫—Å—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç:

```
‚ïê‚ïê‚ïê BACKEND –†–ï–§–ï–†–ï–ù–¢–ù–ò –ò–ó–ß–ò–°–õ–ï–ù–ò–Ø ‚ïê‚ïê‚ïê

–£–ù–ò–§–ò–¶–ò–†–ê–ù –ê–ö–¢–ò–í–ù–û–°–¢ –°–ö–û–†:
- –î–Ω–µ–≤–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç: –°—Ä–µ–¥–Ω–æ ‚Üí 2/3
- –°–ø–æ—Ä—Ç–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç: –°—Ä–µ–¥–Ω–∞ (2‚Äì4 –¥–Ω–∏) ‚Üí ~3 –¥–Ω–∏
- –ö–û–ú–ë–ò–ù–ò–†–ê–ù –°–ö–û–†: 5/10 (–°—Ä–µ–¥–Ω–∞)

–ë–ê–ó–û–í–ò –ö–ê–õ–ö–£–õ–ê–¶–ò–ò:
- BMR: 1805 kcal
- TDEE: 2753 kcal  
- –ë–ï–ó–û–ü–ê–°–ï–ù –î–ï–§–ò–¶–ò–¢: 2257 kcal (18%, –º–∞–∫—Å 25%)

–ë–ê–ó–û–í–ò –ú–ê–ö–†–û–ù–£–¢–†–ò–ï–ù–¢–ò:
- –ü—Ä–æ—Ç–µ–∏–Ω: 22% (1.8g/kg)
- –í—ä–≥–ª–µ—Ö–∏–¥—Ä–∞—Ç–∏: 39%
- –ú–∞–∑–Ω–∏–Ω–∏: 39%
- –°–£–ú–ê: 100%
```

AI –∏–∑–ø–æ–ª–∑–≤–∞ —Ç–µ–∑–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –∑–∞ **–≤–∞–ª–∏–¥–∞—Ü–∏—è** –∏ **–∫–æ—Ä–µ–∫—Ü–∏—è** —Å–ø–æ—Ä–µ–¥ —Ö–æ–ª–∏—Å—Ç–∏—á–µ–Ω –∞–Ω–∞–ª–∏–∑.

---

## –§–æ—Ä–º—É–ª–∏

### 1. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç –°–∫–æ—Ä (1-10)

```
–¥–Ω–µ–≤–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç:
  –ù–∏—Å–∫–æ  = 1
  –°—Ä–µ–¥–Ω–æ = 2
  –í–∏—Å–æ–∫–æ = 3

—Å–ø–æ—Ä—Ç –¥–Ω–∏:
  0 –¥–Ω–∏      = 0
  1-2 –¥–Ω–∏    = 1.5
  2-4 –¥–Ω–∏    = 3
  5-7 –¥–Ω–∏    = 6

–∫–æ–º–±–∏–Ω–∏—Ä–∞–Ω —Å–∫–æ—Ä = min(10, max(1, –¥–Ω–µ–≤–Ω–∞ + —Å–ø–æ—Ä—Ç))
```

### 2. BMR (Mifflin-St Jeor)

**–ú—ä–∂:**
```
BMR = 10 √ó kg + 6.25 √ó cm - 5 √ó –≥–æ–¥–∏–Ω–∏ + 5
```

**–ñ–µ–Ω–∞:**
```
BMR = 10 √ó kg + 6.25 √ó cm - 5 √ó –≥–æ–¥–∏–Ω–∏ - 161
```

### 3. TDEE

```
TDEE = BMR √ó –º–Ω–æ–∂–∏—Ç–µ–ª

–ú–Ω–æ–∂–∏—Ç–µ–ª–∏ (1-10 —Å–∫–∞–ª–∞):
1:  1.20  (Sedentary)
2:  1.30
3:  1.375 (Light)
4:  1.45
5:  1.525 (Moderate)
6:  1.60
7:  1.675
8:  1.75  (Very active)
9:  1.85
10: 1.95  (Extremely active)
```

### 4. –ë–µ–∑–æ–ø–∞—Å–µ–Ω –î–µ—Ñ–∏—Ü–∏—Ç

```
–ê–∫–æ –ù–ï –µ –æ—Ç—Å–ª–∞–±–≤–∞–Ω–µ:
  targetCalories = TDEE
  deficitPercent = 0%

–ê–∫–æ –µ –æ—Ç—Å–ª–∞–±–≤–∞–Ω–µ:
  targetCalories = TDEE √ó 0.82  (18% –¥–µ—Ñ–∏—Ü–∏—Ç)
  maxDeficitCalories = TDEE √ó 0.75  (25% –º–∞–∫—Å)
```

### 5. –ú–∞–∫—Ä–æ –°—ä–æ—Ç–Ω–æ—à–µ–Ω–∏—è

**–ü—Ä–æ—Ç–µ–∏–Ω (g/kg):**
```
–ú—ä–∂:
  activityScore >= 7: 2.0 g/kg
  activityScore >= 5: 1.6 g/kg
  –∏–Ω–∞—á–µ:              1.2 g/kg

–ñ–µ–Ω–∞:
  activityScore >= 7: 1.8 g/kg
  activityScore >= 5: 1.4 g/kg
  –∏–Ω–∞—á–µ:              1.0 g/kg

–ö–æ—Ä–µ–∫—Ü–∏—è:
  –ú—É—Å–∫—É–ª–Ω–∞ –º–∞—Å–∞: √ó 1.2
  –û—Ç—Å–ª–∞–±–≤–∞–Ω–µ:    √ó 1.1
```

**–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
```
proteinPercent = (–ø—Ä–æ—Ç–µ–∏–Ω_g √ó 4) / TDEE √ó 100
remainingPercent = 100 - proteinPercent

–ê–∫–æ activityScore >= 7:
  carbs = remainingPercent √ó 0.6
  fats  = remainingPercent √ó 0.4

–ê–∫–æ activityScore >= 4:
  carbs = remainingPercent √ó 0.5
  fats  = remainingPercent √ó 0.5

–ê–∫–æ activityScore < 4:
  carbs = remainingPercent √ó 0.4
  fats  = remainingPercent √ó 0.6

// –ö–æ—Ä–∏–≥–∏—Ä–∞ fats –∑–∞ —Ç–æ—á–Ω–æ 100%
```

---

## –ü—Ä–∏–º–µ—Ä–Ω–æ –ò–∑—á–∏—Å–ª–µ–Ω–∏–µ

**–í—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏:**
```
–ú—ä–∂, 35 –≥–æ–¥., 85 kg, 180 cm
–¶–µ–ª: –û—Ç—Å–ª–∞–±–≤–∞–Ω–µ
–î–Ω–µ–≤–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç: –°—Ä–µ–¥–Ω–æ
–°–ø–æ—Ä—Ç: –°—Ä–µ–¥–Ω–∞ (2-4 –¥–Ω–∏)
```

**–ò–∑—á–∏—Å–ª–µ–Ω–∏—è:**

**1. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç:**
```
–¥–Ω–µ–≤–Ω–∞: –°—Ä–µ–¥–Ω–æ = 2
—Å–ø–æ—Ä—Ç: –°—Ä–µ–¥–Ω–∞ = 3 –¥–Ω–∏
–∫–æ–º–±–∏–Ω–∏—Ä–∞–Ω = 2 + 3 = 5 ‚Üí –°—Ä–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç
```

**2. BMR:**
```
BMR = 10√ó85 + 6.25√ó180 - 5√ó35 + 5
    = 850 + 1125 - 175 + 5
    = 1805 kcal
```

**3. TDEE:**
```
TDEE = 1805 √ó 1.525 (–º–Ω–æ–∂–∏—Ç–µ–ª –∑–∞ —Å–∫–æ—Ä 5)
     = 2753 kcal
```

**4. –î–µ—Ñ–∏—Ü–∏—Ç:**
```
–°—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω: 2753 √ó 0.82 = 2257 kcal (18%)
–ú–∞–∫—Å–∏–º–∞–ª–µ–Ω: 2753 √ó 0.75 = 2065 kcal (25%)
```

**5. –ú–∞–∫—Ä–æ—Å–∏:**
```
–ü—Ä–æ—Ç–µ–∏–Ω base: 1.6 g/kg (activityScore 5, –ú—ä–∂)
–ö–æ—Ä–µ–∫—Ü–∏—è: 1.6 √ó 1.1 = 1.76 ‚Üí 1.8 g/kg (–æ—Ç—Å–ª–∞–±–≤–∞–Ω–µ)
–ü—Ä–æ—Ç–µ–∏–Ω g: 85 √ó 1.8 = 153 g
–ü—Ä–æ—Ç–µ–∏–Ω cal: 153 √ó 4 = 612 kcal
–ü—Ä–æ—Ç–µ–∏–Ω %: 612 / 2753 √ó 100 = 22%

–û—Å—Ç–∞–Ω–∞–ª–∏: 100 - 22 = 78%
Carbs: 78 √ó 0.5 = 39% (—Å—Ä–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç)
Fats: 78 √ó 0.5 = 39%

–ü—Ä–æ–≤–µ—Ä–∫–∞: 22 + 39 + 39 = 100% ‚úì
```

**–†–µ–∑—É–ª—Ç–∞—Ç:**
```
–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç: 5/10 (–°—Ä–µ–¥–Ω–∞)
BMR: 1805 kcal
TDEE: 2753 kcal
–¶–µ–ª–µ–≤–∏ –∫–∞–ª–æ—Ä–∏–∏: 2257 kcal
–ú–∞–∫—Ä–æ—Å–∏: 22% –ø—Ä–æ—Ç–µ–∏–Ω (1.8 g/kg), 39% carbs, 39% fats
```

---

## AI –ö–æ—Ä–µ–∫—Ü–∏–∏

AI –º–æ–∂–µ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞ —Ç–µ–∑–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ —Å–ø–æ—Ä–µ–¥:

‚úì –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏ —Å—ä—Å—Ç–æ—è–Ω–∏—è  
‚úì –ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∏  
‚úì –ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—ä–Ω—è  
‚úì –°—Ç—Ä–µ—Å –Ω–∏–≤–∞  
‚úì –•—Ä–æ–Ω–æ—Ç–∏–ø  
‚úì –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –¥–∏–µ—Ç–∏  
‚úì –ú–µ—Ç–∞–±–æ–ª–∏—Ç–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç  
‚úì –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ñ–∏–ª  

**–ü—Ä–∏–º–µ—Ä:**
```
Backend –∏–∑—á–∏—Å–ª–∏: TDEE = 2753 kcal

AI –∞–Ω–∞–ª–∏–∑–∏—Ä–∞:
- –õ–æ—à —Å—ä–Ω (5 —á–∞—Å–∞) ‚Üí -10%
- –í–∏—Å–æ–∫ —Å—Ç—Ä–µ—Å ‚Üí -5%
- –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –π–æ-–π–æ –¥–∏–µ—Ç–∏ ‚Üí -10%

AI –∫–æ—Ä–∏–≥–∏—Ä–∞: realTDEE = 2200 kcal (-20%)
```

---

## –í–∞–ª–∏–¥–∞—Ü–∏—è

**Backend –≤–∞–ª–∏–¥–∏—Ä–∞:**
- ‚úì BMR: –∏–∑–∏—Å–∫–≤–∞ —Ç–µ–≥–ª–æ, –≤–∏—Å–æ—á–∏–Ω–∞, –≤—ä–∑—Ä–∞—Å—Ç, –ø–æ–ª
- ‚úì Activity Score: 1-10 –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
- ‚úì TDEE: default –º–Ω–æ–∂–∏—Ç–µ–ª –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω —Å–∫–æ—Ä
- ‚úì Deficit: –º–∞–∫—Å–∏–º—É–º 25%
- ‚úì Macros: **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —Ç–æ—á–Ω–æ 100%**

**AI –≤–∞–ª–∏–¥–∏—Ä–∞:**
- ‚úì –ê–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç –Ω–∞ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞
- ‚úì –°—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Ü–µ–ª
- ‚úì –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç
- ‚úì –•–æ–ª–∏—Å—Ç–∏—á–Ω–∞ –∫–æ—Ä–µ–∫—Ü–∏—è

---

## –ß–µ—Å—Ç–æ –ó–∞–¥–∞–≤–∞–Ω–∏ –í—ä–ø—Ä–æ—Å–∏

### –ó–∞—â–æ 25% –º–∞–∫—Å–∏–º–∞–ª–µ–Ω –¥–µ—Ñ–∏—Ü–∏—Ç, –∞ –Ω–µ 30%?

**–û—Ç–≥–æ–≤–æ—Ä:** 25% –µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω –º–∞–∫—Å–∏–º—É–º. 30% –º–æ–∂–µ –¥–∞ –¥–æ–≤–µ–¥–µ –¥–æ:
- –ó–∞–≥—É–±–∞ –Ω–∞ –º—É—Å–∫—É–ª–Ω–∞ –º–∞—Å–∞
- –ó–∞–±–∞–≤—è–Ω–µ –Ω–∞ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞
- –•–æ—Ä–º–æ–Ω–∞–ª–µ–Ω –¥–∏—Å–±–∞–ª–∞–Ω—Å

AI –º–æ–∂–µ –¥–∞ –ø—Ä–∏–ª–æ–∂–∏ >25% –≤ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ —Å–ª—É—á–∞–∏ (–Ω–∞–ø—Ä. –∏–Ω—Ç–µ—Ä–º–∏—Ç–µ–Ω—Ç–Ω–æ –≥–ª–∞–¥—É–≤–∞–Ω–µ), –Ω–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–æ.

### Backend –∏–ª–∏ AI –∏–∑—á–∏—Å–ª—è–≤–∞ —Ñ–∏–Ω–∞–ª–Ω–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏?

**–û—Ç–≥–æ–≤–æ—Ä:** 
- **Backend** –∏–∑—á–∏—Å–ª—è–≤–∞ **—Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏** (–ø—Ä–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏)
- **AI** –ø—Ä–∞–≤–∏ **—Ö–æ–ª–∏—Å—Ç–∏—á–Ω–∞ –∫–æ—Ä–µ–∫—Ü–∏—è** (–≤—Å–∏—á–∫–∏ —Ñ–∞–∫—Ç–æ—Ä–∏)
- **AI –æ–ø—Ä–µ–¥–µ–ª—è —Ñ–∏–Ω–∞–ª–Ω–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏**

### –ó–∞—â–æ –Ω–µ –µ —Ü–∏—Ä–∫—É–ª—è—Ä–Ω–∞ –ª–æ–≥–∏–∫–∞?

**–û—Ç–≥–æ–≤–æ—Ä:**
- Backend –ù–ï –∏–∑–ø–æ–ª–∑–≤–∞ AI —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
- Backend –∏–∑–ø–æ–ª–∑–≤–∞ –°–ê–ú–û –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ (—Ç–µ–≥–ª–æ, –≤—ä–∑—Ä–∞—Å—Ç, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç)
- AI –ø–æ–ª—É—á–∞–≤–∞ Backend —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –∫–∞—Ç–æ **—Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è**, –Ω–µ –∫–∞—Ç–æ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏
- AI –∫–æ—Ä–∏–≥–∏—Ä–∞ —Å–ø–æ—Ä–µ–¥ **–Ω–µ–∑–∞–≤–∏—Å–∏–º –∞–Ω–∞–ª–∏–∑**

### –ö—ä–¥–µ –º–æ–≥–∞ –¥–∞ –≤–∏–¥—è –∫–æ–¥–∞?

**–û—Ç–≥–æ–≤–æ—Ä:**
- –§–∞–π–ª: `worker.js`
- –§—É–Ω–∫—Ü–∏–∏: —Ä–µ–¥–æ–≤–µ 244-486
- –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ: —Ä–µ–¥–æ–≤–µ 4264-4310
- –ü—ä–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `BACKEND_CALCULATIONS_DOCUMENTATION_BG.md`

---

**–ó–∞ –¥–µ—Ç–∞–π–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –≤–∏–∂—Ç–µ:** [BACKEND_CALCULATIONS_DOCUMENTATION_BG.md](./BACKEND_CALCULATIONS_DOCUMENTATION_BG.md)

**–î–∞—Ç–∞:** 2026-02-18  
**–í–µ—Ä—Å–∏—è:** 1.0
