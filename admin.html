<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NutriPlan">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <title>Админ Панел - NutriPlan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #10b981;
            --primary-dark: #059669;
            --soft-red: #d1fae5;
            --accent-yellow: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-light-red: #f87171;
            --bg-color: #fefce8;
            --text-dark: #1e3a20;
            --text-gray: #4b5563;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(16,185,129,0.15);
            --radius: 16px;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --primary-red: #34d399;
            --primary-dark: #10b981;
            --soft-red: #064e3b;
            --accent-yellow: #fcd34d;
            --accent-blue: #60a5fa;
            --accent-light-red: #fca5a5;
            --bg-color: #0f1419;
            --text-dark: #e5f3e8;
            --text-gray: #9ca3af;
            --white: #1a2028;
            --shadow: 0 10px 30px rgba(52,211,153,0.3);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
        }

        .logout-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 20px;

        .theme-toggle {
            background: var(--bg-color);
            border: 2px solid var(--text-gray);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        .theme-toggle:hover {
            border-color: var(--primary-red);
            transform: scale(1.05);
        }
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .logout-btn:hover {
            background: var(--primary-dark);
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--soft-red);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.3s;
            font-family: inherit;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #e8f8f5;
            border-left: 4px solid #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 30px;
            color: var(--primary-red);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-red);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .card {
                padding: 20px;
            }
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            max-width: 90%;
            animation: slideUpBanner 0.3s ease;
        }

        .install-banner.show {
            display: flex;
        }

        @keyframes slideUpBanner {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-banner-icon {
            font-size: 2rem;
            color: var(--primary-red);
        }

        .install-banner-content {
            flex: 1;
        }

        .install-banner-title {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.95rem;
        }

        .install-banner-text {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .install-banner-actions {
            display: flex;
            gap: 10px;
        }

        .install-banner-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .install-banner-btn:hover {
            background: var(--primary-dark);
        }

        .install-banner-btn.dismiss {
            background: transparent;
            color: var(--text-gray);
        }

        .install-banner-btn.dismiss:hover {
            background: var(--soft-red);
            color: var(--text-dark);
        }

        @media (max-width: 768px) {
            .install-banner {
                flex-direction: column;
                text-align: center;
                padding: 15px;
                bottom: 10px;
            }

            .install-banner-actions {
                width: 100%;
            }

            .install-banner-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-icon">
            <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="install-banner-content">
            <div class="install-banner-title">Инсталирай NutriPlan</div>
            <div class="install-banner-text">Добави приложението към началния екран</div>
        </div>
        <div class="install-banner-actions">
            <button class="install-banner-btn" id="installBtn">
                <i class="fas fa-download"></i> Инсталирай
            </button>
            <button class="install-banner-btn dismiss" id="dismissInstallBtn">
                <i class="fas fa-times"></i> По-късно
            </button>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1><i class="fas fa-shield-alt"></i> Админ Вход</h1>
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Парола" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Вход
            </button>
            <div id="loginError" class="error-message" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" style="display: none;">
        <div class="container">
            <header>
                <h1><i class="fas fa-cog"></i> Админ Панел</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Смени тема">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Изход
                    </button>
                </div>
            </header>

            <!-- Stats Section -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>Общо Потребители</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalPlans">-</h3>
                    <p>Генерирани Планове</p>
                </div>
                <div class="stat-card">
                    <h3 id="currentModel">-</h3>
                    <p>Активен AI Модел</p>
                </div>
            </div>

            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>

            <!-- AI Model Selection -->
            <div class="card">
                <h2><i class="fas fa-robot"></i> AI Модел</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Изберете AI провайдър и конкретен модел за генериране на планове и чат.
                </div>
                <div class="form-group">
                    <label for="aiProvider">Избери AI Провайдър:</label>
                    <select id="aiProvider">
                        <option value="openai">OpenAI</option>
                        <option value="google">Google</option>
                        <option value="mock">Mock (За тестване без API)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="aiModelName">Име на модел:</label>
                    <input type="text" id="aiModelName" placeholder="напр. gpt-4o, gemini-2.0-flash-exp">
                    <small style="display: block; margin-top: 5px; color: var(--text-gray);">
                        OpenAI примери: gpt-4o, gpt-4o-mini, gpt-4-turbo<br>
                        Google примери: gemini-pro, gemini-2.0-flash-exp, gemini-1.5-pro
                    </small>
                </div>
                <button class="btn" onclick="saveAIModel()">
                    <i class="fas fa-save"></i> Запази Модел
                </button>
            </div>

            <!-- Color Scheme Configuration -->
            <div class="card">
                <h2><i class="fas fa-palette"></i> Цветова Схема</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Изберете цветова схема за потребителския интерфейс. Промените ще се приложат автоматично за всички потребители.
                </div>
                <div class="form-group">
                    <label for="colorScheme">Избери Цветова Палитра:</label>
                    <select id="colorScheme" onchange="previewColorScheme()">
                        <option value="purple-pink">Зелено-Жълта (Модерна Premium)</option>
                        <option value="green-blue">Зелено-Синя (Здравословна)</option>
                        <option value="blue-indigo">Синьо-Индиго (Професионална)</option>
                        <option value="orange-red">Оранжево-Червена (Енергична)</option>
                        <option value="custom">Персонализирана (Избери свои цветове)</option>
                    </select>
                </div>
                
                <!-- Custom Color Picker Section -->
                <div id="customColorSection" style="display: none; margin: 20px 0; padding: 20px; background: var(--bg-color); border-radius: 12px; border: 2px solid var(--primary-red);">
                    <h3 style="margin-bottom: 15px; color: var(--text-dark);"><i class="fas fa-paint-brush"></i> Избери 3 Основни Цвята</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="customPrimary">Основен Цвят (Primary):</label>
                            <input type="color" id="customPrimary" value="#10b981" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За бутони и акценти</small>
                        </div>
                        <div class="form-group">
                            <label for="customSecondary">Вторичен Цвят (Secondary):</label>
                            <input type="color" id="customSecondary" value="#3b82f6" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За подчертаване</small>
                        </div>
                        <div class="form-group">
                            <label for="customAccent">Акцентиращ Цвят (Accent):</label>
                            <input type="color" id="customAccent" value="#ff7f6a" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За специални елементи</small>
                        </div>
                    </div>
                </div>
                <div id="colorPreview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: #10b981;">
                        Зелено
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: #3b82f6;">
                        Синьо
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: #ff7f6a;">
                        Корал
                    </div>
                </div>
                <button class="btn" onclick="saveColorScheme()">
                    <i class="fas fa-save"></i> Запази Цветова Схема
                </button>
            </div>

            <!-- AI Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-pen-fancy"></i> AI Промпт за Генериране на План</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Променете промпта само ако знаете какво правите. Грешен промпт може да доведе до некоректни планове.
                </div>
                <div class="form-group">
                    <label for="aiPrompt">Промпт Шаблон:</label>
                    <textarea id="aiPrompt" placeholder="Въведете промпт шаблон..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> Използвайте {name}, {age}, {weight}, {height}, {goal} и други полета от въпросника.
                </div>
                <button class="btn" onclick="saveAIPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт
                </button>
                <button class="btn" onclick="resetPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Chat Prompt Editor - Consultation Mode -->
            <div class="card">
                <h2><i class="fas fa-comments"></i> AI Промпт за Чат Асистент - Режим Консултация</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Този промпт се използва когато потребителят е в режим на консултация (само четене на плана).
                </div>
                <div class="form-group">
                    <label for="consultationPrompt">Промпт за Консултационен Режим:</label>
                    <textarea id="consultationPrompt" placeholder="Въведете промпт за консултационен режим..."></textarea>
                </div>
                <button class="btn" onclick="saveConsultationPrompt()">
                    <i class="fas fa-save"></i> Запази Консултационен Промпт
                </button>
            </div>

            <!-- Chat Prompt Editor - Modification Mode -->
            <div class="card">
                <h2><i class="fas fa-edit"></i> AI Промпт за Чат Асистент - Режим Промяна на План</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Този промпт се използва когато потребителят иска да промени хранителния си план.
                </div>
                <div class="form-group">
                    <label for="modificationPrompt">Промпт за Режим Промяна:</label>
                    <textarea id="modificationPrompt" placeholder="Въведете промпт за режим промяна на план..."></textarea>
                </div>
                <button class="btn" onclick="saveModificationPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Промяна
                </button>
            </div>

            <!-- System Actions -->
            <div class="card">
                <h2><i class="fas fa-tools"></i> Системни Действия</h2>
                <button class="btn" onclick="clearCache()" style="background: #e67e22;">
                    <i class="fas fa-trash"></i> Изчисти Кеш
                </button>
                <button class="btn" onclick="viewLogs()" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-file-alt"></i> Преглед на Логове
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Management ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Initialize theme on load
        initializeTheme();

        // WARNING: This is a basic client-side authentication for demonstration purposes.
        // For production use, implement proper server-side authentication with the worker.
        // This password is visible in the browser source code and should not be used for security.
        const ADMIN_PASSWORD = 'nutriplan2024'; // TODO: Move to server-side auth
        const WORKER_URL = 'https://aidiet.radilov-k.workers.dev';

        // Default prompts
        const DEFAULT_PLAN_PROMPT = `Ти си професионален диетолог и здравен консултант. Създай подробен 7-дневен хранителен план за клиент със следните характеристики:

ОСНОВНИ ДАННИ:
- Име: {name}
- Пол: {gender}
- Възраст: {age} години
- Ръст: {height} см
- Тегло: {weight} кг
- Цел: {goal}

ЗДРАВОСЛОВЕН ПРОФИЛ:
- Сън: {sleepHours} часа
- Хронотип: {chronotype}
- Активност през деня: {dailyActivityLevel}
- Стрес: {stressLevel}
- Спортна активност: {sportActivity}

ХРАНИТЕЛНИ НАВИЦИ:
- Вода: {waterIntake}
- Прекомерно хранене: {overeatingFrequency}

ПРЕДПОЧИТАНИЯ:
- Диетични предпочитания: {dietPreference}
- Не обича/непоносимост: {dietDislike}
- Любими храни: {dietLove}

МЕДИЦИНСКИ СЪСТОЯНИЯ:
- Състояния: {medicalConditions}
- Лекарства: {medications}

Моля, върни отговора в JSON формат с weekPlan, recommendations, forbidden, psychology, waterIntake, supplements.
Включи 3-5 хранения на ден за всеки от 7-те дни.`;

        const DEFAULT_CHAT_PROMPT = `Ти си личен диетолог, психолог и здравен асистент за {name}.
Отговори на въпроса като професионален консултант. Бъди топъл, подкрепящ и мотивиращ.`;

        const DEFAULT_CONSULTATION_PROMPT = `ТЕКУЩ РЕЖИМ: КОНСУЛТАЦИЯ

ВАЖНИ ПРАВИЛА:
1. Можеш да четеш плана, но НЕ МОЖЕШ да го променяш.
2. Бъди КРАТЪК - максимум 2-3 изречения, прост език.
3. Ако клиентът иска промяна, кажи: "За промяна активирай режима за промяна на плана."
4. НИКОГА не използвай [REGENERATE_PLAN:...] инструкции.
5. Винаги поддържай мотивиращ тон.

ПРИМЕРИ:
- "Закуската съдържа овесени ядки с банан (350 калории). За промяна, активирай режима за промяна."
- "Можеш да замениш рибата с пилешко - и двете са отлични източници на протеин. За промяна, активирай режима за промяна."`;

        const DEFAULT_MODIFICATION_PROMPT = `ТЕКУЩ РЕЖИМ: ПРОМЯНА НА ПЛАНА

ВАЖНИ ПРАВИЛА:
1. Ти си професионален диетолог. Бъди КРАТЪК, ЯСЕН и директен.
2. Използвай ПРОСТ език, лесно разбираем.
3. Ограничи се до МАКСИМУМ 3-4 изречения в отговор.
4. Задавай МАКСИМУМ 1 въпрос на отговор.

2. Когато клиентът иска промяна:
   - Анализирай дали е здравословно за цел: {goal}
   - Обясни КРАТКО последиците (само основното)
   - Ако има по-добра алтернатива, предложи я с 1 изречение
   - Запитай с 1 въпрос за потвърждение
   - След потвърждение, приложи с [REGENERATE_PLAN:{"modifications":["описание"]}]

3. НИКОГА не прилагай директно промяна без обсъждане! Винаги обясни и консултирай първо.

4. ПРИМЕР:
   Клиент: "премахни междинните хранения"
   Отговор: "Разбирам. Премахването може да опрости храненето, но може и да доведе до преяждане. За твоята цел препоръчвам 1 здравословна закуска вместо пълно премахване. Премахваме всички или оставяме 1?"
   
   [ЧАКАЙ потвърждение преди REGENERATE_PLAN]
   
   Клиент: "добре, премахни всички"
   Отговор: "✓ Разбрано! Регенерирам плана със 3 основни хранения. [REGENERATE_PLAN:{"modifications":["3_meals_per_day"]}]"

5. ПОДДЪРЖАНИ МОДИФИКАЦИИ:
   - "no_intermediate_meals" - без междинни хранения
   - "3_meals_per_day" - 3 хранения дневно
   - "4_meals_per_day" - 4 хранения дневно
   - "vegetarian" - вегетариански план
   - "no_dairy" - без млечни продукти
   - "low_carb" - нисковъглехидратна диета
   - "increase_protein" - повече протеини

ПОМНИ: Кратко, ясно, прост език, максимум 1 въпрос!`;

        // Check if logged in
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showDashboard();
            }
        }

        // Login
        function login() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                errorDiv.textContent = 'Грешна парола!';
                errorDiv.style.display = 'block';
            }
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadSettings();
            loadStats();
        }

        // Load Settings
        async function loadSettings() {
            try {
                // Try to load from server (KV storage) first
                try {
                    const response = await fetch(WORKER_URL + '/api/admin/get-config');
                    if (response.ok) {
                        const config = await response.json();
                        if (config.success) {
                            // Use server data if available
                            if (config.provider) {
                                document.getElementById('aiProvider').value = config.provider;
                                localStorage.setItem('adminAIProvider', config.provider);
                            }
                            if (config.modelName) {
                                document.getElementById('aiModelName').value = config.modelName;
                                document.getElementById('currentModel').textContent = config.modelName.toUpperCase();
                                localStorage.setItem('adminAIModelName', config.modelName);
                            }
                            if (config.planPrompt) {
                                document.getElementById('aiPrompt').value = config.planPrompt;
                                localStorage.setItem('adminAIPrompt', config.planPrompt);
                            }
                            if (config.consultationPrompt) {
                                document.getElementById('consultationPrompt').value = config.consultationPrompt;
                                localStorage.setItem('adminConsultationPrompt', config.consultationPrompt);
                            }
                            if (config.modificationPrompt) {
                                document.getElementById('modificationPrompt').value = config.modificationPrompt;
                                localStorage.setItem('adminModificationPrompt', config.modificationPrompt);
                            }
                            return; // Successfully loaded from server
                        }
                    }
                } catch (serverError) {
                    console.warn('Could not load from server, using local cache:', serverError);
                }

                // Fallback to localStorage if server is unavailable
                const savedProvider = localStorage.getItem('adminAIProvider') || 'openai';
                document.getElementById('aiProvider').value = savedProvider;
                
                const savedModelName = localStorage.getItem('adminAIModelName') || 'gpt-4o-mini';
                document.getElementById('aiModelName').value = savedModelName;
                document.getElementById('currentModel').textContent = savedModelName.toUpperCase();

                const savedPrompt = localStorage.getItem('adminAIPrompt') || DEFAULT_PLAN_PROMPT;
                document.getElementById('aiPrompt').value = savedPrompt;

                const savedConsultationPrompt = localStorage.getItem('adminConsultationPrompt') || DEFAULT_CONSULTATION_PROMPT;
                document.getElementById('consultationPrompt').value = savedConsultationPrompt;

                const savedModificationPrompt = localStorage.getItem('adminModificationPrompt') || DEFAULT_MODIFICATION_PROMPT;
                document.getElementById('modificationPrompt').value = savedModificationPrompt;

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load Stats
        function loadStats() {
            // Mock stats - in production these would come from KV or analytics
            document.getElementById('totalUsers').textContent = '-';
            document.getElementById('totalPlans').textContent = '-';
        }

        // Save AI Model
        async function saveAIModel() {
            const provider = document.getElementById('aiProvider').value;
            const modelName = document.getElementById('aiModelName').value.trim();
            
            if (!modelName) {
                showError('Моля, въведете име на модел!');
                return;
            }
            
            localStorage.setItem('adminAIProvider', provider);
            localStorage.setItem('adminAIModelName', modelName);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, modelName })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('AI модел запазен успешно!');
                document.getElementById('currentModel').textContent = modelName.toUpperCase();
            } catch (error) {
                console.error('Error saving model:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save AI Prompt
        async function saveAIPrompt() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            
            if (!prompt) {
                showError('Промптът не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminAIPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'plan', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('AI промпт запазен успешно!');
            } catch (error) {
                console.error('Error saving prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save Chat Prompt - Consultation Mode
        async function saveConsultationPrompt() {
            const prompt = document.getElementById('consultationPrompt').value.trim();
            
            if (!prompt) {
                showError('Консултационният промпт не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminConsultationPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'consultation', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('Консултационен промпт запазен успешно!');
            } catch (error) {
                console.error('Error saving consultation prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save Chat Prompt - Modification Mode
        async function saveModificationPrompt() {
            const prompt = document.getElementById('modificationPrompt').value.trim();
            
            if (!prompt) {
                showError('Промптът за промяна не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminModificationPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'modification', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('Промпт за промяна запазен успешно!');
            } catch (error) {
                console.error('Error saving modification prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Reset Prompt
        function resetPrompt() {
            if (confirm('Сигурни ли сте, че искате да възстановите промпта по подразбиране?')) {
                document.getElementById('aiPrompt').value = DEFAULT_PLAN_PROMPT;
                showSuccess('Промпт възстановен по подразбиране.');
            }
        }

        // Color Scheme Functions
        const colorSchemes = {
            'purple-pink': {
                primary: '#10b981',
                primaryAccent: '#34d399',
                secondary: '#3b82f6',
                tertiary: '#ff7f6a',
                soft: '#ecfdf5',
                name: 'Зелено-Синьо-Корал'
            },
            'green-blue': {
                primary: '#4CAF50',
                primaryAccent: '#66BB6A',
                secondary: '#42A5F5',
                tertiary: '#ff8a65',
                soft: '#E8F5E9',
                name: 'Зелено-Синя-Корал'
            },
            'blue-indigo': {
                primary: '#3B82F6',
                primaryAccent: '#60A5FA',
                secondary: '#6366F1',
                tertiary: '#ff7f6a',
                soft: '#EFF6FF',
                name: 'Синьо-Индиго-Корал'
            },
            'orange-red': {
                primary: '#F97316',
                primaryAccent: '#FB923C',
                secondary: '#EF4444',
                tertiary: '#ff7f6a',
                soft: '#FFF7ED',
                name: 'Оранжево-Червено-Корал'
            },
            'custom': {
                primary: '#10b981',
                primaryAccent: '#34d399',
                secondary: '#3b82f6',
                tertiary: '#ff7f6a',
                soft: '#ecfdf5',
                name: 'Персонализирана'
            }
        };

        function previewColorScheme() {
            const scheme = document.getElementById('colorScheme').value;
            const customSection = document.getElementById('customColorSection');
            
            // Show/hide custom color picker
            if (scheme === 'custom') {
                customSection.style.display = 'block';
                // Load saved custom colors or use defaults
                const savedCustomColors = localStorage.getItem('customColors');
                if (savedCustomColors) {
                    const colors = JSON.parse(savedCustomColors);
                    document.getElementById('customPrimary').value = colors.primary;
                    document.getElementById('customSecondary').value = colors.secondary;
                    document.getElementById('customAccent').value = colors.tertiary;
                }
                // Add event listeners to update preview in real-time (remove old ones first to avoid duplicates)
                const primaryInput = document.getElementById('customPrimary');
                const secondaryInput = document.getElementById('customSecondary');
                const accentInput = document.getElementById('customAccent');
                
                primaryInput.removeEventListener('input', updateCustomPreview);
                secondaryInput.removeEventListener('input', updateCustomPreview);
                accentInput.removeEventListener('input', updateCustomPreview);
                
                primaryInput.addEventListener('input', updateCustomPreview);
                secondaryInput.addEventListener('input', updateCustomPreview);
                accentInput.addEventListener('input', updateCustomPreview);
                updateCustomPreview();
            } else {
                customSection.style.display = 'none';
                const colors = colorSchemes[scheme];
                const preview = document.getElementById('colorPreview');
                
                preview.innerHTML = `
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${colors.primary};">
                        Основен
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${colors.secondary};">
                        Вторичен
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: ${colors.tertiary};">
                        Акцент
                    </div>
                `;
            }
        }
        
        function updateCustomPreview() {
            const primary = document.getElementById('customPrimary').value;
            const secondary = document.getElementById('customSecondary').value;
            const accent = document.getElementById('customAccent').value;
            const preview = document.getElementById('colorPreview');
            
            preview.innerHTML = `
                <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${primary};">
                    Основен
                </div>
                <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${secondary};">
                    Вторичен
                </div>
                <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: ${accent};">
                    Акцент
                </div>
            `;
        }

        async function saveColorScheme() {
            const scheme = document.getElementById('colorScheme').value;
            
            try {
                if (scheme === 'custom') {
                    // Save custom colors
                    const customColors = {
                        primary: document.getElementById('customPrimary').value,
                        secondary: document.getElementById('customSecondary').value,
                        tertiary: document.getElementById('customAccent').value,
                        // Generate light version (slightly lighter) and dark version
                        primaryAccent: lightenColor(document.getElementById('customPrimary').value, 20),
                        soft: lightenColor(document.getElementById('customPrimary').value, 80)
                    };
                    localStorage.setItem('customColors', JSON.stringify(customColors));
                    localStorage.setItem('colorScheme', scheme);
                    showSuccess('Персонализираната цветова схема е запазена успешно!');
                } else {
                    localStorage.setItem('colorScheme', scheme);
                    showSuccess(`Цветовата схема "${colorSchemes[scheme].name}" е запазена успешно!`);
                }
                
                // In a real implementation, this would save to the backend
                // await fetch('/api/admin/color-scheme', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ scheme })
                // });
            } catch (error) {
                showError('Грешка при запазване на цветовата схема: ' + error.message);
            }
        }
        
        // Helper function to lighten colors for soft backgrounds and light theme variants
        function lightenColor(hex, percent) {
            // Parse hex color to integer
            const num = parseInt(hex.replace('#', ''), 16);
            // Calculate amount to add (percent of 255)
            const amt = Math.round(2.55 * percent);
            // Extract RGB channels using bit shifting and add amount
            const R = (num >> 16) + amt;  // Red channel (bits 16-23)
            const G = (num >> 8 & 0x00FF) + amt;  // Green channel (bits 8-15)
            const B = (num & 0x0000FF) + amt;  // Blue channel (bits 0-7)
            // Clamp values to 0-255 range and reconstruct hex
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // Load saved color scheme
        function loadColorScheme() {
            const savedScheme = localStorage.getItem('colorScheme') || 'purple-pink';
            document.getElementById('colorScheme').value = savedScheme;
            previewColorScheme();
        }

        // Clear Cache
        function clearCache() {
            if (confirm('Сигурни ли сте, че искате да изчистите целия кеш? Това ще премахне всички запазени планове и данни.')) {
                // In production, call worker API to clear KV
                localStorage.clear();
                sessionStorage.setItem('adminLoggedIn', 'true'); // Keep logged in
                showSuccess('Кешът е изчистен успешно!');
            }
        }

        // View Logs
        function viewLogs() {
            alert('Преглед на логове ще бъде имплементиран в бъдеща версия.\nЗа текущи логове, проверете Cloudflare Dashboard.');
        }

        // Helper Functions
        function showSuccess(message) {
            const div = document.getElementById('successMessage');
            div.textContent = message;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            div.textContent = message;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        // Initialize
        checkAuth();
        loadColorScheme();

        // --- PWA Install Banner Functionality ---
        let deferredPrompt;
        let installButtonListenerAdded = false; // Prevent duplicate listeners
        
        // Constants
        const INSTALL_BANNER_DISMISS_DAYS = 7; // Number of days before showing banner again
        const MILLISECONDS_PER_DAY = 1000 * 60 * 60 * 24;
        const PWA_DEBUG = true; // Enable debugging to see PWA installation status
        
        // Helper function to check if banner was recently dismissed
        function wasBannerRecentlyDismissed() {
            const dismissedTime = localStorage.getItem('installBannerDismissed');
            if (dismissedTime) {
                const daysSinceDismissed = (Date.now() - parseInt(dismissedTime)) / MILLISECONDS_PER_DAY;
                // Show again after configured number of days
                if (daysSinceDismissed < INSTALL_BANNER_DISMISS_DAYS) {
                    if (PWA_DEBUG) console.log('Install banner was recently dismissed');
                    return true;
                }
            }
            return false;
        }
        
        // Capture the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            if (PWA_DEBUG) console.log('beforeinstallprompt fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show the install banner only if not recently dismissed
            if (!wasBannerRecentlyDismissed()) {
                showInstallBanner();
            }
        });
        
        // Check if app is installable on page load (for iOS and other browsers)
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkInstallability();
            }, 2000); // Wait 2 seconds for beforeinstallprompt to potentially fire
        });
        
        function checkInstallability() {
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                if (PWA_DEBUG) console.log('App is already installed');
                return;
            }
            
            // Check if banner was recently dismissed
            if (wasBannerRecentlyDismissed()) {
                if (PWA_DEBUG) console.log('Banner was recently dismissed');
                return;
            }
            
            // For iOS Safari or browsers that don't fire beforeinstallprompt
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone === true;
            
            if (isIOS && !isStandalone && !deferredPrompt) {
                if (PWA_DEBUG) console.log('iOS device detected, showing iOS-specific banner');
                showIOSInstallBanner();
            } else if (!deferredPrompt) {
                // beforeinstallprompt hasn't fired yet, but app might still be installable
                beforeinstallprompt not fired yet';
                // Don't show banner without deferredPrompt on Android - it won't work
                // The banner will show when beforeinstallprompt fires
                }
            }
        }

        // Show install banner
        function showInstallBanner() {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) {
                installBanner.classList.add('show');
                if (PWA_DEBUG) console.log('Install banner shown');
            }
        }
        
        // Show iOS-specific install banner with instructions
        function showIOSInstallBanner() {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) {
                // Update banner text for iOS
                const titleEl = installBanner.querySelector('.install-banner-title');
                const textEl = installBanner.querySelector('.install-banner-text');
                const installBtn = document.getElementById('installBtn');
                
                if (titleEl) titleEl.textContent = 'Инсталирай NutriPlan';
                if (textEl) textEl.innerHTML = 'Натисни <i class="fas fa-share"></i> и избери "Добави към Home Screen"';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i> Разбрах';
                    // Remove any existing event listeners by cloning the button
                    const newBtn = installBtn.cloneNode(true);
                    installBtn.parentNode.replaceChild(newBtn, installBtn);
                    // Add only click handler for iOS
                    newBtn.addEventListener('click', () => hideInstallBanner());
                }
                
                installBanner.classList.add('show');
                if (PWA_DEBUG) console.log('iOS install banner shown');
            }
        }

        // Hide install banner
        function hideInstallBanner() {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) {
                installBanner.classList.remove('show');
                if (PWA_DEBUG) console.log('Install banner hidden');
            }
        }

        // Handle install button click
        function setupInstallButton() {
            const installBtn = document.getElementById('installBtn');
            if (!installBtn || installButtonListenerAdded) {
                return; // Already setup or button not found
            }
            
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    if (PWA_DEBUG) console.log('No deferred prompt available');
                    return;
                }

                // Store original button content before any changes
                const originalBtnContent = installBtn.innerHTML;
                
                try {
                    // Show loading state on button
                    installBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Инсталиране...';
                    installBtn.disabled = true;
                    
                    if (PWA_DEBUG) console.log('Triggering install prompt automatically...');
                    
                    // Automatically show the native install prompt
                    deferredPrompt.prompt();
                    
                    // Wait for the user to respond to the native prompt
                    const { outcome } = await deferredPrompt.userChoice;
                    if (PWA_DEBUG) console.log(`User response to the install prompt: ${outcome}`);
                    
                    if (outcome === 'accepted') {
                        if (PWA_DEBUG) console.log('✅ User accepted - app will install automatically!');
                        // Show success message briefly before banner disappears
                        installBtn.innerHTML = '<i class="fas fa-check"></i> Инсталира се...';
                        setTimeout(() => {
                            hideInstallBanner();
                        }, 1500);
                    } else {
                        if (PWA_DEBUG) console.log('❌ User dismissed the install prompt');
                        // Restore button state
                        installBtn.innerHTML = originalBtnContent;
                        installBtn.disabled = false;
                    }
                    
                    // Clear the deferred prompt
                    deferredPrompt = null;
                } catch (error) {
                    console.error('Error during installation:', error);
                    // Restore button using stored original content
                    installBtn.innerHTML = originalBtnContent;
                    installBtn.disabled = false;
                }
            });
            
            installButtonListenerAdded = true;
            if (PWA_DEBUG) console.log('Install button listener setup complete');
        }
        
        // Setup install button listener immediately (for Android browsers)
        setupInstallButton();

        // Handle dismiss button click
        const dismissInstallBtn = document.getElementById('dismissInstallBtn');
        if (dismissInstallBtn) {
            dismissInstallBtn.addEventListener('click', () => {
                hideInstallBanner();
                
                // Store dismissal in localStorage (to not show again for 7 days)
                localStorage.setItem('installBannerDismissed', Date.now().toString());
            });
        }

        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            if (PWA_DEBUG) console.log('PWA was installed');
            hideInstallBanner();
            deferredPrompt = null;
        });

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
