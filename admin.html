<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NutriPlan">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <title>Админ Панел - NutriPlan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #10b981;
            --primary-dark: #059669;
            --soft-red: #d1fae5;
            --accent-yellow: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-light-red: #f87171;
            --bg-color: #fefce8;
            --text-dark: #1e3a20;
            --text-gray: #4b5563;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(16,185,129,0.15);
            --radius: 16px;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --primary-red: #34d399;
            --primary-dark: #10b981;
            --soft-red: #064e3b;
            --accent-yellow: #fcd34d;
            --accent-blue: #60a5fa;
            --accent-light-red: #fca5a5;
            --bg-color: #0f1419;
            --text-dark: #e5f3e8;
            --text-gray: #9ca3af;
            --white: #1a2028;
            --shadow: 0 10px 30px rgba(52,211,153,0.3);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
        }

        .logout-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 10px 20px;

        .theme-toggle {
            background: var(--bg-color);
            border: 2px solid var(--text-gray);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        .theme-toggle:hover {
            border-color: var(--primary-red);
            transform: scale(1.05);
        }
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .logout-btn:hover {
            background: var(--primary-dark);
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--soft-red);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.3s;
            font-family: inherit;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #e8f8f5;
            border-left: 4px solid #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 30px;
            color: var(--primary-red);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-red);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .card {
                padding: 20px;
            }
        }

        /* Report Item Styles */
        .report-item {
            background: var(--bg-color);
            border: 1px solid var(--text-gray);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .report-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .report-user {
            font-weight: 600;
            color: var(--primary-red);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-time {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .report-message {
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .report-meta {
            font-size: 0.8rem;
            color: var(--text-gray);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .report-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-unread {
            background: #ff9800;
            color: white;
        }

        .badge-read {
            background: #4CAF50;
            color: white;
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text-dark);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 1001;
            max-width: 90%;
            animation: slideUpBanner 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .install-banner.show {
            display: flex;
        }

        @keyframes slideUpBanner {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-banner-icon {
            font-size: 2.5rem;
            color: var(--primary-red);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
            border-radius: 12px;
        }

        .install-banner-content {
            flex: 1;
            min-width: 0;
        }

        .install-banner-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 1rem;
            line-height: 1.3;
            color: var(--text-dark);
        }

        .install-banner-text {
            font-size: 0.875rem;
            color: var(--text-gray);
            line-height: 1.4;
        }

        .install-banner-browser {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--primary-red);
            font-weight: 600;
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(220, 38, 38, 0.08);
            border-radius: 6px;
        }

        .install-banner-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .install-banner-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .install-banner-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
        }

        .install-banner-btn:active {
            transform: translateY(0);
        }

        .install-banner-btn.dismiss {
            background: transparent;
            color: var(--text-gray);
            padding: 12px 16px;
        }

        .install-banner-btn.dismiss:hover {
            background: var(--soft-red);
            color: var(--text-dark);
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .install-banner {
                flex-direction: column;
                padding: 20px 16px;
                bottom: 12px;
                max-width: calc(100% - 24px);
                gap: 16px;
            }

            .install-banner-icon {
                width: 56px;
                height: 56px;
                font-size: 2.75rem;
            }

            .install-banner-content {
                text-align: center;
                width: 100%;
            }

            .install-banner-title {
                font-size: 1.05rem;
                margin-bottom: 8px;
            }

            .install-banner-text {
                font-size: 0.875rem;
                line-height: 1.5;
            }

            .install-banner-browser {
                display: inline-flex;
                margin-top: 8px;
            }

            .install-banner-actions {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .install-banner-btn {
                width: 100%;
                justify-content: center;
                padding: 14px 24px;
                font-size: 0.95rem;
            }

            .install-banner-btn.dismiss {
                padding: 12px 24px;
            }
        }

        .ios-prompt {
            position: fixed;
            bottom: 20px;
            width: 90%;
            left: 5%;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            padding: 15px;
            font-family: 'Poppins', sans-serif;
            animation: slideUpIOS 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUpIOS {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ios-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-gray);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .ios-close:hover {
            color: var(--text-dark);
            transform: scale(1.1);
        }

        .ios-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ios-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .ios-title-group h4 {
            margin: 0;
            color: var(--text-dark);
            font-size: 1rem;
            font-weight: 700;
        }

        .ios-title-group p {
            margin: 5px 0 0;
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.4;
        }

        .ios-instructions {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 14px;
            text-align: center;
            color: var(--text-dark);
        }

        .ios-instructions p {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .ios-share-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

    </style>
</head>
<body>
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-icon" id="installBannerIcon">
            <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="install-banner-content">
            <div class="install-banner-title" id="installBannerTitle">Инсталирай NutriPlan</div>
            <div class="install-banner-text" id="installBannerText">Добави приложението към началния екран</div>
            <div class="install-banner-browser" id="installBannerBrowser" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <span id="installBannerBrowserText"></span>
            </div>
        </div>
        <div class="install-banner-actions">
            <button class="install-banner-btn" id="installBtn">
                <i class="fas fa-download"></i>
                <span>Инсталирай</span>
            </button>
            <button class="install-banner-btn dismiss" id="dismissInstallBtn">
                <i class="fas fa-times"></i>
                <span>По-късно</span>
            </button>
        </div>
    </div>

    <!-- iOS Install Banner -->
    <div id="ios-banner" class="ios-prompt" style="display:none;">
        <button onclick="dismissIosBanner()" class="ios-close">✕</button>
        <div class="ios-header">
            <img src="./icon-192x192.png" class="ios-icon" alt="NutriPlan Icon">
            <div class="ios-title-group">
                <h4>Инсталирай NutriPlan</h4>
                <p>Добави на екрана за бърз достъп и известия</p>
            </div>
        </div>
        <div class="ios-instructions">
            <p>Натисни бутона <img id="ios-share-icon-img" class="ios-share-icon" alt="Share"> и избери <strong>"Add to Home Screen" (Добави към начален екран)</strong></p>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1><i class="fas fa-shield-alt"></i> Админ Вход</h1>
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Парола" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Вход
            </button>
            <div id="loginError" class="error-message" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" style="display: none;">
        <div class="container">
            <header>
                <h1><i class="fas fa-cog"></i> Админ Панел</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Смени тема">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Изход
                    </button>
                </div>
            </header>

            <!-- Stats Section -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">-</h3>
                    <p>Общо Потребители</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalPlans">-</h3>
                    <p>Генерирани Планове</p>
                </div>
                <div class="stat-card">
                    <h3 id="currentModel">-</h3>
                    <p>Активен AI Модел</p>
                </div>
            </div>

            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>

            <!-- AI Model Selection -->
            <div class="card">
                <h2><i class="fas fa-robot"></i> AI Модел</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Изберете AI провайдър и конкретен модел за генериране на планове и чат.
                </div>
                <div class="form-group">
                    <label for="aiProvider">Избери AI Провайдър:</label>
                    <select id="aiProvider">
                        <option value="openai">OpenAI</option>
                        <option value="google">Google</option>
                        <option value="mock">Mock (За тестване без API)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="aiModelName">Име на модел:</label>
                    <input type="text" id="aiModelName" placeholder="напр. gpt-4o, gemini-2.0-flash-exp">
                    <small style="display: block; margin-top: 5px; color: var(--text-gray);">
                        OpenAI примери: gpt-4o, gpt-4o-mini, gpt-4-turbo<br>
                        Google примери: gemini-pro, gemini-2.0-flash-exp, gemini-1.5-pro
                    </small>
                </div>
                <button class="btn" onclick="saveAIModel()">
                    <i class="fas fa-save"></i> Запази Модел
                </button>
            </div>

            <!-- Color Scheme Configuration -->
            <div class="card">
                <h2><i class="fas fa-palette"></i> Цветова Схема</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Изберете цветова схема за потребителския интерфейс. Промените ще се приложат автоматично за всички потребители.
                </div>
                <div class="form-group">
                    <label for="colorScheme">Избери Цветова Палитра:</label>
                    <select id="colorScheme" onchange="previewColorScheme()">
                        <option value="purple-pink">Зелено-Жълта (Модерна Premium)</option>
                        <option value="green-blue">Зелено-Синя (Здравословна)</option>
                        <option value="blue-indigo">Синьо-Индиго (Професионална)</option>
                        <option value="orange-red">Оранжево-Червена (Енергична)</option>
                        <option value="custom">Персонализирана (Избери свои цветове)</option>
                    </select>
                </div>
                
                <!-- Custom Color Picker Section -->
                <div id="customColorSection" style="display: none; margin: 20px 0; padding: 20px; background: var(--bg-color); border-radius: 12px; border: 2px solid var(--primary-red);">
                    <h3 style="margin-bottom: 15px; color: var(--text-dark);"><i class="fas fa-paint-brush"></i> Избери 3 Основни Цвята</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="customPrimary">Основен Цвят (Primary):</label>
                            <input type="color" id="customPrimary" value="#10b981" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За бутони и акценти</small>
                        </div>
                        <div class="form-group">
                            <label for="customSecondary">Вторичен Цвят (Secondary):</label>
                            <input type="color" id="customSecondary" value="#3b82f6" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За подчертаване</small>
                        </div>
                        <div class="form-group">
                            <label for="customAccent">Акцентиращ Цвят (Accent):</label>
                            <input type="color" id="customAccent" value="#ff7f6a" style="width: 100%; height: 50px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: var(--text-gray);">За специални елементи</small>
                        </div>
                    </div>
                </div>
                <div id="colorPreview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: #10b981;">
                        Зелено
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: #3b82f6;">
                        Синьо
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: #ff7f6a;">
                        Корал
                    </div>
                </div>
                <button class="btn" onclick="saveColorScheme()">
                    <i class="fas fa-save"></i> Запази Цветова Схема
                </button>
            </div>

            <!-- AI Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-pen-fancy"></i> AI Промпт за Генериране на План</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Променете промпта само ако знаете какво правите. Грешен промпт може да доведе до некоректни планове.
                </div>
                <div class="form-group">
                    <label for="aiPrompt">Промпт Шаблон:</label>
                    <textarea id="aiPrompt" placeholder="Въведете промпт шаблон..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> Използвайте {name}, {age}, {weight}, {height}, {goal} и други полета от въпросника.
                </div>
                <button class="btn" onclick="saveAIPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт
                </button>
                <button class="btn" onclick="resetPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Analysis Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-brain"></i> AI Промпт за Анализ (Стъпка 1)</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Този промпт се използва за холистичен анализ на клиента - BMR, TDEE, метаболитен профил, психологически фактори.
                </div>
                <div class="form-group">
                    <label for="analysisPrompt">Промпт за Анализ:</label>
                    <textarea id="analysisPrompt" placeholder="Въведете промпт за анализ..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> Използвайте {userData} за всички данни на клиента в JSON формат, или отделни променливи като {name}, {age}, {goal} и др.
                </div>
                <button class="btn" onclick="saveAnalysisPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Анализ
                </button>
                <button class="btn" onclick="viewDefaultPrompt('analysis', 'analysisPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
                <button class="btn" onclick="resetAnalysisPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Strategy Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-chess"></i> AI Промпт за Стратегия (Стъпка 2)</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Този промпт се използва за определяне на оптималната диетична стратегия базирана на анализа.
                </div>
                <div class="form-group">
                    <label for="strategyPrompt">Промпт за Стратегия:</label>
                    <textarea id="strategyPrompt" placeholder="Въведете промпт за стратегия..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> Използвайте {userData} за данни на клиента, {analysisData} за резултатите от анализа, {name}, {age}, {goal} и др.
                </div>
                <button class="btn" onclick="saveStrategyPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Стратегия
                </button>
                <button class="btn" onclick="viewDefaultPrompt('strategy', 'strategyPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
                <button class="btn" onclick="resetStrategyPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Meal Plan Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-utensils"></i> AI Промпт за Генериране на Хранителен План (Стъпка 3)</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Този промпт е критичен - използва се за генериране на конкретните ястия и хранения за всеки ден.
                </div>
                <div class="form-group">
                    <label for="mealPlanPrompt">Промпт за Хранителен План:</label>
                    <textarea id="mealPlanPrompt" placeholder="Въведете промпт за хранителен план..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> {userData}, {analysisData}, {strategyData}, {bmr}, {recommendedCalories}, {startDay}, {endDay}, {previousDays}
                </div>
                <button class="btn" onclick="saveMealPlanPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Хранителен План
                </button>
                <button class="btn" onclick="viewDefaultPrompt('meal_plan', 'mealPlanPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
                <button class="btn" onclick="resetMealPlanPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Summary Prompt Editor -->
            <div class="card">
                <h2><i class="fas fa-clipboard-check"></i> AI Промпт за Обобщение (Стъпка 4)</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Този промпт се използва за генериране на обобщение, препоръки и допълнения към седмичния план.
                </div>
                <div class="form-group">
                    <label for="summaryPrompt">Промпт за Обобщение:</label>
                    <textarea id="summaryPrompt" placeholder="Въведете промпт за обобщение..."></textarea>
                </div>
                <div class="info-box">
                    <strong>Променливи:</strong> {userData}, {strategyData}, {weekPlan}, {bmr}, {recommendedCalories}, {avgCalories}, {avgProtein}, {avgCarbs}, {avgFats}
                </div>
                <button class="btn" onclick="saveSummaryPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Обобщение
                </button>
                <button class="btn" onclick="viewDefaultPrompt('summary', 'summaryPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
                <button class="btn" onclick="resetSummaryPrompt()" style="background: #7f8c8d; margin-left: 10px;">
                    <i class="fas fa-undo"></i> Възстанови по подразбиране
                </button>
            </div>

            <!-- Chat Prompt Editor - Consultation Mode -->
            <div class="card">
                <h2><i class="fas fa-comments"></i> AI Промпт за Чат Асистент - Режим Консултация</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Този промпт се използва когато потребителят е в режим на консултация (само четене на плана).
                </div>
                <div class="form-group">
                    <label for="consultationPrompt">Промпт за Консултационен Режим:</label>
                    <textarea id="consultationPrompt" placeholder="Въведете промпт за консултационен режим..."></textarea>
                </div>
                <button class="btn" onclick="saveConsultationPrompt()">
                    <i class="fas fa-save"></i> Запази Консултационен Промпт
                </button>
                <button class="btn" onclick="viewDefaultPrompt('consultation', 'consultationPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
            </div>

            <!-- Chat Prompt Editor - Modification Mode -->
            <div class="card">
                <h2><i class="fas fa-edit"></i> AI Промпт за Чат Асистент - Режим Промяна на План</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Този промпт се използва когато потребителят иска да промени хранителния си план.
                </div>
                <div class="form-group">
                    <label for="modificationPrompt">Промпт за Режим Промяна:</label>
                    <textarea id="modificationPrompt" placeholder="Въведете промпт за режим промяна на план..."></textarea>
                </div>
                <button class="btn" onclick="saveModificationPrompt()">
                    <i class="fas fa-save"></i> Запази Промпт за Промяна
                </button>
                <button class="btn" onclick="viewDefaultPrompt('modification', 'modificationPrompt')" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-eye"></i> Виж Стандартен Промпт
                </button>
            </div>

            <!-- Problem Reports Section -->
            <div class="card">
                <h2><i class="fas fa-exclamation-triangle"></i> Доклади за Проблеми</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Тук можете да видите всички доклади за проблеми, изпратени от потребителите.
                </div>
                <button class="btn" onclick="loadReports()" style="margin-bottom: 20px;">
                    <i class="fas fa-sync"></i> Обнови Доклади
                </button>
                <div id="reportsContainer" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: var(--text-gray); padding: 20px;">
                        Натиснете "Обнови Доклади" за да заредите докладите.
                    </p>
                </div>
            </div>

            <!-- AI Communication Logs -->
            <div class="card">
                <h2><i class="fas fa-network-wired"></i> AI Комуникационни Логове</h2>
                <div class="info-box">
                    <strong>Информация:</strong> Преглед на цялата комуникация между бекенда и AI модела. Вижте какво изисква всяка стъпка и каква натовареност има.
                </div>
                <div class="form-group">
                    <label>Филтриране и Опции:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="number" id="logsLimit" placeholder="Лимит (по подразбиране: 50)" value="50" style="flex: 1;">
                        <input type="number" id="logsOffset" placeholder="Отместване (по подразбиране: 0)" value="0" style="flex: 1;">
                    </div>
                </div>
                <button class="btn" onclick="loadAILogs()" style="margin-bottom: 20px;">
                    <i class="fas fa-sync"></i> Зареди Логове
                </button>
                <div id="aiLogsStats" style="display: none; margin-bottom: 20px; padding: 15px; background: var(--soft-red); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">Статистика:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <strong>Общо Логове:</strong>
                            <div id="totalLogs">-</div>
                        </div>
                        <div>
                            <strong>Средно Време:</strong>
                            <div id="avgDuration">-</div>
                        </div>
                        <div>
                            <strong>Общо Входни Токени:</strong>
                            <div id="totalInputTokens">-</div>
                        </div>
                        <div>
                            <strong>Общо Изходни Токени:</strong>
                            <div id="totalOutputTokens">-</div>
                        </div>
                    </div>
                </div>
                <div id="aiLogsContainer" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; color: var(--text-gray); padding: 20px;">
                        Натиснете "Зареди Логове" за да видите комуникационните логове.
                    </p>
                </div>
            </div>

            <!-- Blacklist Management -->
            <div class="card">
                <h2><i class="fas fa-ban"></i> Управление на Черен Списък с Храни</h2>
                <div class="warning-box">
                    <strong>Внимание:</strong> Храните в черния списък ще бъдат КАТЕГОРИЧНО ЗАБРАНЕНИ при генериране на планове. AI-то няма да може да ги използва.
                </div>
                <div class="form-group">
                    <label>Текущ Черен Списък:</label>
                    <div id="blacklistDisplay" style="padding: 15px; background: var(--soft-red); border-radius: 8px; margin-bottom: 15px; min-height: 80px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Blacklisted items will be displayed here -->
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Добави храна в черния списък:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="blacklistInput" placeholder="Напр: гръцко кисело мляко" style="flex: 1;">
                        <button class="btn" onclick="addToBlacklist()" style="background: var(--accent-light-red);">
                            <i class="fas fa-plus"></i> Добави
                        </button>
                    </div>
                    <small style="color: var(--text-gray); display: block; margin-top: 5px;">
                        Добавете храни на български и/или английски език. Препоръчително е да добавите и двата варианта.
                    </small>
                </div>
                <button class="btn" onclick="loadBlacklist()" style="background: var(--accent-blue); margin-top: 10px;">
                    <i class="fas fa-sync"></i> Опресни Списъка
                </button>
            </div>

            <!-- System Actions -->
            <div class="card">
                <h2><i class="fas fa-tools"></i> Системни Действия</h2>
                <button class="btn" onclick="clearCache()" style="background: #e67e22;">
                    <i class="fas fa-trash"></i> Изчисти Кеш
                </button>
                <button class="btn" onclick="viewLogs()" style="background: #3498db; margin-left: 10px;">
                    <i class="fas fa-file-alt"></i> Преглед на Логове
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Management ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Initialize theme on load
        initializeTheme();

        // WARNING: This is a basic client-side authentication for demonstration purposes.
        // For production use, implement proper server-side authentication with the worker.
        // This password is visible in the browser source code and should not be used for security.
        const ADMIN_PASSWORD = 'nutriplan2024'; // TODO: Move to server-side auth
        const WORKER_URL = 'https://aidiet.radilov-k.workers.dev';

        // Default prompts
        const DEFAULT_PLAN_PROMPT = `Ти си професионален диетолог и здравен консултант. Създай подробен 7-дневен хранителен план за клиент със следните характеристики:

ОСНОВНИ ДАННИ:
- Име: {name}
- Пол: {gender}
- Възраст: {age} години
- Ръст: {height} см
- Тегло: {weight} кг
- Цел: {goal}

ЗДРАВОСЛОВЕН ПРОФИЛ:
- Сън: {sleepHours} часа
- Хронотип: {chronotype}
- Активност през деня: {dailyActivityLevel}
- Стрес: {stressLevel}
- Спортна активност: {sportActivity}

ХРАНИТЕЛНИ НАВИЦИ:
- Вода: {waterIntake}
- Прекомерно хранене: {overeatingFrequency}

ПРЕДПОЧИТАНИЯ:
- Диетични предпочитания: {dietPreference}
- Не обича/непоносимост: {dietDislike}
- Любими храни: {dietLove}

МЕДИЦИНСКИ СЪСТОЯНИЯ:
- Състояния: {medicalConditions}
- Лекарства: {medications}

Моля, върни отговора в JSON формат с weekPlan, recommendations, forbidden, psychology, waterIntake, supplements.
Включи 3-5 хранения на ден за всеки от 7-те дни.`;

        const DEFAULT_CHAT_PROMPT = `Ти си личен диетолог, психолог и здравен асистент за {name}.
Отговори на въпроса като професионален консултант. Бъди топъл, подкрепящ и мотивиращ.`;

        // Default prompts for all AI operations (extracted from worker.js)
        const DEFAULT_ANALYSIS_PROMPT = `Ти си експертен диетолог, психолог и ендокринолог. Направи ХОЛИСТИЧЕН АНАЛИЗ на клиента и ИЗЧИСЛИ калориите и макросите.

═══ КЛИЕНТСКИ ПРОФИЛ ═══
{userData}

═══ БАЗОВА ИНФОРМАЦИЯ ЗА ИЗЧИСЛЕНИЯ ═══
Основни физически параметри (за референция):
- Тегло: {weight} кг
- Височина: {height} см
- Възраст: {age} години
- Пол: {gender}
- Цел: {goal}
{lossKg}

ВАЖНО: Използвай Mifflin-St Jeor формула като ОТПРАВНА ТОЧКА, но АНАЛИЗИРАЙ ХОЛИСТИЧНО:
- Качество на сън и стрес
- История на диети (метаболитна адаптация)
- Медицински състояния и лекарства
- Психологически фактори и емоционално хранене
- Реален дневен ритъм и хронотип
- Съотношение спорт/дневна активност

═══ НАСОКИ ЗА ХОЛИСТИЧНО ИЗЧИСЛЕНИЕ ═══

ФОРМУЛА КАТО БАЗА:
- BMR: Mifflin-St Jeor (10×тегло + 6.25×височина - 5×възраст + 5/-161)
- TDEE: BMR × Activity Factor (1.2 до 1.9 според активност)
- Калории: според цел (отслабване обикновено с дефицит, мускулна маса с излишък)

КЛЮЧОВИ ФАКТОРИ ЗА КОРЕКЦИЯ:
- Качество на сън влияе на хормони и метаболизъм
- Стрес влияе на кортизол и енергийна ефективност
- История на диети може да означава метаболитна адаптация
- Медицински състояния (щитовидна жлеза, СПКЯ, диабет) влияят на метаболизма
- Психологически фактори определят реалистичните и устойчиви цели
- Хронотип и дневен ритъм влияят на оптималното разпределение

ПРИМЕР ЗА ИЛЮСТРАЦИЯ (не следвай точно):
Жена, 35г, 70кг, 165см, средна активност:
- Добър профил (добър сън, нисък стрес, без диети): BMR≈1400, TDEE≈2160, Цел≈1840 kcal
- Предизвикателен профил (лош сън, висок стрес, 3 диети): BMR≈1180, TDEE≈1780, Цел≈1600 kcal
(Забележка: AI моделът прецени по-нисък BMR/TDEE и по-консервативен дефицит заради кумулативния ефект)

═══ ТВОЯТА ЗАДАЧА ═══
1. АНАЛИЗИРАЙ ХОЛИСТИЧНО всички данни за {name}
2. ИЗЧИСЛИ BMR, TDEE и препоръчани калории базирано на ТВОЯТА ПРОФЕСИОНАЛНА ПРЕЦЕНКА
3. ОБЯСНИ детайлно ЗАЩО си избрал точно тези стойности
4. Покажи логиката и математиката в reasoning полетата

2. КОРЕЛАЦИОНЕН АНАЛИЗ:

**СЪН ↔ СТРЕС ↔ ХРАНЕНЕ**: Как {sleepHours}ч сън (прекъсван: {sleepInterrupt}) + стрес ({stressLevel}) влияят на:
   - Хормони (кортизол, грелин, лептин)
   - Хранителни желания: {foodCravings}
   - Прекомерно хранене: {overeatingFrequency}

**ПСИХОЛОГИЧЕСКИ ПРОФИЛ**: Анализирай връзката емоции ↔ хранене:
   - Тригери: {foodTriggers}
   - Компенсации: {compensationMethods}
   - Социално сравнение: {socialComparison}
   - Оценка на самодисциплина и мотивация

**МЕТАБОЛИТНИ ОСОБЕНОСТИ**: Идентифицирай уникален метаболитен профил базиран на:
   - Хронотип ({chronotype}) → кога е оптимално храненето
   - Активност ({sportActivity}, {dailyActivityLevel})
   - История: {dietHistory}
   - ВАЖНО: Неуспешни диети в миналото обикновено означават намален метаболизъм

**МЕДИЦИНСКИ ФАКТОРИ**: Как медицински състояния влияят на хранене:
   - Състояния: {medicalConditions}
   - Лекарства: {medications}
   - Какви специфични нужди от макро/микроелементи?

3. **ШАНС ЗА УСПЕХ**: Изчисли успех score (-100 до +100) базиран на ВСИЧКИ фактори:
   - BMI и здравословно състояние
   - Качество на съня и стрес
   - История на диети (неуспешни намаляват шанса с 15-25 точки)
   - Психологическа устойчивост
   - Медицински условия и активност

4. **КЛЮЧОВИ ПРОБЛЕМИ**: Идентифицирай 3-6 проблемни области (САМО Borderline/Risky/Critical severity):
   - Фокус на фактори които АКТИВНО пречат на целта
   - НЕ включвай "Normal" проблеми

═══ ФОРМАТ НА ОТГОВОР ═══
КРИТИЧНО ВАЖНО - ТИПОВЕ ДАННИ И ИЗЧИСЛЕНИЯ:
- Числови полета ТРЯБВА да съдържат САМО числа (integer или float)
- БЕЗ текст, единици измерване или обяснения в числовите полета
- Обяснения се поставят в отделни "_reasoning" полета
- BMR, TDEE, recommendedCalories - ТИ ги изчисляваш базирано на ВСИЧКИ корелати!

{
  "bmr": число (ТИ изчисляваш холистично),
  "bmrReasoning": "обяснение как и защо си коригирал базовата Mifflin-St Jeor формула",
  "tdee": число (ТИ изчисляваш холистично),
  "tdeeReasoning": "обяснение как активността, стресът, съня влияят на TDEE",
  "recommendedCalories": число (ТИ определяш базирано на цел и корелати),
  "caloriesReasoning": "обяснение защо ТОЧНО тези калории - как целта, стресът, историята на диети, метаболизма влияят на изчислението",
  "macroRatios": {
    "protein": число (процент, напр. 30),
    "carbs": число (процент, напр. 35),
    "fats": число (процент, напр. 35)
  },
  "macroRatiosReasoning": {
    "protein": "обосновка защо този процент е оптимален за {name}",
    "carbs": "обосновка базирана на активност, медицински състояния",
    "fats": "обосновка според нужди"
  },
  "macroGrams": {
    "protein": число (грамове дневно),
    "carbs": число (грамове дневно),
    "fats": число (грамове дневно)
  },
  "weeklyBlueprint": {
    "skipBreakfast": boolean (true ако клиентът не закусва),
    "dailyMealCount": число (колко хранения на ден, обикновено 2-4),
    "mealCountReasoning": "защо този брой хранения е оптимален",
    "dailyStructure": [
      {
        "dayIndex": 1,
        "meals": [
          {
            "type": "breakfast/lunch/dinner/snack",
            "active": boolean,
            "calorieTarget": число (калории за това хранене),
            "proteinSource": "предложен основен протеин (напр. chicken, fish, eggs)",
            "carbSource": "предложен въглехидрат (напр. quinoa, rice, vegetables)"
          }
        ]
      }
      // ... повторете за всички 7 дни
    ]
  },
  "metabolicProfile": "УНИКАЛЕН метаболитен профил - опиши как хронотип, активност, история влияят на метаболизма",
  "healthRisks": ["риск 1 специфичен за профила", "риск 2", "риск 3"],
  "nutritionalNeeds": ["нужда 1 базирана на анализа", "нужда 2", "нужда 3"],
  "psychologicalProfile": "ДЕТАЙЛЕН анализ: емоционално хранене, тригери, копинг механизми, мотивация",
  "successChance": число (-100 до 100),
  "successChanceReasoning": "защо този шанс - кои фактори помагат и кои пречат",
  "keyProblems": [
    {
      "title": "кратко име (2-4 думи)",
      "description": "защо е проблем и до какво води",
      "severity": "Borderline / Risky / Critical",
      "severityValue": число 0-100,
      "category": "Sleep / Nutrition / Hydration / Stress / Activity / Medical",
      "impact": "въздействие върху здравето или целта"
    }
  ]
}

ВАЖНИ ПРАВИЛА ЗА weeklyBlueprint:
1. Сборът на calorieTarget за всички активни хранения в един ден ТРЯБВА да е равен на твоите изчислени recommendedCalories
2. Ако skipBreakfast е true, "breakfast" хранения ТРЯБВА да имат active: false и calorieTarget: 0
3. Варирай proteinSource и carbSource между дните за разнообразие
4. Типовете хранения трябва да са в хронологичен ред: breakfast -> lunch -> snack -> dinner
5. Използвай dailyMealCount за консистентност през цялата седмица (освен ако няма специфична причина за вариация)

Бъди КОНКРЕТЕН за {name}. Избягвай общи фрази като "добър метаболизъм" - обясни ЗАЩО и КАК!`;

        const DEFAULT_STRATEGY_PROMPT = `Базирайки се на здравословния профил и анализа, определи оптималната диетична стратегия:

КЛИЕНТ: {name}, {age} год., Цел: {goal}

АНАЛИЗ (КОМПАКТЕН):
- BMR/TDEE/Калории: {bmr} / {tdee} / {recommendedCalories}
- Макро съотношения: {macroRatios}
- Макро грамове дневно: {macroGrams}
{weeklyBlueprint}
- Метаболитен профил: {metabolicProfile}
- Здравни рискове: {healthRisks}
- Хранителни нужди: {nutritionalNeeds}
- Психологически профил: {psychologicalProfile}
- Шанс за успех: {successChance}
- Ключови проблеми: {keyProblems}

ПРЕДПОЧИТАНИЯ:
- Диетични предпочитания: {dietPreference}
- Не обича/непоносимост: {dietDislike}
- Любими храни: {dietLove}

ВАЖНО: Вземи предвид ВСИЧКИ параметри холистично и създай КОРЕЛАЦИИ между тях:
1. Медицинските състояния и лекарства - как влияят на хранителните нужди
2. Хранителните непоносимости и алергии - строго ограничение
3. Личните предпочитания и любими храни - за дългосрочна устойчивост
4. Хронотипа и дневния ритъм - оптимално време на хранене
5. Нивото на стрес и емоционалното хранене - психологическа подкрепа
6. Културния контекст (български традиции и налични продукти)
7. КОРЕЛАЦИИ между сън, стрес и хранителни желания
8. ВРЪЗКАТА между физическа активност и калорийни нужди
9. ВЗАИМОВРЪЗКАТА между медицински състояния и хранителни потребности

КРИТИЧНО ВАЖНО - ИНДИВИДУАЛИЗАЦИЯ НА ВСИЧКИ ПРЕПОРЪКИ:
1. Хранителните добавки трябва да са СТРОГО ИНДИВИДУАЛНО подбрани за {name}
2. ЗАБРАНЕНО е използването на универсални/общи препоръки за добавки
3. Всяка добавка трябва да е обоснована с КОНКРЕТНИ нужди от анализа
4. Дозировките трябва да са персонализирани според възраст, тегло, пол и здравословно състояние
5. Вземи предвид медицински състояния, лекарства и възможни взаимодействия
6. КРИТИЧНО - ПРОВЕРКА ЗА ВЗАИМОДЕЙСТВИЯ:
   - Ако клиентът приема лекарства: {medications}, провери:
     * Витамин К + антикоагуланти (варфарин) = противопоказано
     * Калций/Магнезий + антибиотици = намалено усвояване
     * Желязо + антациди = блокирано усвояване
     * Витамин D + кортикостероиди = необходима по-висока доза
   - Ако има медицински състояния: {medicalConditions}, съобрази:
     * Диабет: Хром, Витамин D, Омега-3 (контрол на кръвна захар)
     * Хипертония: Магнезий, Калий, CoQ10 (понижаване на налягане)
     * Щитовидна жлеза: Селен, Йод (само ако е дефицит!), Цинк
     * Анемия: Желязо (хемово за по-добро усвояване), Витамин C (подпомага усвояването), B12
     * PCOS/СПКЯ: Инозитол, Витамин D, Омега-3, Хром
     * IBS/IBD: Пробиотици (специфични щамове), Витамин D, Омега-3
7. ИНДИВИДУАЛНА ДОЗИРОВКА базирана на:
   - Тегло: {weight} кг (по-високо тегло = по-висока доза за липоразтворими витамини)
   - Възраст: {age} год. (по-възрастни = по-високи нужди от Витамин D, B12, Калций)
   - Пол: {gender} (жени = повече желязо при менструация; мъже = повече цинк)
   - Сън: {sleepHours}ч (под 7ч = Магнезий за сън, Мелатонин)
   - Стрес: {stressLevel} (висок стрес = Магнезий, Витамини B-комплекс, Ашваганда)
   - Активност: {sportActivity} (висока = Протеин, BCAA, Креатин, Витамин D)

КРИТИЧНО ВАЖНО - ОПРЕДЕЛЯНЕ НА МОДИФИКАТОР:
След анализ на всички параметри, определи подходящ МОДИФИКАТОР (диетичен профил), който ще управлява логиката на генериране на ястия:
- Може да бъде термин: "Кето", "Палео", "Веган", "Вегетарианско", "Средиземноморско", "Нисковъглехидратно", "Балансирано", "Щадящ стомах", "Без глутен" и др.
- МОДИФИКАТОРЪТ трябва да отчита медицинските състояния, цели, предпочитания и всички анализирани фактори
- Определи ЕДНА основна диетична стратегия, която е най-подходяща за клиента
- Ако няма специфични ограничения, използвай "Балансирано" или "Средиземноморско"

Анализирай ЗАДЪЛБОЧЕНО как всеки параметър влияе и взаимодейства с другите.

КРИТИЧНО ВАЖНО - ДЪЛГОСРОЧНА СТРАТЕГИЯ:
1. Създай ЯСНА дългосрочна стратегия за постигане на целите на {name}
2. Стратегията трябва да обхваща не само дневен, но и СЕДМИЧЕН/МНОГОДНЕВЕН хоризонт
3. При обоснована физиологична, психологическа или стратегическа идея:
   - Планирането може да обхваща 2-3 дни като цяло
   - Хоризонтът на макроси и калории НЕ Е ЗАДЪЛЖИТЕЛНО 24 часа
   - Може да има циклично разпределение на калории/макроси (напр. ниско-високи дни)
4. Обоснови ЗАЩО избираш определен брой хранения (1-5) за всеки ден
5. Обоснови ЗАЩО и КОГА са необходими хранения след вечеря (ако има такива)
6. Всяка стратегическа нестандартна препоръка ТРЯБВА да има ясна цел и обосновка

Върни JSON със стратегия (БЕЗ универсални препоръки):
{
  "dietaryModifier": "термин за основен диетичен профил (напр. Балансирано, Кето, Веган, Средиземноморско, Нисковъглехидратно, Щадящ стомах)",
  "modifierReasoning": "Детайлно обяснение защо този МОДИФИКАТОР е избран СПЕЦИФИЧНО за {name}",
  "welcomeMessage": "ЗАДЪЛЖИТЕЛНО ПОЛЕ: ПЕРСОНАЛИЗИРАНО приветствие за {name} при първото разглеждане на плана. Тонът трябва да бъде професионален, но топъл и мотивиращ. Включи: 1) Персонално поздравление с име, 2) Кратко споменаване на конкретни фактори от профила (възраст, цел, ключови предизвикателства), 3) Как планът е създаден специално за техните нужди, 4) Положителна визия за постигане на целите. Дължина: 150-250 думи. ВАЖНО: Избягвай генерични фрази - използвай конкретни детайли за {name}.",
  "planJustification": "ЗАДЪЛЖИТЕЛНО ПОЛЕ: Детайлна обосновка на цялостната стратегия, включително брой хранения, време на хранене, циклично разпределение (ако има), хранения след вечеря (ако има), и ЗАЩО тази стратегия е оптимална за {name}. Минимум 100 символа.",
  "longTermStrategy": "ДЪЛГОСРОЧНА СТРАТЕГИЯ: Опиши как планът работи в рамките на 2-3 дни/седмица, не само на дневна база. Включи информация за циклично разпределение на калории/макроси, варииране на хранения, и как това подпомага целите.",
  "mealCountJustification": "ОБОСНОВКА ЗА БРОЙ ХРАНЕНИЯ: Защо е избран точно този брой хранения (1-5) за всеки ден. Каква е стратегическата, физиологична или психологическа причина.",
  "afterDinnerMealJustification": "ОБОСНОВКА ЗА ХРАНЕНИЯ СЛЕД ВЕЧЕРЯ: Ако има хранения след вечеря, обясни ЗАЩО са необходими, каква е целта, и как подпомагат общата стратегия. Ако няма - напиши 'Не са необходими'.",
  "dietType": "тип диета персонализиран за {name} (напр. средиземноморска, балансирана, ниско-въглехидратна)",
  "weeklyMealPattern": "ХОЛИСТИЧНА седмична схема на хранене (напр. '16:8 интермитентно гладуване ежедневно', '5:2 подход', 'циклично фастинг', 'свободен уикенд', или традиционна схема с варииращи хранения)",
  "mealTiming": {
    "pattern": "седмичен модел на хранене описан детайлно - напр. 'Понеделник-Петък: 2 хранения (12:00, 19:00), Събота-Неделя: 3 хранения с едно свободно'",
    "fastingWindows": "периоди на гладуване ако се прилага (напр. '16 часа между последно хранене и следващо', или 'не се прилага')",
    "flexibility": "описание на гъвкавостта в схемата според дните и нуждите"
  },
  "keyPrinciples": ["принцип 1 специфичен за {name}", "принцип 2 специфичен за {name}", "принцип 3 специфичен за {name}"],
  "foodsToInclude": ["храна 1 подходяща за {name}", "храна 2 подходяща за {name}", "храна 3 подходяща за {name}"],
  "foodsToAvoid": ["храна 1 неподходяща за {name}", "храна 2 неподходяща за {name}", "храна 3 неподходяща за {name}"],
  "supplementRecommendations": [
    "! ИНДИВИДУАЛНА добавка 1 за {name} - конкретна добавка с дозировка и обосновка защо Е НУЖНА за този клиент (БАЗИРАНА на: възраст {age} год., пол {gender}, цел {goal}, медицински състояния {medicalConditions})",
    "! ИНДИВИДУАЛНА добавка 2 за {name} - конкретна добавка с дозировка и обосновка защо Е НУЖНА за този клиент (БАЗИРАНА на: активност {sportActivity}, сън {sleepHours}ч, стрес {stressLevel})",
    "! ИНДИВИДУАЛНА добавка 3 за {name} - конкретна добавка с дозировка и обосновка защо Е НУЖНА за този клиент (БАЗИРАНА на: хранителни навици {eatingHabits}, предпочитания {dietPreference})"
  ],
  "hydrationStrategy": "препоръки за прием на течности персонализирани за {name} според активност и климат",
  "psychologicalSupport": [
    "! психологически съвет 1 базиран на емоционалното хранене на {name}",
    "! психологически съвет 2 базиран на стреса и поведението на {name}",
    "! психологически съвет 3 за мотивация специфичен за профила на {name}"
  ]
}

ВАЖНО ЗА СЕДМИЧНАТА СХЕМА:
- Създай ХОЛИСТИЧЕН седмичен модел, който взема предвид целта, хронотипа и навиците
- Интермитентно гладуване (16:8, 18:6, OMAD) е напълно валиден избор ако подхожда
- Може да варираш броя хранения между дните (напр. 2 хранения в работни дни, 3 в почивни)
- "Свободни дни" или "свободни хранения" са позволени като част от устойчива стратегия
- Седмицата трябва да работи като СИСТЕМА, не като 7 независими дни

ВАЖНО ЗА ХРАНИТЕЛНИ ДОБАВКИ:
- Всяка добавка трябва да има ЯСНА обосновка базирана на:
  * Дефицити от анализа (напр. нисък витамин D заради малко излагане на слънце)
  * Медицински състояния (напр. магнезий за стрес, омега-3 за възпаление)
  * Цели (напр. протеин за мускулна маса, желязо за енергия)
  * Възраст и пол (напр. калций за жени над 40, цинк за мъже)
- Дозировката трябва да е ПЕРСОНАЛИЗИРАНА според тегло, възраст и нужди
- Времето на прием трябва да е оптимално за усвояване
- СТРОГО ЗАБРАНЕНО: Използването на едни и същи добавки за различни клиенти
- СТРОГО ЗАБРАНЕНО: Универсални "мултивитамини" без конкретна обосновка
- Всяка добавка ТРЯБВА да е различна и специфична за конкретния клиент {name}
- Вземи предвид уникалната комбинация от: {age} год. {gender}, {goal}, {medicalConditions}, {sportActivity}, стрес: {stressLevel}`;

        const DEFAULT_MEAL_PLAN_PROMPT = `Ти действаш като Advanced Dietary Logic Engine (ADLE) – логически конструктор на хранителни режими.

=== ЗАДАЧА ===
Генерирай ДНИ {startDay}-{endDay} от 7-дневен хранителен план за {name}.

=== КЛИЕНТ ===
Име: {name}, Цел: {goal}, Калории: {recommendedCalories} kcal/ден
BMR: {bmr}, Модификатор: "{dietaryModifier}"{modificationsSection}
Стрес: {stressLevel}, Сън: {sleepHours}ч, Хронотип: {chronotype}
{blueprintSection}
=== СТРАТЕГИЯ (КОМПАКТНА) ===
Диета: {dietType}
Схема: {weeklyMealPattern}
Хранения: {mealTiming}
Принципи: {keyPrinciples}
Избягвай: {dietDislike}, {foodsToAvoid}
Включвай: {dietLove}, {foodsToInclude}{previousDaysContext}

=== КОРЕЛАЦИОННА АДАПТАЦИЯ ===
СТРЕС И ХРАНЕНЕ:
- Стрес: {stressLevel}
- При висок стрес, включи храни богати на:
  * Магнезий (тъмно зелени листни зеленчуци, ядки, семена, пълнозърнести храни)
  * Витамин C (цитруси, чушки, зеле)
  * Омега-3 (мазна риба, ленено семе, орехи)
  * Комплекс B витамини (яйца, месо, бобови)
- Избягвай стимуланти (кафе, енергийни напитки) при висок стрес

ХРОНОТИП И КАЛОРИЙНО РАЗПРЕДЕЛЕНИЕ:
- Хронотип: {chronotype}
- "Ранобуден" / "Сова на сутринта" → По-обилна закуска (30-35% калории), умерена вечеря (25%)
- "Вечерен тип" / "Нощна сова" → Лека закуска (20%), по-обилна вечеря (35% калории)
- "Смесен тип" → Балансирано разпределение (25-30-25-20%)

СЪН И ХРАНЕНЕ:
- Сън: {sleepHours}ч
- При малко сън (< 6ч): Включи храни с триптофан (яйца, кисело мляко, банани, сирене) за подобряване на съня
- Избягвай тежки храни вечер ако съня е прекъсван

=== АРХИТЕКТУРА ===
Категории: [PRO]=Белтък, [ENG]=Енергия/въглехидрати, [VOL]=Зеленчуци/фибри, [FAT]=Мазнини, [CMPX]=Сложни ястия
Шаблони: A) РАЗДЕЛЕНА ЧИНИЯ=[PRO]+[ENG]+[VOL], B) СМЕСЕНО=[PRO]+[ENG]+[VOL] микс, C) ЛЕКО/САНДВИЧ, D) ЕДИНЕН БЛОК=[CMPX]+[VOL]
Филтриране според "{dietaryModifier}": Веган=без животински [PRO]; Кето=минимум [ENG]; Без глутен=[ENG] само ориз/картофи/киноа/елда; Палео=без зърнени/бобови/млечни{skipBreakfastNote}

=== ADLE v8 STRICT RULES (ЗАДЪЛЖИТЕЛНО СПАЗВАНЕ) ===
ПРИОРИТЕТ (винаги): 1) Hard bans → 2) Mode filter (MODE има приоритет над базови правила) → 3) Template constraints → 4) Hard rules (R1-R12) → 5) Repair → 6) Output

0) HARD BANS (0% ВИНАГИ):
- лук (всякаква форма), пуешко месо, изкуствени подсладители
- мед, захар, конфитюр, сиропи
- кетчуп, майонеза, BBQ/сладки сосове
- гръцко кисело мляко (използвай САМО обикновено кисело мляко)
- грах + риба (забранена комбинация)

0.1) РЯДКО (≤2 пъти/седмично): пуешка шунка, бекон

HARD RULES (R1-R12):
R1: Белтък главен = точно 1. Вторичен белтък САМО ако (закуска AND яйца), 0-1.
R2: Зеленчуци = 1-2. Избери ТОЧНО ЕДНА форма: Салата ИЛИ Пресни (НЕ и двете едновременно). Картофите НЕ СА зеленчуци.
R3: Енергия = 0-1 (никога 2).
R4: Млечни макс = 1 на хранене (кисело мляко ИЛИ извара ИЛИ сирене), включително като сос/дресинг.
R5: Мазнини = 0-1. Ако ядки/семена → без зехтин/масло.
R6: Правило за сирене: Ако сирене → без зехтин/масло. Маслини разрешени със сирене.
R7: Правило за бекон: Ако бекон → Мазнини=0.
R8: Бобови-като-основно (боб/леща/нахут/гювеч от грах): Енергия=0 (без ориз/картофи/паста/булгур/овесени). Хляб може да е опционален: +1 филия пълнозърнест.
R9: Правило за хляб (извън Template C): Разрешен САМО ако Енергия=0. Изключение: с бобови-като-основно (R8), хляб може да е опционален (1 филия). Ако има Енергия → Хляб=0.
R10: Грах като добавка към месо: Грахът НЕ Е енергия, но БЛОКИРА слота Енергия → Енергия=0. Хляб може да е опционален (+1 филия).
R11: Template C (сандвич): Само за закуски; бобови забранени; без забранени сосове/подсладители.
R12: Извън-whitelist добавяне: По подразбиране=само whitelist. Извън-whitelist САМО ако обективно нужно (MODE/медицинско/наличност), mainstream/универсално, налично в България. Добави ред: Reason: ...

=== WHITELISTS (РАЗРЕШЕНИ ХРАНИ) - ЗАДЪЛЖИТЕЛНО СПАЗВАНЕ ===
КРИТИЧНО: Използвай САМО храни от тези списъци! Извън-whitelist САМО с Reason: ...

WHITELIST PROTEIN (избери точно 1 главен белтък):
- яйца (eggs)
- пилешко (chicken)
- говеждо (beef)
- постна свинска (lean pork)
- риба (white fish, скумрия/mackerel, риба тон/canned tuna)
- кисело мляко (yogurt - plain, несладко)
- извара (cottage cheese - plain)
- сирене (cheese - умерено)
- боб (beans)
- леща (lentils)
- нахут (chickpeas)
- грах (peas - виж 3.5)

ЗАБРАНЕНИ БЕЛТЪЦИ (НЕ използвай без Reason):
- пуешко месо (turkey meat) - HARD BAN
- заешко (rabbit) - ИЗВЪН whitelist
- патица (duck) - ИЗВЪН whitelist
- гъска (goose) - ИЗВЪН whitelist
- агне (lamb) - ИЗВЪН whitelist
- дивеч (game meat) - ИЗВЪН whitelist
- всички екзотични меса - ИЗВЪН whitelist

WHITELIST VEGETABLES (избери 1-2):
- домати, краставици, чушки, зеле, моркови
- салата/листни зеленчуци (lettuce/greens), спанак
- тиквички, гъби, броколи, карфиол
- пресни нарязани: домати/краставици/чушки (БЕЗ дресинг)

WHITELIST ENERGY (избери 0-1):
- овесени ядки (oats)
- ориз (rice)
- картофи (potatoes)
- паста (pasta)
- булгур (bulgur)
ЗАБЕЛЕЖКА: Царевица НЕ е енергия!

WHITELIST FAT (избери 0-1):
- зехтин (olive oil)
- масло (butter - умерено)
- ядки/семена (nuts/seeds - умерено)

СПЕЦИАЛНИ ПРАВИЛА:
- Грах + риба = СТРОГО ЗАБРАНЕНО
- Зеленчуци: ЕДНА форма на хранене (Салата ИЛИ Пресни нарязани, не и двете)
- Маслини = добавка към салата (НЕ Мазнини слот). Ако маслини → БЕЗ зехтин/масло
- Царевица = НЕ е енергия. Малко царевица само в салати като добавка
- Template C (сандвич) = САМО за закуски, НЕ за основни хранения

=== КРИТИЧНИ ИЗИСКВАНИЯ ===
1. ЗАДЪЛЖИТЕЛНИ МАКРОСИ: Всяко ястие ТРЯБВА да има точни macros (protein, carbs, fats, fiber в грамове)
2. ПРЕЦИЗНИ КАЛОРИИ: Изчислени като protein×4 + carbs×4 + fats×9 за ВСЯКО ястие
3. ЦЕЛЕВА ДНЕВНА СУМА: Около {recommendedCalories} kcal на ден (±{tolerance} kcal е приемливо)
   - Целта е ОРИЕНТИР, НЕ строго изискване
   - По-важно е да спазиш правилния брой и ред на хранения, отколкото да достигнеш точно калориите
4. БРОЙ ХРАНЕНИЯ: 1-6 хранения на ден според диетичната стратегия и целта
   - 1 хранене (OMAD): само при ясна стратегия за интермитентно гладуване
   - 2 хранения: при стратегия за интермитентно гладуване (16:8, 18:6)
   - 3 хранения: Закуска, Обяд, Вечеря (стандартен вариант)
   - 4 хранения: Закуска, Обяд, Следобедна закуска, Вечеря (при нужда от по-честа хранене)
   - 5 хранения: Закуска, Обяд, Следобедна закуска, Вечеря, Късна закуска (при специфични случаи)
   - 6 хранения: рядко, само при специфична медицинска/спортна стратегия
   - КРИТИЧНО: Броят хранения се определя от СТРАТЕГИЯТА, НЕ от нуждата да се достигнат калории!
   - НИКОГА не добавяй хранения САМО за достигане на калории!
5. РАЗНООБРАЗИЕ: Всеки ден различен от предишните
6. Реалистични български/средиземноморски ястия

=== МЕДИЦИНСКИ И ДИЕТЕТИЧНИ ПРИНЦИПИ ЗА РЕД НА ХРАНЕНИЯ ===
КРИТИЧНО ВАЖНО: Следвай СТРОГО медицинските и диететични принципи за ред на храненията:

1. ПОЗВОЛЕНИ ТИПОВЕ ХРАНЕНИЯ (в хронологичен ред):
   - "Закуска" (сутрин) - САМО като първо хранене на деня
   - "Обяд" (обед) - САМО след закуската или като първо хранене (ако няма закуска)
   - "Следобедна закуска" (опционално, между обяд и вечеря)
   - "Вечеря" (вечер) - обикновено последно хранене
   - "Късна закуска" (опционално, САМО след вечеря, специални случаи)

2. ХРОНОЛОГИЧЕН РЕД: Храненията ТРЯБВА да следват естествения дневен ритъм
   - НЕ може да има закуска след обяд
   - НЕ може да има обяд след вечеря
   - НЕ може да има вечеря преди обяд

3. КЪСНА ЗАКУСКА - строги изисквания:
   КОГАТО Е ДОПУСТИМА:
   - Дълъг период между вечеря и сън (> 4 часа)
   - Проблеми със съня заради глад
   - Диабет тип 2 (стабилизиране на кръвната захар)
   - Интензивни тренировки вечер
   - Работа на смени (нощни смени)
   
   ЗАДЪЛЖИТЕЛНИ УСЛОВИЯ:
   - САМО след "Вечеря" (никога преди)
   - МАКСИМУМ 1 на ден
   - САМО храни с НИСЪК ГЛИКЕМИЧЕН ИНДЕКС (ГИ < 55):
     * Кисело мляко (150ml), кефир
     * Ядки: 30-40g бадеми/орехи/лешници/кашу
     * Ягоди/боровинки/малини (50-100g)
     * Авокадо (половин)
     * Семена: чиа/ленено/тиквени (1-2 с.л.)
   - МАКСИМУМ {maxLateSnackCalories} калории
   - НЕ използвай ако не е оправдано от профила на клиента!

4. КАЛОРИЙНО РАЗПРЕДЕЛЕНИЕ: 
   - Разпредели калориите в избраните хранения според стратегията (1-6 хранения)
   - Ако порциите стават твърде големи, това е приемливо - по-добре от добавяне на хранения след вечеря
   - Допустимо е да имаш 1800 kcal вместо 2000 kcal - това НЕ е проблем
   - АБСОЛЮТНО ЗАБРАНЕНО е да добавяш хранения след вечеря без оправдание!

{mealNameFormatInstructions}

JSON ФОРМАТ (върни САМО дните {startDay}-{endDay}):
{
  "day{startDay}": {
    "meals": [
      {"type": "Закуска", "name": "име ястие", "weight": "Xg", "description": "описание", "benefits": "ползи", "calories": X, "macros": {"protein": X, "carbs": X, "fats": X, "fiber": X}},
      {"type": "Обяд", "name": "име ястие", "weight": "Xg", "description": "описание", "benefits": "ползи", "calories": X, "macros": {"protein": X, "carbs": X, "fats": X, "fiber": X}},
      {"type": "Вечеря", "name": "име ястие", "weight": "Xg", "description": "описание", "benefits": "ползи", "calories": X, "macros": {"protein": X, "carbs": X, "fats": X, "fiber": X}}
    ],
    "dailyTotals": {"calories": X, "protein": X, "carbs": X, "fats": X}
  }{multiDayExample}
}

Генерирай дни {startDay}-{endDay} с балансирани ястия в правилен хронологичен ред. ЗАДЪЛЖИТЕЛНО включи dailyTotals за проверка!`;

        const DEFAULT_SUMMARY_PROMPT = `Създай summary, препоръки и допълнения за 7-дневен хранителен план.

КЛИЕНТ: {name}, Цел: {goal}
BMR: {bmr}, Целеви калории: {recommendedCalories} kcal/ден
Реален среден прием: {avgCalories} kcal/ден
Реални средни макроси: Protein {avgProtein}g, Carbs {avgCarbs}g, Fats {avgFats}g

СТРАТЕГИЯ (КОМПАКТНА):
- Психологическа подкрепа: {psychologicalSupport}
- Добавки: {supplementRecommendations}
- Хидратация: {hydrationStrategy}
- Включвай: {foodsToInclude}
- Избягвай: {foodsToAvoid}

JSON ФОРМАТ (КРИТИЧНО - използвай САМО числа за числови полета):
{
  "summary": {
    "bmr": {bmr},
    "dailyCalories": {avgCalories},
    "macros": {"protein": {avgProtein}, "carbs": {avgCarbs}, "fats": {avgFats}}
  },
  "recommendations": ["конкретна храна 1", "храна 2", "храна 3", "храна 4", "храна 5"],
  "forbidden": ["забранена храна 1", "храна 2", "храна 3", "храна 4"],
  "psychology": {psychologySupport},
  "waterIntake": "{hydrationStrategy}",
  "supplements": {supplementRecommendationsArray}
}

ВАЖНО: recommendations/forbidden=САМО конкретни храни според цел {goal}, НЕ общи съвети.`;

        const DEFAULT_CONSULTATION_PROMPT = `ТЕКУЩ РЕЖИМ: КОНСУЛТАЦИЯ

ВАЖНИ ПРАВИЛА:
1. Можеш да четеш плана, но НЕ МОЖЕШ да го променяш.
2. Бъди КРАТЪК но информативен - максимум 3-4 изречения, прост език.
3. Ако клиентът иска промяна, кажи: "За промяна активирай режима за промяна на плана."
4. НИКОГА не използвай [REGENERATE_PLAN:...] инструкции.
5. Винаги поддържай мотивиращ тон.
6. Форматирай отговорите си ясно - използвай нови редове за разделяне на мисли.
7. Задавай максимум 1 въпрос на отговор.

ПРИМЕРИ:
- "Закуската съдържа овесени ядки с банан (350 калории). За промяна, активирай режима за промяна."
- "Можеш да замениш рибата с пилешко - и двете са отлични източници на протеин. За промяна, активирай режима за промяна."`;

        const DEFAULT_MODIFICATION_PROMPT = `ТЕКУЩ РЕЖИМ: ПРОМЯНА НА ПЛАНА

ВАЖНИ ПРАВИЛА:
1. Ти си професионален диетолог. Бъди КРАТЪК но информативен, ЯСЕН и директен.
2. Използвай ПРОСТ език, лесно разбираем.
3. Ограничи се до МАКСИМУМ 3-4 изречения в отговор.
4. Задавай МАКСИМУМ 1 въпрос на отговор.
5. Форматирай отговорите си ясно:
   - Използвай нови редове за разделяне на различни мисли
   - Когато изброяваш опции, сложи всяка на нов ред с тире (-)
   - Използвай празни редове за по-добра четимост между параграфи

2. Когато клиентът иска промяна:
   - Анализирай дали е здравословно за цел: {goal}
   - Обясни КРАТКО последиците (само основното)
   - Ако има по-добра алтернатива, предложи я с 1 изречение
   - Запитай с 1 въпрос за потвърждение
   - След потвърждение, приложи с [REGENERATE_PLAN:{"modifications":["описание"]}]

3. РАЗПОЗНАВАНЕ НА ПОТВЪРЖДЕНИЕ:
   - "да", "yes", "добре", "ок", "окей", "сигурен", "сигурна" = ПОТВЪРЖДЕНИЕ
   - Ако клиентът потвърди (каже "да"), НЕ питай отново! Приложи промяната ВЕДНАГА.
   - Ако вече си задавал същия въпрос в историята, НЕ го питай отново - приложи промяната!
   - НИКОГА не задавай един и същ въпрос повече от ВЕДНЪЖ.

4. НИКОГА не прилагай директно промяна без обсъждане! Винаги обясни и консултирай първо.

5. ЗА ПРЕМАХВАНЕ НА КОНКРЕТНИ ХРАНИ:
   - Ако клиентът иска да премахне конкретна храна (напр. "овесени ядки"), използвай специален модификатор:
   - Формат: "exclude_food:име_на_храната" (напр. "exclude_food:овесени ядки")
   - Пример: [REGENERATE_PLAN:{"modifications":["exclude_food:овесени ядки"]}]
   - Това ще регенерира плана БЕЗ тази храна

6. ПРИМЕР С ФОРМАТИРАНЕ:
   Клиент: "премахни междинните хранения"
   
   Отговор: "Разбирам. Премахването може да опрости храненето, но може и да доведе до преяждане.
   
   За твоята цел препоръчвам една от двете:
   - Премахване на всички междинни хранения (само 3 основни)
   - Оставяне на 1 здравословна закуска (по-балансирано)
   
   Какво предпочиташ?"
   
   [ЧАКАЙ потвърждение преди REGENERATE_PLAN]
   
   Клиент: "да" или "добре, премахни всички"
   
   Отговор: "✓ Разбрано! Регенерирам плана със 3 основни хранения.
   
   [REGENERATE_PLAN:{"modifications":["3_meals_per_day"]}]"
   
   ПРИМЕР ЗА ПРЕМАХВАНЕ НА ХРАНА:
   Клиент: "махни овесените ядки"
   
   Отговор: "Разбирам. Премахването на овесените ядки ще намали фибрите в закуската.
   
   Искаш ли да ги премахна от всички дни?"
   
   Клиент: "да"
   
   Отговор: "✓ Разбрано! Премахвам овесените ядки от плана.
   
   [REGENERATE_PLAN:{"modifications":["exclude_food:овесени ядки"]}]"

7. ПОДДЪРЖАНИ МОДИФИКАЦИИ:
   - "no_intermediate_meals" - без междинни хранения
   - "3_meals_per_day" - 3 хранения дневно
   - "4_meals_per_day" - 4 хранения дневно
   - "vegetarian" - вегетариански план
   - "no_dairy" - без млечни продукти
   - "low_carb" - нисковъглехидратна диета
   - "increase_protein" - повече протеини
   - "exclude_food:име_на_храна" - премахване на конкретна храна

ПОМНИ: 
- Форматирай ясно с нови редове и изброяване
- Максимум 3-4 изречения
- Максимум 1 въпрос
- АКО клиентът вече потвърди, НЕ питай отново - ПРИЛОЖИ ВЕДНАГА!`;

        // Check if logged in
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showDashboard();
            }
        }

        // Login
        function login() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                errorDiv.textContent = 'Грешна парола!';
                errorDiv.style.display = 'block';
            }
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        // Generic helper function to save prompts
        async function savePromptGeneric(type, elementId, localStorageKey, successMessage, errorMessage) {
            const prompt = document.getElementById(elementId).value.trim();
            
            // Empty prompts are allowed - they will cause the system to use defaults
            localStorage.setItem(localStorageKey, prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, prompt: prompt || '' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess(successMessage);
            } catch (error) {
                console.error(`Error saving ${type} prompt:`, error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Generic helper function to reset prompts
        async function resetPromptGeneric(type, elementId, localStorageKey, successMessage) {
            if (confirm('Сигурни ли сте, че искате да възстановите промпта по подразбиране?')) {
                document.getElementById(elementId).value = '';
                localStorage.removeItem(localStorageKey);
                
                // Delete from KV by saving empty string
                try {
                    const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type, prompt: '' })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to reset on server');
                    }
                    
                    showSuccess(successMessage);
                } catch (error) {
                    console.error(`Error resetting ${type} prompt:`, error);
                    showError('Грешка при възстановяване: ' + error.message);
                }
            }
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadSettings();
            loadStats();
            loadBlacklist(); // Load blacklist on dashboard load
        }

        // Load Settings
        async function loadSettings() {
            try {
                // Try to load from server (KV storage) first
                try {
                    const response = await fetch(WORKER_URL + '/api/admin/get-config');
                    if (response.ok) {
                        const config = await response.json();
                        if (config.success) {
                            // Use server data if available
                            if (config.provider) {
                                document.getElementById('aiProvider').value = config.provider;
                                localStorage.setItem('adminAIProvider', config.provider);
                            }
                            if (config.modelName) {
                                document.getElementById('aiModelName').value = config.modelName;
                                document.getElementById('currentModel').textContent = config.modelName.toUpperCase();
                                localStorage.setItem('adminAIModelName', config.modelName);
                            }
                            if (config.planPrompt) {
                                document.getElementById('aiPrompt').value = config.planPrompt;
                                localStorage.setItem('adminAIPrompt', config.planPrompt);
                            }
                            if (config.consultationPrompt) {
                                document.getElementById('consultationPrompt').value = config.consultationPrompt;
                                localStorage.setItem('adminConsultationPrompt', config.consultationPrompt);
                            }
                            if (config.modificationPrompt) {
                                document.getElementById('modificationPrompt').value = config.modificationPrompt;
                                localStorage.setItem('adminModificationPrompt', config.modificationPrompt);
                            }
                            if (config.analysisPrompt) {
                                document.getElementById('analysisPrompt').value = config.analysisPrompt;
                                localStorage.setItem('adminAnalysisPrompt', config.analysisPrompt);
                            }
                            if (config.strategyPrompt) {
                                document.getElementById('strategyPrompt').value = config.strategyPrompt;
                                localStorage.setItem('adminStrategyPrompt', config.strategyPrompt);
                            }
                            if (config.mealPlanPrompt) {
                                document.getElementById('mealPlanPrompt').value = config.mealPlanPrompt;
                                localStorage.setItem('adminMealPlanPrompt', config.mealPlanPrompt);
                            }
                            if (config.summaryPrompt) {
                                document.getElementById('summaryPrompt').value = config.summaryPrompt;
                                localStorage.setItem('adminSummaryPrompt', config.summaryPrompt);
                            }
                            return; // Successfully loaded from server
                        }
                    }
                } catch (serverError) {
                    console.warn('Could not load from server, using local cache:', serverError);
                }

                // Fallback to localStorage if server is unavailable
                const savedProvider = localStorage.getItem('adminAIProvider') || 'openai';
                document.getElementById('aiProvider').value = savedProvider;
                
                const savedModelName = localStorage.getItem('adminAIModelName') || 'gpt-4o-mini';
                document.getElementById('aiModelName').value = savedModelName;
                document.getElementById('currentModel').textContent = savedModelName.toUpperCase();

                const savedPrompt = localStorage.getItem('adminAIPrompt') || DEFAULT_PLAN_PROMPT;
                document.getElementById('aiPrompt').value = savedPrompt;

                const savedConsultationPrompt = localStorage.getItem('adminConsultationPrompt') || DEFAULT_CONSULTATION_PROMPT;
                document.getElementById('consultationPrompt').value = savedConsultationPrompt;

                const savedModificationPrompt = localStorage.getItem('adminModificationPrompt') || DEFAULT_MODIFICATION_PROMPT;
                document.getElementById('modificationPrompt').value = savedModificationPrompt;

                const savedAnalysisPrompt = localStorage.getItem('adminAnalysisPrompt') || '';
                document.getElementById('analysisPrompt').value = savedAnalysisPrompt;

                const savedStrategyPrompt = localStorage.getItem('adminStrategyPrompt') || '';
                document.getElementById('strategyPrompt').value = savedStrategyPrompt;

                const savedMealPlanPrompt = localStorage.getItem('adminMealPlanPrompt') || '';
                document.getElementById('mealPlanPrompt').value = savedMealPlanPrompt;

                const savedSummaryPrompt = localStorage.getItem('adminSummaryPrompt') || '';
                document.getElementById('summaryPrompt').value = savedSummaryPrompt;

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load Stats
        function loadStats() {
            // Mock stats - in production these would come from KV or analytics
            document.getElementById('totalUsers').textContent = '-';
            document.getElementById('totalPlans').textContent = '-';
        }

        // Save AI Model
        async function saveAIModel() {
            const provider = document.getElementById('aiProvider').value;
            const modelName = document.getElementById('aiModelName').value.trim();
            
            if (!modelName) {
                showError('Моля, въведете име на модел!');
                return;
            }
            
            localStorage.setItem('adminAIProvider', provider);
            localStorage.setItem('adminAIModelName', modelName);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, modelName })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('AI модел запазен успешно!');
                document.getElementById('currentModel').textContent = modelName.toUpperCase();
            } catch (error) {
                console.error('Error saving model:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save AI Prompt
        async function saveAIPrompt() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            
            if (!prompt) {
                showError('Промптът не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminAIPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'plan', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('AI промпт запазен успешно!');
            } catch (error) {
                console.error('Error saving prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save Chat Prompt - Consultation Mode
        async function saveConsultationPrompt() {
            const prompt = document.getElementById('consultationPrompt').value.trim();
            
            if (!prompt) {
                showError('Консултационният промпт не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminConsultationPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'consultation', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('Консултационен промпт запазен успешно!');
            } catch (error) {
                console.error('Error saving consultation prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save Chat Prompt - Modification Mode
        async function saveModificationPrompt() {
            const prompt = document.getElementById('modificationPrompt').value.trim();
            
            if (!prompt) {
                showError('Промптът за промяна не може да бъде празен!');
                return;
            }

            localStorage.setItem('adminModificationPrompt', prompt);
            
            // Save to KV via worker API
            try {
                const response = await fetch(WORKER_URL + '/api/admin/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'modification', prompt })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save to server');
                }
                
                showSuccess('Промпт за промяна запазен успешно!');
            } catch (error) {
                console.error('Error saving modification prompt:', error);
                showError('Грешка при записване: ' + error.message);
            }
        }

        // Save Analysis Prompt
        async function saveAnalysisPrompt() {
            await savePromptGeneric('analysis', 'analysisPrompt', 'adminAnalysisPrompt', 
                'Промпт за анализ запазен успешно!', 'Промптът за анализ не може да бъде празен!');
        }

        // Save Strategy Prompt
        async function saveStrategyPrompt() {
            await savePromptGeneric('strategy', 'strategyPrompt', 'adminStrategyPrompt', 
                'Промпт за стратегия запазен успешно!', 'Промптът за стратегия не може да бъде празен!');
        }

        // Save Meal Plan Prompt
        async function saveMealPlanPrompt() {
            await savePromptGeneric('meal_plan', 'mealPlanPrompt', 'adminMealPlanPrompt', 
                'Промпт за хранителен план запазен успешно!', 'Промптът за хранителен план не може да бъде празен!');
        }

        // Save Summary Prompt
        async function saveSummaryPrompt() {
            await savePromptGeneric('summary', 'summaryPrompt', 'adminSummaryPrompt', 
                'Промпт за обобщение запазен успешно!', 'Промптът за обобщение не може да бъде празен!');
        }

        // Reset Analysis Prompt
        async function resetAnalysisPrompt() {
            await resetPromptGeneric('analysis', 'analysisPrompt', 'adminAnalysisPrompt', 
                'Промпт за анализ изтрит. Ще се използва стандартният промпт.');
        }

        // Reset Strategy Prompt
        async function resetStrategyPrompt() {
            await resetPromptGeneric('strategy', 'strategyPrompt', 'adminStrategyPrompt', 
                'Промпт за стратегия изтрит. Ще се използва стандартният промпт.');
        }

        // Reset Meal Plan Prompt
        async function resetMealPlanPrompt() {
            await resetPromptGeneric('meal_plan', 'mealPlanPrompt', 'adminMealPlanPrompt', 
                'Промпт за хранителен план изтрит. Ще се използва стандартният промпт.');
        }

        // Reset Summary Prompt
        async function resetSummaryPrompt() {
            await resetPromptGeneric('summary', 'summaryPrompt', 'adminSummaryPrompt', 
                'Промпт за обобщение изтрит. Ще се използва стандартният промпт.');
        }

        // Reset Prompt
        function resetPrompt() {
            if (confirm('Сигурни ли сте, че искате да възстановите промпта по подразбиране?')) {
                document.getElementById('aiPrompt').value = DEFAULT_PLAN_PROMPT;
                showSuccess('Промпт възстановен по подразбиране.');
            }
        }

        // View Default Prompt - Load default prompt into textarea for viewing/editing
        function viewDefaultPrompt(promptType, elementId) {
            const promptMap = {
                'analysis': DEFAULT_ANALYSIS_PROMPT,
                'strategy': DEFAULT_STRATEGY_PROMPT,
                'meal_plan': DEFAULT_MEAL_PLAN_PROMPT,
                'summary': DEFAULT_SUMMARY_PROMPT,
                'consultation': DEFAULT_CONSULTATION_PROMPT,
                'modification': DEFAULT_MODIFICATION_PROMPT
            };

            const defaultPrompt = promptMap[promptType];
            
            if (defaultPrompt) {
                document.getElementById(elementId).value = defaultPrompt;
                showSuccess(`Стандартният промпт за ${promptType} е зареден в редактора. Можете да го прегледате или редактирате.`);
            } else {
                showError(`Грешка: Няма наличен стандартен промпт за тип "${promptType}".`);
            }
        }

        // Color Scheme Functions
        const colorSchemes = {
            'purple-pink': {
                primary: '#10b981',
                primaryAccent: '#34d399',
                secondary: '#3b82f6',
                tertiary: '#ff7f6a',
                soft: '#ecfdf5',
                name: 'Зелено-Синьо-Корал'
            },
            'green-blue': {
                primary: '#4CAF50',
                primaryAccent: '#66BB6A',
                secondary: '#42A5F5',
                tertiary: '#ff8a65',
                soft: '#E8F5E9',
                name: 'Зелено-Синя-Корал'
            },
            'blue-indigo': {
                primary: '#3B82F6',
                primaryAccent: '#60A5FA',
                secondary: '#6366F1',
                tertiary: '#ff7f6a',
                soft: '#EFF6FF',
                name: 'Синьо-Индиго-Корал'
            },
            'orange-red': {
                primary: '#F97316',
                primaryAccent: '#FB923C',
                secondary: '#EF4444',
                tertiary: '#ff7f6a',
                soft: '#FFF7ED',
                name: 'Оранжево-Червено-Корал'
            },
            'custom': {
                primary: '#10b981',
                primaryAccent: '#34d399',
                secondary: '#3b82f6',
                tertiary: '#ff7f6a',
                soft: '#ecfdf5',
                name: 'Персонализирана'
            }
        };

        function previewColorScheme() {
            const scheme = document.getElementById('colorScheme').value;
            const customSection = document.getElementById('customColorSection');
            
            // Show/hide custom color picker
            if (scheme === 'custom') {
                customSection.style.display = 'block';
                // Load saved custom colors or use defaults
                const savedCustomColors = localStorage.getItem('customColors');
                if (savedCustomColors) {
                    const colors = JSON.parse(savedCustomColors);
                    document.getElementById('customPrimary').value = colors.primary;
                    document.getElementById('customSecondary').value = colors.secondary;
                    document.getElementById('customAccent').value = colors.tertiary;
                }
                // Add event listeners to update preview in real-time (remove old ones first to avoid duplicates)
                const primaryInput = document.getElementById('customPrimary');
                const secondaryInput = document.getElementById('customSecondary');
                const accentInput = document.getElementById('customAccent');
                
                primaryInput.removeEventListener('input', updateCustomPreview);
                secondaryInput.removeEventListener('input', updateCustomPreview);
                accentInput.removeEventListener('input', updateCustomPreview);
                
                primaryInput.addEventListener('input', updateCustomPreview);
                secondaryInput.addEventListener('input', updateCustomPreview);
                accentInput.addEventListener('input', updateCustomPreview);
                updateCustomPreview();
            } else {
                customSection.style.display = 'none';
                const colors = colorSchemes[scheme];
                const preview = document.getElementById('colorPreview');
                
                preview.innerHTML = `
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${colors.primary};">
                        Основен
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${colors.secondary};">
                        Вторичен
                    </div>
                    <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: ${colors.tertiary};">
                        Акцент
                    </div>
                `;
            }
        }
        
        function updateCustomPreview() {
            const primary = document.getElementById('customPrimary').value;
            const secondary = document.getElementById('customSecondary').value;
            const accent = document.getElementById('customAccent').value;
            const preview = document.getElementById('colorPreview');
            
            preview.innerHTML = `
                <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${primary};">
                    Основен
                </div>
                <div style="padding: 30px; border-radius: 12px; text-align: center; color: white; font-weight: bold; background: ${secondary};">
                    Вторичен
                </div>
                <div style="padding: 30px; border-radius: 12px; text-align: center; font-weight: bold; color: white; background: ${accent};">
                    Акцент
                </div>
            `;
        }

        async function saveColorScheme() {
            const scheme = document.getElementById('colorScheme').value;
            
            try {
                if (scheme === 'custom') {
                    // Save custom colors
                    const customColors = {
                        primary: document.getElementById('customPrimary').value,
                        secondary: document.getElementById('customSecondary').value,
                        tertiary: document.getElementById('customAccent').value,
                        // Generate light version (slightly lighter) and dark version
                        primaryAccent: lightenColor(document.getElementById('customPrimary').value, 20),
                        soft: lightenColor(document.getElementById('customPrimary').value, 80)
                    };
                    localStorage.setItem('customColors', JSON.stringify(customColors));
                    localStorage.setItem('colorScheme', scheme);
                    showSuccess('Персонализираната цветова схема е запазена успешно!');
                } else {
                    localStorage.setItem('colorScheme', scheme);
                    showSuccess(`Цветовата схема "${colorSchemes[scheme].name}" е запазена успешно!`);
                }
                
                // In a real implementation, this would save to the backend
                // await fetch('/api/admin/color-scheme', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ scheme })
                // });
            } catch (error) {
                showError('Грешка при запазване на цветовата схема: ' + error.message);
            }
        }
        
        // Helper function to lighten colors for soft backgrounds and light theme variants
        function lightenColor(hex, percent) {
            // Parse hex color to integer
            const num = parseInt(hex.replace('#', ''), 16);
            // Calculate amount to add (percent of 255)
            const amt = Math.round(2.55 * percent);
            // Extract RGB channels using bit shifting and add amount
            const R = (num >> 16) + amt;  // Red channel (bits 16-23)
            const G = (num >> 8 & 0x00FF) + amt;  // Green channel (bits 8-15)
            const B = (num & 0x0000FF) + amt;  // Blue channel (bits 0-7)
            // Clamp values to 0-255 range and reconstruct hex
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // Load saved color scheme
        function loadColorScheme() {
            const savedScheme = localStorage.getItem('colorScheme') || 'purple-pink';
            document.getElementById('colorScheme').value = savedScheme;
            previewColorScheme();
        }

        // Clear Cache
        function clearCache() {
            if (confirm('Сигурни ли сте, че искате да изчистите целия кеш? Това ще премахне всички запазени планове и данни.')) {
                // In production, call worker API to clear KV
                localStorage.clear();
                sessionStorage.setItem('adminLoggedIn', 'true'); // Keep logged in
                showSuccess('Кешът е изчистен успешно!');
            }
        }

        // View Logs
        function viewLogs() {
            alert('Преглед на логове ще бъде имплементиран в бъдеща версия.\nЗа текущи логове, проверете Cloudflare Dashboard.');
        }

        // --- Blacklist Management ---
        let currentBlacklist = [];

        // Load blacklist from KV storage
        async function loadBlacklist() {
            const container = document.getElementById('blacklistDisplay');
            try {
                const response = await fetch(WORKER_URL + '/api/admin/get-blacklist');
                if (!response.ok) {
                    throw new Error('Failed to load blacklist');
                }
                
                const result = await response.json();
                currentBlacklist = result.blacklist || [];
                displayBlacklist();
                showSuccess('Черният списък е зареден успешно!');
            } catch (error) {
                console.error('Error loading blacklist:', error);
                // Load from default hard bans
                currentBlacklist = [
                    'лук', 'onion', 
                    'пуешко месо', 'turkey meat',
                    'изкуствени подсладители', 'artificial sweeteners',
                    'мед', 'захар', 'конфитюр', 'сиропи', 
                    'honey', 'sugar', 'jam', 'syrups',
                    'кетчуп', 'майонеза', 'BBQ сос', 
                    'ketchup', 'mayonnaise', 'BBQ sauce',
                    'гръцко кисело мляко', 'greek yogurt'
                ];
                displayBlacklist();
                showError('Не може да се зареди черният списък. Показани са стандартните забранени храни.');
            }
        }

        // Display blacklist items
        function displayBlacklist() {
            const container = document.getElementById('blacklistDisplay');
            if (currentBlacklist.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Няма храни в черния списък.</p>';
                return;
            }

            const itemsHTML = currentBlacklist.map((item, index) => `
                <div style="display: inline-flex; align-items: center; background: var(--white); padding: 8px 12px; border-radius: 20px; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="color: var(--text-dark);">${escapeHtml(item)}</span>
                    <button onclick="removeFromBlacklist(${index})" style="background: none; border: none; color: var(--accent-light-red); cursor: pointer; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            container.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${itemsHTML}</div>`;
        }

        // Add item to blacklist
        async function addToBlacklist() {
            const input = document.getElementById('blacklistInput');
            const item = input.value.trim().toLowerCase();
            
            if (!item) {
                showError('Моля, въведете име на храна');
                return;
            }

            if (currentBlacklist.includes(item)) {
                showError('Тази храна вече е в черния списък');
                return;
            }

            try {
                const response = await fetch(WORKER_URL + '/api/admin/add-to-blacklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item: item })
                });

                if (!response.ok) {
                    throw new Error('Failed to add to blacklist');
                }

                const result = await response.json();
                currentBlacklist = result.blacklist || [...currentBlacklist, item];
                displayBlacklist();
                input.value = '';
                showSuccess(`"${item}" е добавена в черния списък!`);
            } catch (error) {
                console.error('Error adding to blacklist:', error);
                // Fallback to local update
                currentBlacklist.push(item);
                displayBlacklist();
                input.value = '';
                showSuccess(`"${item}" е добавена локално в черния списък!`);
            }
        }

        // Remove item from blacklist
        async function removeFromBlacklist(index) {
            const item = currentBlacklist[index];
            if (!confirm(`Сигурни ли сте, че искате да премахнете "${item}" от черния списък?`)) {
                return;
            }

            try {
                const response = await fetch(WORKER_URL + '/api/admin/remove-from-blacklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item: item })
                });

                if (!response.ok) {
                    throw new Error('Failed to remove from blacklist');
                }

                const result = await response.json();
                currentBlacklist = result.blacklist || currentBlacklist.filter((_, i) => i !== index);
                displayBlacklist();
                showSuccess(`"${item}" е премахната от черния списък!`);
            } catch (error) {
                console.error('Error removing from blacklist:', error);
                // Fallback to local update
                currentBlacklist.splice(index, 1);
                displayBlacklist();
                showSuccess(`"${item}" е премахната локално от черния списък!`);
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load Problem Reports
        async function loadReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Зареждане...</p>';
            
            try {
                const response = await fetch(WORKER_URL + '/api/admin/get-reports');
                if (!response.ok) {
                    throw new Error('Failed to load reports');
                }
                
                const result = await response.json();
                
                if (result.success && result.reports) {
                    if (result.reports.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">Няма доклади за показване.</p>';
                        return;
                    }
                    
                    // Display reports
                    let html = '';
                    result.reports.forEach(report => {
                        const date = new Date(report.timestamp);
                        const dateStr = date.toLocaleString('bg-BG');
                        
                        html += `
                            <div class="report-item">
                                <div class="report-header">
                                    <div class="report-user">
                                        <i class="fas fa-user-circle"></i>
                                        <span>${escapeHtml(report.userName)}</span>
                                        <span class="report-badge badge-${report.status || 'unread'}">${report.status === 'read' ? 'Прочетен' : 'Непрочетен'}</span>
                                    </div>
                                    <div class="report-time">
                                        <i class="fas fa-clock"></i> ${dateStr}
                                    </div>
                                </div>
                                <div class="report-message">
                                    ${escapeHtml(report.message)}
                                </div>
                                <div class="report-meta">
                                    <span><i class="fas fa-hashtag"></i> ID: ${report.id}</span>
                                    <span><i class="fas fa-id-badge"></i> User ID: ${escapeHtml(report.userId)}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    showSuccess(`Заредени ${result.reports.length} доклада`);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                container.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;"><i class="fas fa-exclamation-circle"></i> Грешка при зареждане на доклади</p>';
                showError('Грешка при зареждане на доклади: ' + error.message);
            }
        }

        // Load AI communication logs
        async function loadAILogs() {
            const container = document.getElementById('aiLogsContainer');
            const statsDiv = document.getElementById('aiLogsStats');
            
            // Parse and validate limit and offset
            let limit = parseInt(document.getElementById('logsLimit').value);
            let offset = parseInt(document.getElementById('logsOffset').value);
            
            // Validate and sanitize inputs
            if (isNaN(limit) || limit <= 0) {
                limit = 50;
                document.getElementById('logsLimit').value = 50;
            }
            if (isNaN(offset) || offset < 0) {
                offset = 0;
                document.getElementById('logsOffset').value = 0;
            }
            
            // Cap maximum limit to prevent excessive load
            if (limit > 200) {
                limit = 200;
                document.getElementById('logsLimit').value = 200;
            }
            
            container.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Зареждане...</p>';
            statsDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${WORKER_URL}/api/admin/get-ai-logs?limit=${limit}&offset=${offset}`);
                if (!response.ok) {
                    throw new Error('Failed to load AI logs');
                }
                
                const result = await response.json();
                
                if (result.success && result.logs) {
                    if (result.logs.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">Няма логове за показване.</p>';
                        return;
                    }
                    
                    // Calculate statistics - only count logs with responses for average duration
                    let totalInputTokens = 0;
                    let totalOutputTokens = 0;
                    let totalDuration = 0;
                    let logsWithResponses = 0;
                    let successCount = 0;
                    
                    result.logs.forEach(log => {
                        totalInputTokens += log.estimatedInputTokens || 0;
                        if (log.response) {
                            totalOutputTokens += log.response.estimatedOutputTokens || 0;
                            totalDuration += log.response.duration || 0;
                            logsWithResponses++;
                            if (log.response.success) successCount++;
                        }
                    });
                    
                    const avgDuration = logsWithResponses > 0 ? (totalDuration / logsWithResponses).toFixed(0) : 0;
                    
                    // Update statistics
                    document.getElementById('totalLogs').textContent = result.total;
                    document.getElementById('avgDuration').textContent = `${avgDuration} ms`;
                    document.getElementById('totalInputTokens').textContent = totalInputTokens.toLocaleString();
                    document.getElementById('totalOutputTokens').textContent = totalOutputTokens.toLocaleString();
                    statsDiv.style.display = 'block';
                    
                    // Display logs
                    let html = '';
                    result.logs.forEach(log => {
                        const requestDate = new Date(log.timestamp);
                        const requestDateStr = requestDate.toLocaleString('bg-BG');
                        
                        const hasResponse = log.response !== null && log.response !== undefined;
                        const statusColor = hasResponse && log.response.success ? '#27ae60' : '#e74c3c';
                        const statusIcon = hasResponse && log.response.success ? 'check-circle' : 'times-circle';
                        const statusText = hasResponse ? (log.response.success ? 'Успешен' : 'Грешка') : 'Без отговор';
                        
                        const stepNameBg = {
                            'step1_analysis': 'Стъпка 1: Анализ',
                            'step2_strategy': 'Стъпка 2: Стратегия',
                            'step3_meal_plan_full': 'Стъпка 3: Пълен План',
                            'step3_meal_plan_chunk_1': 'Стъпка 3: Блок 1',
                            'step3_meal_plan_chunk_2': 'Стъпка 3: Блок 2',
                            'step3_meal_plan_chunk_3': 'Стъпка 3: Блок 3',
                            'step3_meal_plan_chunk_4': 'Стъпка 3: Блок 4',
                            'step4_summary': 'Стъпка 4: Обобщение',
                            'chat_consultation': 'Чат: Консултация',
                            'plan_correction': 'Корекция на План',
                            'fallback_plan_generation': 'Резервен План'
                        }[log.stepName] || log.stepName;
                        
                        html += `
                            <div class="report-item" style="border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <strong style="font-size: 1.1rem; color: var(--text-dark);">
                                            <i class="fas fa-${statusIcon}" style="color: ${statusColor};"></i>
                                            ${stepNameBg}
                                        </strong>
                                        <div style="margin-top: 5px; color: var(--text-gray); font-size: 0.85rem;">
                                            <i class="fas fa-clock"></i> ${requestDateStr}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem;">
                                            ${statusText}
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--text-gray);">
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Провайдър / Модел</div>
                                        <div style="font-weight: 600;">${log.provider} / ${log.modelName}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Входни Токени</div>
                                        <div style="font-weight: 600; color: #3498db;">${log.estimatedInputTokens?.toLocaleString() || 0}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Изходни Токени</div>
                                        <div style="font-weight: 600; color: #e67e22;">${hasResponse ? (log.response.estimatedOutputTokens?.toLocaleString() || 0) : '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Време за Отговор</div>
                                        <div style="font-weight: 600; color: #9b59b6;">${hasResponse ? (log.response.duration + ' ms') : '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Дължина на Промпт</div>
                                        <div style="font-weight: 600;">${log.promptLength?.toLocaleString() || 0} chars</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-gray); margin-bottom: 3px;">Дължина на Отговор</div>
                                        <div style="font-weight: 600;">${hasResponse ? (log.response.responseLength?.toLocaleString() || 0) + ' chars' : '-'}</div>
                                    </div>
                                </div>
                                
                                ${hasResponse && log.response.error ? `
                                    <div style="margin-top: 15px; padding: 10px; background: #ffe6e6; border-radius: 8px; color: #e74c3c;">
                                        <strong><i class="fas fa-exclamation-triangle"></i> Грешка:</strong> ${escapeHtml(log.response.error)}
                                    </div>
                                ` : ''}
                                
                                <!-- Prompt Content Section -->
                                ${log.prompt ? `
                                    <details style="margin-top: 15px; padding: 10px; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--text-gray);">
                                        <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); padding: 5px;">
                                            <i class="fas fa-paper-plane"></i> Изпратен Промпт (${log.promptLength?.toLocaleString() || 0} chars)
                                        </summary>
                                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px;">
                                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.75rem;">
                                                <div><span style="display: inline-block; width: 12px; height: 12px; background: #3498db; border-radius: 2px; margin-right: 5px;"></span><strong>Син:</strong> Системни инструкции и правила</div>
                                                <div><span style="display: inline-block; width: 12px; height: 12px; background: #27ae60; border-radius: 2px; margin-right: 5px;"></span><strong>Зелен:</strong> Клиентски данни</div>
                                                <div><span style="display: inline-block; width: 12px; height: 12px; background: #e67e22; border-radius: 2px; margin-right: 5px;"></span><strong>Оранжев:</strong> Изчислени данни от бекенд</div>
                                                <div><span style="display: inline-block; width: 12px; height: 12px; background: #e91e63; border-radius: 2px; margin-right: 5px;"></span><strong>Розов:</strong> AI анализ от предходен етап</div>
                                            </div>
                                        </div>
                                        <pre style="margin-top: 10px; padding: 10px; background: var(--white); border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${colorCodePrompt(log.prompt)}</pre>
                                    </details>
                                ` : ''}
                                
                                <!-- Response Content Section -->
                                ${hasResponse && log.response.response ? `
                                    <details style="margin-top: 15px; padding: 10px; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--text-gray);">
                                        <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); padding: 5px;">
                                            <i class="fas fa-reply"></i> Получен Отговор (${log.response.responseLength?.toLocaleString() || 0} chars)
                                        </summary>
                                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px;">
                                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.75rem;">
                                                <div><span style="display: inline-block; width: 12px; height: 12px; background: #9b59b6; border-radius: 2px; margin-right: 5px;"></span><strong>Лилав:</strong> Анализирана информация от AI</div>
                                            </div>
                                        </div>
                                        <pre style="margin-top: 10px; padding: 10px; background: var(--white); border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${colorCodeResponse(log.response.response)}</pre>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Add pagination info
                    if (result.total > result.limit) {
                        const paginationInfo = document.createElement('div');
                        paginationInfo.style.textAlign = 'center';
                        paginationInfo.style.marginTop = '20px';
                        paginationInfo.style.color = 'var(--text-gray)';
                        const nextOffset = offset + limit;
                        const prevOffset = Math.max(0, offset - limit);
                        paginationInfo.innerHTML = `
                            <p>Показани ${result.logs.length} от ${result.total} логове</p>
                            ${nextOffset < result.total ? `
                                <button class="btn" onclick="document.getElementById('logsOffset').value = ${nextOffset}; loadAILogs();" style="margin-top: 10px;">
                                    <i class="fas fa-arrow-right"></i> Покажи Следващи
                                </button>
                            ` : ''}
                            ${offset > 0 ? `
                                <button class="btn" onclick="document.getElementById('logsOffset').value = ${prevOffset}; loadAILogs();" style="margin-top: 10px; margin-left: 10px;">
                                    <i class="fas fa-arrow-left"></i> Покажи Предишни
                                </button>
                            ` : ''}
                        `;
                        container.appendChild(paginationInfo);
                    }
                    
                    showSuccess(`Заредени ${result.logs.length} логове`);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading AI logs:', error);
                container.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;"><i class="fas fa-exclamation-circle"></i> Грешка при зареждане на логове</p>';
                showError('Грешка при зареждане на логове: ' + error.message);
            }
        }

        /**
         * Color-code AI prompt to distinguish:
         * 1. System instructions and rules (blue)
         * 2. Client data from user input (green)
         * 3. Backend calculated values (orange)
         * 4. AI analysis from previous step (pink)
         */
        function colorCodePrompt(prompt) {
            if (!prompt) return '';
            
            let html = '';
            const lines = prompt.split('\n');
            let currentSection = 'instruction'; // instruction, client_data, backend_data, ai_previous
            
            // Section header keywords
            const sectionKeywords = {
                client_data: ['КЛИЕНТСКИ ПРОФИЛ', 'CLIENT PROFILE', 'КЛИЕНТ:'],
                backend_data: ['ИЗЧИСЛЕНИ СТОЙНОСТИ', 'CALCULATED VALUES'],
                ai_previous: ['АНАЛИЗ (КОМПАКТЕН)', 'АНАЛИЗ (', 'ANALYSIS (', 'ПРЕДИШЕН АНАЛИЗ'],
                instruction: ['ТВОЯТА ЗАДАЧА', 'YOUR TASK', 'ФОРМАТ НА ОТГОВОР', 'RESPONSE FORMAT', 
                             'ПРЕДПОЧИТАНИЯ:', 'ВАЖНО:', 'КРИТИЧНО']
            };
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const escapedLine = escapeHtml(line);
                
                // Detect section boundaries - check if line starts with or contains section keywords
                let sectionChanged = false;
                
                // Check for client data section
                if (sectionKeywords.client_data.some(kw => line.includes(kw))) {
                    currentSection = 'client_data';
                    html += `<span style="color: #27ae60; font-weight: bold;">${escapedLine}</span>\n`;
                    sectionChanged = true;
                }
                // Check for backend data section (must have section marker ═══ or specific format)
                else if (sectionKeywords.backend_data.some(kw => line.includes(kw)) || 
                         (line.includes('Backend') && line.includes('═══'))) {
                    currentSection = 'backend_data';
                    html += `<span style="color: #e67e22; font-weight: bold;">${escapedLine}</span>\n`;
                    sectionChanged = true;
                }
                // Check for AI previous analysis section (must have specific markers)
                else if (sectionKeywords.ai_previous.some(kw => line.includes(kw))) {
                    currentSection = 'ai_previous';
                    html += `<span style="color: #e91e63; font-weight: bold;">${escapedLine}</span>\n`;
                    sectionChanged = true;
                }
                // Check for instruction section (keywords with colon or at start)
                else if (sectionKeywords.instruction.some(kw => line.includes(kw))) {
                    currentSection = 'instruction';
                    html += `<span style="color: #3498db; font-weight: bold;">${escapedLine}</span>\n`;
                    sectionChanged = true;
                }
                
                // If section didn't change, apply color for current section
                if (!sectionChanged) {
                    if (currentSection === 'instruction') {
                        html += `<span style="color: #3498db;">${escapedLine}</span>\n`;
                    } else if (currentSection === 'client_data') {
                        html += `<span style="color: #27ae60;">${escapedLine}</span>\n`;
                    } else if (currentSection === 'backend_data') {
                        html += `<span style="color: #e67e22;">${escapedLine}</span>\n`;
                    } else if (currentSection === 'ai_previous') {
                        html += `<span style="color: #e91e63;">${escapedLine}</span>\n`;
                    }
                }
            }
            
            return html;
        }
        
        /**
         * Color-code AI response (analyzed data from AI)
         * AI-generated content is shown in purple/magenta
         */
        function colorCodeResponse(response) {
            if (!response) return '';
            
            // AI response is all analyzed data, show in purple
            const escapedResponse = escapeHtml(response);
            return `<span style="color: #9b59b6;">${escapedResponse}</span>`;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper Functions
        function showSuccess(message) {
            const div = document.getElementById('successMessage');
            div.textContent = message;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            div.textContent = message;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        // Initialize
        checkAuth();
        loadColorScheme();

        // --- PWA Install Banner Functionality ---
        let deferredPrompt;
        
        // Constants
        const INSTALL_BANNER_DISMISS_DAYS = 7; // Number of days before showing banner again
        const MILLISECONDS_PER_DAY = 1000 * 60 * 60 * 24;
        const PWA_DEBUG = true; // Set to true for debugging PWA installation issues
        
        // Helper function to check if banner was recently dismissed
        function wasBannerRecentlyDismissed() {
            const dismissedTime = localStorage.getItem('installBannerDismissed');
            if (dismissedTime) {
                const daysSinceDismissed = (Date.now() - parseInt(dismissedTime)) / MILLISECONDS_PER_DAY;
                // Show again after configured number of days
                if (daysSinceDismissed < INSTALL_BANNER_DISMISS_DAYS) {
                    if (PWA_DEBUG) console.log('Install banner was recently dismissed');
                    return true;
                }
            }
            return false;
        }
        
        // Detect device type
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isChrome = /Chrome/i.test(navigator.userAgent) && !/Edg/i.test(navigator.userAgent);
        const isEdge = /Edg/i.test(navigator.userAgent);
        const isSafari = /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
        const isFirefox = /Firefox/i.test(navigator.userAgent);
        const isOpera = /OPR|Opera/i.test(navigator.userAgent);
        const isSamsung = /SamsungBrowser/i.test(navigator.userAgent);
        
        // Get browser name and icon for display
        function getBrowserInfo() {
            if (isChrome && isAndroid) return { name: 'Chrome', icon: 'fab fa-chrome' };
            if (isChrome && !isAndroid) return { name: 'Chrome', icon: 'fab fa-chrome' };
            if (isEdge) return { name: 'Edge', icon: 'fab fa-edge' };
            if (isSafari && isIOS) return { name: 'Safari', icon: 'fab fa-safari' };
            if (isSafari) return { name: 'Safari', icon: 'fab fa-safari' };
            if (isFirefox) return { name: 'Firefox', icon: 'fab fa-firefox' };
            if (isOpera) return { name: 'Opera', icon: 'fab fa-opera' };
            if (isSamsung) return { name: 'Samsung Internet', icon: 'fas fa-mobile-alt' };
            return { name: 'Browser', icon: 'fas fa-globe' };
        }
        
        // Update banner icon based on platform
        function updateBannerIcon() {
            const iconEl = document.getElementById('installBannerIcon');
            if (!iconEl) return;
            
            let iconClass = 'fas fa-mobile-alt';
            
            if (isAndroid) {
                iconClass = 'fab fa-android';
            } else if (isIOS) {
                iconClass = 'fab fa-apple';
            } else if (!isMobile) {
                iconClass = 'fas fa-desktop';
            }
            
            iconEl.innerHTML = `<i class="${iconClass}"></i>`;
        }
        
        // Update browser badge
        function updateBrowserBadge(showBrowser = true) {
            const browserBadge = document.getElementById('installBannerBrowser');
            const browserText = document.getElementById('installBannerBrowserText');
            
            if (browserBadge && browserText && showBrowser) {
                const browserInfo = getBrowserInfo();
                browserText.textContent = browserInfo.name;
                const iconEl = browserBadge.querySelector('i');
                if (iconEl) {
                    iconEl.className = browserInfo.icon;
                }
                browserBadge.style.display = 'inline-flex';
            } else if (browserBadge) {
                browserBadge.style.display = 'none';
            }
        }
        
        // Capture the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            if (PWA_DEBUG) console.log('beforeinstallprompt fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show the install banner only if not recently dismissed
            if (!wasBannerRecentlyDismissed()) {
                showInstallBanner();
                
                // Auto-trigger installation prompt after 3 seconds for better automatic experience
                // This ensures users don't miss the installation opportunity
                setTimeout(() => {
                    if (deferredPrompt && !isInStandaloneMode()) {
                        if (PWA_DEBUG) console.log('Auto-triggering install prompt after 3 seconds');
                        triggerInstallPrompt();
                    }
                }, 3000);
            }
        });

        // Show install banner
        function showInstallBanner() {
            if (PWA_DEBUG) console.log('Showing install banner');
            const installBanner = document.getElementById('installBanner');
            if (installBanner) {
                // Update banner text for automatic installation
                const titleEl = installBanner.querySelector('.install-banner-title');
                const textEl = installBanner.querySelector('.install-banner-text');
                
                if (titleEl) titleEl.textContent = '🎉 Готово за инсталация!';
                if (textEl) textEl.textContent = 'Приложението ще се инсталира автоматично след 3 секунди';
                
                installBanner.classList.add('show');
                if (PWA_DEBUG) console.log('Install banner displayed successfully');
            } else {
                if (PWA_DEBUG) console.error('Install banner element not found');
            }
        }
        
        // Show platform-specific install guidance if beforeinstallprompt doesn't fire
        function showPlatformInstallGuidance() {
            // Don't show if already dismissed recently
            if (wasBannerRecentlyDismissed()) return;
            
            // Don't show if already installed
            if (isInStandaloneMode()) return;
            
            const installBanner = document.getElementById('installBanner');
            if (!installBanner) return;
            
            // Update banner content based on platform
            const titleEl = document.getElementById('installBannerTitle');
            const textEl = document.getElementById('installBannerText');
            const installBtn = document.getElementById('installBtn');
            
            // Update icon and browser badge
            updateBannerIcon();
            updateBrowserBadge(true);
            
            if (!isMobile && (isChrome || isEdge)) {
                // Desktop Chrome/Edge - guide to address bar
                const browserName = isChrome ? 'Chrome' : 'Edge';
                if (titleEl) titleEl.textContent = `💻 Инсталирай в ${browserName}`;
                if (textEl) textEl.textContent = 'Потърси иконата за инсталация (⊕) в адресната лента';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i><span>Инструкции</span>';
                    installBtn.onclick = () => {
                        alert('За да инсталирате приложението:\n\n1. Потърсете иконата за инсталация (⊕ или ⬇) в адресната лента в горния десен ъгъл\n2. Кликнете върху нея и изберете "Инсталирай"\n3. Или отворете менюто на браузъра (⋮) и изберете "Инсталирай NutriPlan..."');
                    };
                }
                installBanner.classList.add('show');
            } else if (isIOS && isSafari) {
                // iOS Safari - guide to Share button
                if (titleEl) titleEl.textContent = '📱 Добави към iPhone/iPad';
                if (textEl) textEl.textContent = 'Натисни бутона Share (⬆️) и избери "Add to Home Screen" (Добави към начален екран)';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-share"></i><span>Виж как</span>';
                    installBtn.onclick = () => {
                        alert('За да добавите приложението към началния екран:\n\n1. Натиснете бутона Share/Споделяне (⬆️) в долната част на екрана\n2. Превъртете надолу и изберете "Add to Home Screen" (Добави към начален екран) (Добави към начален екран)\n3. Потвърдете, като натиснете "Add" (Добави)');
                    };
                }
                installBanner.classList.add('show');
            } else if (isAndroid && (isChrome || isEdge)) {
                // Android Chrome/Edge - fallback when beforeinstallprompt doesn't fire
                const browserName = isChrome ? 'Chrome' : 'Edge';
                if (titleEl) titleEl.textContent = `📱 Инсталирай в ${browserName}`;
                if (textEl) textEl.textContent = 'Натисни менюто (⋮) и избери "Инсталирай приложение"';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i><span>Инструкции</span>';
                    installBtn.onclick = () => {
                        alert('📱 Как да инсталирам на Android?\n\n✅ БЪРЗ НАЧИН:\n1. Отворете менюто на браузъра (⋮) в горния десен ъгъл\n2. Изберете "Инсталирай приложение" или "Добави към начален екран"\n3. Натиснете "Инсталирай" в диалога\n\n✅ АЛТЕРНАТИВА:\n• Потърсете иконата (⊕) в адресната лента\n• Кликнете и изберете "Инсталирай"\n\n💡 ВАЖНО: Ако не виждате опцията веднага:\n• Презаредете страницата (F5)\n• Изчакайте 2-3 секунди\n• Кликнете на някой бутон на страницата');
                    };
                }
                installBanner.classList.add('show');
            } else if (isSamsung && isAndroid) {
                // Samsung Internet on Android
                if (titleEl) titleEl.textContent = '📱 Инсталирай в Samsung Internet';
                if (textEl) textEl.textContent = 'Натисни менюто и избери "Добави към начален екран"';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i><span>Инструкции</span>';
                    installBtn.onclick = () => {
                        alert('За да добавите приложението към началния екран:\n\n1. Отворете менюто на браузъра (обикновено в горната част)\n2. Потърсете опцията "Добави към начален екран" или подобна\n3. Потвърдете действието');
                    };
                }
                installBanner.classList.add('show');
            } else if (isFirefox && isAndroid) {
                // Firefox on Android
                if (titleEl) titleEl.textContent = '📱 Инсталирай в Firefox';
                if (textEl) textEl.textContent = 'Натисни менюто (⋮) и избери "Инсталирай"';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i><span>Инструкции</span>';
                    installBtn.onclick = () => {
                        alert('За да добавите приложението към началния екран:\n\n1. Отворете менюто на браузъра (обикновено в горната част)\n2. Потърсете опцията "Добави към начален екран" или подобна\n3. Потвърдете действието');
                    };
                }
                installBanner.classList.add('show');
            } else if (isMobile) {
                // Other mobile browsers - generic guidance
                if (titleEl) titleEl.textContent = '📱 Добави към начален екран';
                if (textEl) textEl.textContent = 'Отвори менюто на браузъра и избери "Добави към начален екран"';
                if (installBtn) {
                    installBtn.innerHTML = '<i class="fas fa-info-circle"></i><span>Инструкции</span>';
                    installBtn.onclick = () => {
                        alert('За да добавите приложението към началния екран:\n\n1. Отворете менюто на браузъра (обикновено в горната част)\n2. Потърсете опцията "Добави към начален екран" или подобна\n3. Потвърдете действието');
                    };
                }
                installBanner.classList.add('show');
            }
        }

        // Hide install banner
        function hideInstallBanner() {
            const installBanner = document.getElementById('installBanner');
            if (installBanner) {
                installBanner.classList.remove('show');
            }
        }
        
        // Trigger install prompt (reusable function)
        async function triggerInstallPrompt() {
            if (!deferredPrompt) {
                if (PWA_DEBUG) console.log('No deferred prompt available');
                return false;
            }
            
            try {
                // Show the install prompt
                if (PWA_DEBUG) console.log('Triggering install prompt');
                deferredPrompt.prompt();
                
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                if (PWA_DEBUG) console.log(`User response to the install prompt: ${outcome}`);
                
                // Hide the banner
                hideInstallBanner();
                
                // Clear the deferred prompt
                deferredPrompt = null;
                
                return outcome === 'accepted';
            } catch (error) {
                if (PWA_DEBUG) console.error('Error triggering install prompt:', error);
                return false;
            }
        }

        // iOS Install Banner Functions
        function showIosInstallBanner() {
            const hasDismissed = localStorage.getItem('ios_install_dismissed');

            if (isIOS && !isInStandaloneMode() && !hasDismissed) {
                const iosBanner = document.getElementById('ios-banner');
                const shareIconImg = document.getElementById('ios-share-icon-img');
                
                if (iosBanner) {
                    // Set the share icon SVG
                    if (shareIconImg) {
                        shareIconImg.src = getShareIconSvg();
                    }
                    iosBanner.style.display = 'block';
                    if (PWA_DEBUG) console.log('iOS install banner shown');
                }
            }
        }

        // Function to dismiss iOS banner
        function dismissIosBanner() {
            localStorage.setItem('ios_install_dismissed', 'true');
            const iosBanner = document.getElementById('ios-banner');
            if (iosBanner) {
                iosBanner.style.display = 'none';
            }
            if (PWA_DEBUG) console.log('iOS install banner dismissed');
        }

        // Initialize iOS banner after a delay
        if (isIOS && isSafari) {
            setTimeout(() => {
                showIosInstallBanner();
            }, 3000); // Show after 3 seconds on iOS
        }

        // Handle install button click
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                await triggerInstallPrompt();
            });
        }

        // Handle dismiss button click
        const dismissInstallBtn = document.getElementById('dismissInstallBtn');
        if (dismissInstallBtn) {
            dismissInstallBtn.addEventListener('click', () => {
                hideInstallBanner();
                
                // Store dismissal in localStorage (to not show again for 7 days)
                localStorage.setItem('installBannerDismissed', Date.now().toString());
            });
        }

        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            if (PWA_DEBUG) console.log('PWA was installed');
            hideInstallBanner();
            deferredPrompt = null;
        });
        
        // Don't show fallback guidance - only show banner when beforeinstallprompt fires
        // This ensures automatic installation prompt instead of manual instructions
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Only log for debugging - don't show manual instructions
                if (!deferredPrompt && !isInStandaloneMode()) {
                    if (PWA_DEBUG) {
                        console.log('beforeinstallprompt has not fired after 2 seconds');
                        console.log('Waiting for automatic prompt - no manual instructions shown');
                    }
                }
            }, 2000);
            
            // For Android Chrome/Edge: Re-check after user engagement
            if (isAndroid && (isChrome || isEdge)) {
                let engagementStartTime = Date.now();
                let hasInteracted = false;
                
                // Track user interaction
                const interactionEvents = ['click', 'touchstart', 'scroll', 'keydown'];
                const markInteraction = () => {
                    if (!hasInteracted) {
                        hasInteracted = true;
                        if (PWA_DEBUG) console.log('User interaction detected, starting engagement timer');
                    }
                };
                
                interactionEvents.forEach(event => {
                    document.addEventListener(event, markInteraction, { once: true, passive: true });
                });
                
                // Check again after 32 seconds if user has interacted
                setTimeout(() => {
                    if (hasInteracted && !deferredPrompt && !isInStandaloneMode()) {
                        const elapsedTime = Math.floor((Date.now() - engagementStartTime) / 1000);
                        if (PWA_DEBUG) {
                            console.log(`%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'color: #3b82f6');
                            console.log('%c🔄 Re-checking PWA Installability', 'color: #3b82f6; font-weight: bold');
                            console.log(`%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'color: #3b82f6');
                            console.log(`User has been engaged for ${elapsedTime} seconds`);
                            console.log(`beforeinstallprompt still has not fired`);
                            console.log('Waiting for automatic prompt - app may already be installed or PWA criteria not met');
                            console.log(`%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'color: #3b82f6');
                        }
                        // Don't show manual instructions - wait for automatic prompt only
                    }
                }, 32000); // Check after 32 seconds (30s requirement + 2s buffer)
            }
        });

        // Debug: Check PWA installability after page load
        if (PWA_DEBUG) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    // Detect device type
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    const isChrome = /Chrome/i.test(navigator.userAgent) && !/Edg/i.test(navigator.userAgent);
                    const isEdge = /Edg/i.test(navigator.userAgent);
                    
                    if (!deferredPrompt) {
                        console.log('PWA Debug: beforeinstallprompt has not fired yet');
                        console.log('PWA Debug: Checking installability criteria:');
                        console.log('- Service Worker:', 'serviceWorker' in navigator ? 'Supported' : 'Not supported');
                        console.log('- HTTPS:', location.protocol === 'https:' ? 'Yes' : 'No');
                        console.log('- Manifest link:', document.querySelector('link[rel="manifest"]') ? 'Found' : 'Missing');
                        console.log('- Platform:', isMobile ? 'Mobile' : 'Desktop');
                        console.log('- Browser:', isChrome ? 'Chrome' : (isEdge ? 'Edge' : 'Other'));
                        
                        // Check if already installed
                        if (isInStandaloneMode()) {
                            console.log('- Already installed: Yes (running as standalone app)');
                        } else {
                            console.log('- Already installed: No');
                            
                            // Different explanations for desktop vs mobile
                            if (!isMobile && (isChrome || isEdge)) {
                                console.log('%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'color: #10b981');
                                console.log('%c✓ PWA IS INSTALLABLE!', 'color: #10b981; font-weight: bold; font-size: 14px');
                                console.log('%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'color: #10b981');
                                console.log('%cINFO: On Desktop Chrome/Edge, the beforeinstallprompt event often does NOT fire.', 'color: #3b82f6; font-weight: bold');
                                console.log('%cInstead, Chrome shows an INSTALL ICON in the address bar (omnibox).', 'color: #3b82f6; font-weight: bold');
                                console.log('');
                                console.log('%cTo install this app:', 'font-weight: bold');
                                console.log('  1. Look for the install icon (⊕ or ⬇) in the address bar on the right side');
                                console.log('  2. Click the icon to install the app');
                                console.log('  3. Or open Chrome menu (⋮) → "Install NutriPlan..."');
                                console.log('');
                                console.log('%cFor automatic install prompts, test on Android Chrome/Edge.', 'color: #f59e0b');
                                console.log('%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'color: #10b981');
                            } else if (isAndroid && (isChrome || isEdge)) {
                                console.log('- Possible reasons why event has not fired:');
                                console.log('  1. User engagement criteria not met (needs 30+ seconds + interaction)');
                                console.log('  2. Manifest.json not valid or not accessible');
                                console.log('  3. Icons not loading properly');
                                console.log('  4. Service worker not registered successfully');
                                console.log('  5. PWA criteria not fully met');
                            } else {
                                console.log('- Note: beforeinstallprompt is only supported on Chrome/Edge (mainly Android)');
                                console.log('- For other browsers, users can install manually via browser menu');
                            }
                        }
                    } else {
                        console.log('%c✅ PWA Debug: beforeinstallprompt fired successfully!', 'color: #10b981; font-weight: bold');
                        console.log('PWA is ready for installation with custom install prompt.');
                    }
                }, 3000);
            });
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // --- PWA Helper Functions ---
        // Check if app is running in standalone mode
        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   (('standalone' in window.navigator) && (window.navigator.standalone));
        }

        // Get SVG data URL for iOS share icon
        function getShareIconSvg() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M18 16v2H6v-2H4v4h16v-4zM12 4l-5 5h3v6h4v-6h3z'/%3E%3C/svg%3E";
        }
    </script>
</body>
</html>
