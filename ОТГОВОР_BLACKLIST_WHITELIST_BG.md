# Отговор на въпроса: "взема ли се предвид blacklist и whitelist?"

## ДА! ✅ Blacklist и whitelist СЕ ВЗЕМАТ ПРЕДВИД!

---

## Какво открих и поправих

### Проблем
Макар че имаше admin endpoints за управление на blacklist, **динамичният blacklist от KV storage НЕ се извличаше** и НЕ се включваше в AI промптовете при генериране на хранителни планове.

### Решение
Внедрих система за сливане на хардкодирания blacklist с динамичния от KV storage.

---

## Как работи сега

### 1. BLACKLIST (Черен списък - забранени храни)

#### A) Хардкодиран blacklist (ADLE_V8_HARD_BANS)
**Винаги забранени:**
- Лук
- Пуешко месо (не шунка)
- Изкуствени подсладители
- Мед, захар, конфитюр, сиропи
- Кетчуп, майонеза, BBQ сос
- Гръцко кисело мляко (само обикновено)

**Характеристики:**
- ✅ Не може да се променят от потребители
- ✅ Базирани на медицински/хранителни причини
- ✅ Проверяват се от валидацията

#### B) Динамичен blacklist (от KV storage)
**Управление:** Чрез admin endpoints
- `GET /api/admin/get-blacklist` - Извлича blacklist
- `POST /api/admin/add-to-blacklist` - Добавя храна
- `POST /api/admin/remove-from-blacklist` - Премахва храна

**Характеристики:**
- ✅ Може да се променя от администратор
- ✅ Съхранява се в KV Storage
- ✅ Сега СЕ ИЗПОЛЗВА в AI промптовете! (това беше поправено)

#### C) Merged Blacklist (Обединен списък)
**Нова функция:** `getMergedBlacklist(env)`

**Как работи:**
1. Извлича динамичния blacklist от KV storage
2. Слива го с хардкодирания ADLE_V8_HARD_BANS
3. Премахва дубликати
4. Подава обединения списък към AI

**Резултат:**
```
AI промпт сега съдържа:
0) HARD BANS (strictly forbidden): лук, onion, пуешко месо, turkey meat, 
изкуствени подсладители, мед, захар, кетчуп, майонеза, гръцко кисело мляко, 
[+ ВСИЧКИ ДОБАВЕНИ ОТ АДМИНИСТРАТОРА]
```

---

### 2. WHITELIST (Бял списък - разрешени храни)

#### A) Protein Whitelist
**Разрешени протеини:**
- Яйца, пилешко, говеждо, постно свинско, риба
- Кисело мляко (обикновено), извара, сирене
- Боб, леща, нахут, грах

**ЗАБРАНЕНИ протеини:**
- Пуешко месо (HARD BAN)
- Заешко, патешко, гъска, агнешко, дивеч (НЕ са в whitelist)

#### B) Правило R12: Извън whitelist с обосновка
**Протеини извън whitelist** могат да се използват САМО ако:
- Обективно необходими (MODE/medical/availability)
- Mainstream/универсални
- Налични в България
- С добавен ред: `Reason: ...`

**Пример:**
```
"Заешко месо 150g със зеленчуци
Reason: Клиентът е алергичен към пилешко и говеждо"
```

#### C) Други whitelists
- **Vegetables:** домати, краставици, чушки, зеле, моркови, маруля, спанак, тиквички, гъби, броколи, карфиол
- **Energy:** овесени ядки, ориз, картофи, паста, булгур (НЕ царевица!)
- **Fat:** зехтин, масло (умерено), ядки/семена (умерено)

---

## Технически детайли на промените

### Променен файл: worker.js

#### 1. Добавена нова функция (ред ~1096):
```javascript
async function getMergedBlacklist(env) {
  // Извлича динамичен blacklist от KV
  // Слива с хардкодирания
  // Връща обединен списък
}
```

#### 2. Обновен generateMealPlanChunkPrompt() (ред ~2341):
```javascript
// ПРЕДИ:
0) HARD BANS: onions, turkey, sweeteners, honey/sugar/jam/syrups, ...

// СЕГА:
const mergedBlacklist = await getMergedBlacklist(env);
0) HARD BANS: ${mergedBlacklist.join(', ')}
```

#### 3. Обновен generateMealPlanPrompt() (legacy, ред ~2625):
```javascript
// Направена async функция
// Използва getMergedBlacklist()
// Инжектира merged blacklist в промпт
```

---

## Как да тествам

### 1. Добави тестова храна в blacklist
```bash
curl -X POST https://yourdomain.com/api/admin/add-to-blacklist \
  -H "Content-Type: application/json" \
  -d '{"item": "ананас"}'
```

### 2. Генерирай хранителен план

### 3. Провери в логовете
```
Merged blacklist: 14 hard bans + 1 dynamic = 15 total
```

### 4. Провери че AI НЕ използва тази храна

### 5. Премахни тестовата храна
```bash
curl -X POST https://yourdomain.com/api/admin/remove-from-blacklist \
  -H "Content-Type: application/json" \
  -d '{"item": "ананас"}'
```

---

## Известни ограничения

### ⚠️ Валидацията не проверява динамичен blacklist

**Защо:**
- `validatePlan()` е синхронна функция
- Няма достъп до env (KV storage)
- Проверява само хардкодирания ADLE_V8_HARD_BANS

**Последици:**
- Храни от динамичния blacklist могат да минат валидацията
- AI няма да ги използва (защото са в промпта) ✅
- Но ако някой ръчно създаде план, валидацията няма да ги хване ⚠️

**Решение:**
- Отделна задача за рефакторинг на validatePlan()
- Трябва да стане async и да получава env

---

## Документация

Създадени 2 нови документа с пълна документация:

1. **BLACKLIST_WHITELIST_СИСТЕМА_BG.md** (на български)
   - Цялостно обяснение на системата
   - Как работи blacklist/whitelist
   - Как да използвам admin endpoints
   - Известни ограничения
   - Процедури за тестване

2. **BLACKLIST_WHITELIST_SYSTEM_EN.md** (на английски)
   - Техническо резюме
   - Детайли за интеграцията

---

## Резюме

### Какво работи ✅

1. ✅ Хардкодиран blacklist (ADLE_V8_HARD_BANS)
2. ✅ Динамичен blacklist в KV storage (food_blacklist)
3. ✅ getMergedBlacklist() слива двата списъка
4. ✅ Merged blacklist се използва в AI промптовете
5. ✅ Protein whitelist (ADLE_V8_PROTEIN_WHITELIST)
6. ✅ R12 правило за non-whitelist с Reason:
7. ✅ Admin endpoints за управление на blacklist
8. ✅ Валидация проверява хардкодирания blacklist

### Какво не работи напълно ⚠️

1. ⚠️ Валидацията НЕ проверява динамичния blacklist
   - Причина: validatePlan() е sync и няма достъп до env
   - Решение: Рефакторинг в бъдеща задача
   - **Въздействие:** Минимално - AI не използва забранени храни

---

## Заключение

**ОТГОВОР НА ВЪПРОСА:**

# ДА! ✅ Blacklist и whitelist СЕ ВЗЕМАТ ПРЕДВИД!

**Как именно:**

1. **Blacklist** се слива от две места (хардкодиран + KV storage)
2. **Merged blacklist** се подава към AI в промптовете
3. **AI не използва** забранени храни
4. **Whitelist** определя разрешени храни по категории
5. **Non-whitelist** храни изискват Reason: обосновка
6. **Валидацията** проверява (частично) спазването на правилата

**Сега е внедрено:** ✅  
**Дата:** 2026-02-05  

---

*Този файл отговаря на въпроса и обяснява как blacklist/whitelist системата работи в AI Diet приложението.*
