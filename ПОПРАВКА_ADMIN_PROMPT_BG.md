# Поправка на Admin Panel - viewDefaultPrompt Функционалност

## Какъв беше проблемът?

В админ панела, при кликване на бутона "Виж Стандартен Промпт", се показваха **захардкодени промпти от admin.html** вместо **действителните default промпти от worker.js**. Това създаваше объркване, защото:

1. Показваните "стандартни" промпти не съответстваха на това, което системата реално използва
2. Потребителите не можеха да видят реалните default промпти от worker.js
3. Захардкодените промпти в admin.html бяха остарели и различни от тези в worker.js

## Какво беше направено?

### 1. Нов API endpoint в worker.js

**Маршрут:** `/api/admin/get-default-prompt`  
**Метод:** GET  
**Параметър:** `type` (един от: analysis, strategy, meal_plan, summary, consultation, modification)

Този endpoint връща **точните default промпти**, които системата използва когато няма запазен custom промпт в KV storage.

**Пример заявка:**
```
GET /api/admin/get-default-prompt?type=analysis
```

**Пример отговор:**
```json
{
  "success": true,
  "prompt": "Expert nutritional analysis. Calculate BMR, TDEE, target kcal, macros..."
}
```

### 2. Актуализирана функция viewDefaultPrompt в admin.html

**Преди:**
- Използваше захардкодени константи от admin.html
- Показваше остарели промпти

**След:**
- Извършва async заявка към новия API endpoint
- Показва актуалните промпти от worker.js
- Потребителят вижда точно това, което системата използва

## Какви са ползите?

✅ **Точност** - Админите виждат реалните default промпти на системата  
✅ **Консистентност** - Няма повече объркване между admin.html константи и worker.js defaults  
✅ **Поддръжка** - Default промптите са дефинирани само на едно място (worker.js)  
✅ **Прозрачност** - Пълна видимост какво използва системата  

## Как работи сега?

### Преглед на Default Промпти

1. Потребителят кликва на "Виж Стандартен Промпт" в админ панела
2. Админ панелът извиква `viewDefaultPrompt(promptType, elementId)`
3. Функцията прави async GET заявка към `/api/admin/get-default-prompt?type={promptType}`
4. Worker.js връща актуалния default промпт от кода
5. Промптът се зарежда в textarea за преглед/редакция

### Редакция и Запазване на Custom Промпти

Функционалността за редакция и запазване остава непроменена:

1. Потребителят редактира промпта в textarea
2. Потребителят кликва "Запази Промпт"
3. Админ панелът извиква съществуващата save функция
4. Custom промптът се запазва в Cloudflare KV storage
5. Системата използва custom промпта за всички бъдещи генерации

### Възстановяване на Default Промпти

Функционалността за reset остава непроменена:

1. Потребителят кликва "Възстанови по подразбиране"
2. Админ панелът запазва празен стринг в KV storage
3. Системата автоматично се връща към default промпта от worker.js

## Поддържани типове промпти

| Тип | Описание | Използва се в |
|-----|----------|---------------|
| `analysis` | Здравен анализ и изчисления на калории | Стъпка 1 от генерирането на план |
| `strategy` | Диетична стратегия и препоръки за добавки | Стъпка 2 от генерирането на план |
| `meal_plan` | Генериране на индивидуални ястия (2 дни на chunk) | Стъпки 3-6 от генерирането на план |
| `summary` | Седмично резюме, съвети и препоръки | Финална стъпка от генерирането на план |
| `consultation` | Чат режим за въпроси (само четене) | Режим на консултация в чата |
| `modification` | Чат режим за промени на плана | Режим на модификация в чата |

## Тестване

### Автоматизирани тестове
- ✅ Валидация на JavaScript синтаксис
- ✅ Стартиране на Wrangler dev сървър
- ✅ Проверка на логиката за търсене на промпти
- ✅ CodeQL security scan - без уязвимости

### Ръчно тестване (необходимо след deployment)
1. Отворете админ панела
2. За всеки тип промпт (analysis, strategy, meal_plan, summary, consultation, modification):
   - Кликнете "Виж Стандартен Промпт"
   - Проверете, че се показва коректният default промпт от worker.js
   - Редактирайте промпта и го запазете
   - Презаредете страницата и проверете, че custom промптът се зарежда
   - Кликнете "Възстанови по подразбиране" за reset
   - Проверете, че системата се връща към default промпта

## Технически детайли

### Модифицирани файлове

1. **worker.js**
   - Добавен маршрут: `/api/admin/get-default-prompt` (line 414)
   - Добавена функция: `handleGetDefaultPrompt()` (lines 4177-4528)
   - Връща 6 типа default промпти

2. **admin.html**
   - Актуализирана функция: `viewDefaultPrompt()` (lines 2137-2156)
   - Променена от sync в async
   - Сега използва API вместо hardcoded константи

3. **ADMIN_PROMPT_FIX_DOCUMENTATION.md**
   - Пълна документация на английски език
   - API reference
   - Тестови инструкции

## Забележки

- Старите `DEFAULT_*_PROMPT` константи в admin.html все още присъстват за обратна съвместимост с legacy features
- Тези константи вече не се използват от основните prompt редактори
- Новият API endpoint обслужва само 6-те основни типа промпти използвани от текущата система
- Custom промптите съхранени в KV storage имат приоритет над default промптите

## Безопасност

✅ **CodeQL Security Scan: Без уязвимости**
- Няма открити security проблеми
- Правилна валидация на входните параметри
- Добро error handling за всички сценарии
- Няма излагане на чувствителни данни

## Следващи стъпки

За пълно тестване на функционалността:

1. **Deploy промените** на Cloudflare Workers
2. **Отворете админ панела** от браузър
3. **Тествайте всички бутони** "Виж Стандартен Промпт"
4. **Проверете** дали се показват коректните промпти от worker.js
5. **Тествайте редакцията** и запазването на custom промпти
6. **Тествайте reset** функционалността

## Поддръжка

При промяна на default промпти в бъдеще:

1. Променете промпта в съответната функция в **worker.js**
2. Актуализирайте същия промпт в **handleGetDefaultPrompt()** функцията
3. Двете трябва да са винаги синхронизирани

## Контакт

За въпроси или проблеми, моля създайте issue в GitHub repository.
