# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ worker.js - –ü—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ Code Bloat

**–î–∞—Ç–∞:** 13 –§–µ–≤—Ä—É–∞—Ä–∏ 2026  
**–ü—Ä–æ–±–ª–µ–º:** worker.js –±–µ—à–µ —Å—Ç–∞–Ω–∞–ª –ø—Ä–µ–∫–∞–ª–µ–Ω–æ –≥–æ–ª—è–º —Å –¥—É–±–ª–∏—Ä–∞–Ω –∫–æ–¥

## üîç –ü—Ä–æ–±–ª–µ–º

–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∑–∞–¥–∞–¥–µ –≤–∞–∂–µ–Ω –≤—ä–ø—Ä–æ—Å:
> "–∑–∞—â–æ –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞—à –¥–∞ –≤–¥–∏–≥–∞—à –æ–±–µ–º–∞ –Ω–∞ worker.js? –≤—Å–µ–∫–∏ –ø—ä—Ç, –∫–æ–≥–∞—Ç–æ —Å–µ –ø–æ—è–≤–∏ –≥—Ä–µ—à–∫–∞, —Ç–∏ –Ω–µ —è –æ–ø—Ä–∞–≤—è—à, –∞ –¥–æ–±–∞–≤—è—à –æ—â–µ –∏ –æ—â–µ –∫–æ–¥ –∏ –Ω–µ –∑–Ω–∞–º –¥–∞–ª–∏ –≤ –º–æ–º–µ–Ω—Ç–∞ worker.js –Ω–µ –µ bloating –æ–≥—Ä–æ–º–µ–Ω —Å —Ç–æ–Ω–æ–≤–µ –∏–∑–ª–∏—à–µ–Ω –∫–æ–¥"

**–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞:**
- worker.js –±–µ—à–µ –¥–æ—Å—Ç–∏–≥–Ω–∞–ª **7,419 —Ä–µ–¥–∞**
- –§—É–Ω–∫—Ü–∏—è—Ç–∞ `getDefaultPromptTemplates()` —Å—ä–¥—ä—Ä–∂–∞—à–µ **760 —Ä–µ–¥–∞ embedded –ø—Ä–æ–º–ø—Ç–∏**
- –¢–µ–∑–∏ –ø—Ä–æ–º–ø—Ç–∏ –î–£–ë–õ–ò–†–ê–•–ê —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ KV/prompts/*.txt —Ñ–∞–π–ª–æ–≤–µ—Ç–µ
- –ò–º–∞—à–µ 2 —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ token estimation —Å –¥—É–±–ª–∏—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç getDefaultPromptTemplates() (-760 —Ä–µ–¥–∞)

**–ü—Ä–µ–¥–∏:**
```javascript
function getDefaultPromptTemplates() {
  return {
    analysis: `–¢–∏ —Å–∏ –µ–∫—Å–ø–µ—Ä—Ç–µ–Ω –∫–ª–∏–Ω–∏—á–µ–Ω –¥–∏–µ—Ç–æ–ª–æ–≥... (270 —Ä–µ–¥–∞)`,
    strategy: `–ë–∞–∑–∏—Ä–∞–π–∫–∏ —Å–µ –Ω–∞ –∑–¥—Ä–∞–≤–æ—Å–ª–æ–≤–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª... (141 —Ä–µ–¥–∞)`,
    meal_plan: `–¢–∏ –¥–µ–π—Å—Ç–≤–∞—à –∫–∞—Ç–æ Advanced Dietary Logic... (84 —Ä–µ–¥–∞)`,
    summary: `Summary –∑–∞ 7-–¥–Ω–µ–≤–µ–Ω –ø–ª–∞–Ω... (23 —Ä–µ–¥–∞)`,
    consultation: `–¢–ï–ö–£–© –†–ï–ñ–ò–ú: –ö–û–ù–°–£–õ–¢–ê–¶–ò–Ø... (14 —Ä–µ–¥–∞)`,
    modification: `–¢–ï–ö–£–© –†–ï–ñ–ò–ú: –ü–†–û–ú–Ø–ù–ê... (80 —Ä–µ–¥–∞)`,
    correction: `–¢–∏ —Å–∏ –µ–∫—Å–ø–µ—Ä—Ç–µ–Ω –¥–∏–µ—Ç–æ–ª–æ–≥... (82 —Ä–µ–¥–∞)`
  };
}
```

**–°–ª–µ–¥:**
```javascript
// –§—É–Ω–∫—Ü–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞ –Ω–∞–ø—ä–ª–Ω–æ!
// –ü—Ä–æ–º–ø—Ç–∏—Ç–µ —Å–µ —á–µ—Ç–∞—Ç –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç KV storage
```

### 2. –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω handleGetDefaultPrompt()

**–ü—Ä–µ–¥–∏:**
```javascript
const defaultPrompts = getDefaultPromptTemplates();
const prompt = defaultPrompts[type];
return jsonResponse({ success: true, prompt: prompt });
```

**–°–ª–µ–¥:**
```javascript
// –ß–µ—Ç–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç KV storage
const kvKey = promptKeyMap[type]; // –Ω–∞–ø—Ä. 'admin_analysis_prompt'
let prompt = await env.page_content.get(kvKey);

if (!prompt) {
  return jsonResponse({ 
    error: `Prompt not found. Please upload prompts using ./KV/upload-kv-keys.sh`,
    hint: `Missing key: ${kvKey}`
  }, 404);
}

return jsonResponse({ success: true, prompt: prompt });
```

### 3. –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–∞ –¥—É–±–ª–∏—Ä–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ token estimation (-3 —Ä–µ–¥–∞)

**–ü—Ä–µ–¥–∏:**
```javascript
function estimateTokens(text) {
  return Math.ceil(text.length / 4);
}

function estimateTokenCount(text) {
  // –ü–æ-—Å–ª–æ–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å Cyrillic detection
  const cyrillicRatio = cyrillicChars / totalChars;
  const charsPerToken = 4 - (cyrillicRatio * 1);
  return Math.ceil(totalChars / charsPerToken);
}
```

**–°–ª–µ–¥:**
```javascript
// –°–∞–º–æ –µ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è
function estimateTokenCount(text) {
  // –ü–æ-—Å–ª–æ–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å Cyrillic detection
  const cyrillicRatio = cyrillicChars / totalChars;
  const charsPerToken = 4 - (cyrillicRatio * 1);
  return Math.ceil(totalChars / charsPerToken);
}
```

## üìä –†–µ–∑—É–ª—Ç–∞—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ü—Ä–µ–¥–∏ | –°–ª–µ–¥ | –†–∞–∑–ª–∏–∫–∞ |
|---------|-------|------|---------|
| **–û–±—â–æ —Ä–µ–¥–æ–≤–µ** | 7,419 | 6,657 | **-762 (-10.3%)** |
| **getDefaultPromptTemplates()** | 760 —Ä–µ–¥–∞ | –ü–†–ï–ú–ê–•–ù–ê–¢ | **-760** |
| **Token estimation** | 2 —Ñ—É–Ω–∫—Ü–∏–∏ | 1 —Ñ—É–Ω–∫—Ü–∏—è | **-3** |
| **–°–∏–Ω—Ç–∞–∫—Å–∏—Å** | ‚úÖ –í–∞–ª–∏–¥–µ–Ω | ‚úÖ –í–∞–ª–∏–¥–µ–Ω | ‚úÖ |

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞ –ü—Ä–æ–º—è–Ω–∞

### –ü—Ä–µ–¥–∏ (–î—É–±–ª–∏—Ä–∞–Ω–µ)
```
KV/prompts/*.txt (694 —Ä–µ–¥–∞ –ø—Ä–æ–º–ø—Ç–∏)
       ‚Üì
   upload to KV Storage
       ‚Üì
worker.js getDefaultPromptTemplates() (760 —Ä–µ–¥–∞ –î–£–ë–õ–ò–†–ê–ù–ò –ø—Ä–æ–º–ø—Ç–∏)
       ‚Üì
handleGetDefaultPrompt() ‚Üí –≤—Ä—ä—â–∞ embedded prompt
```

### –°–ª–µ–¥ (Single Source of Truth)
```
KV/prompts/*.txt (694 —Ä–µ–¥–∞ –ø—Ä–æ–º–ø—Ç–∏)
       ‚Üì
   upload to KV Storage
       ‚Üì
handleGetDefaultPrompt() ‚Üí —á–µ—Ç–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç KV
```

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω –∏–∑—Ç–æ—á–Ω–∏–∫ –Ω–∞ –∏—Å—Ç–∏–Ω–∞:** –ü—Ä–æ–º–ø—Ç–∏—Ç–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç –°–ê–ú–û –≤ KV storage, –Ω–µ —Å–∞ embedded –≤ –∫–æ–¥–∞.

## üéØ –ó–∞—â–æ –¢–æ–≤–∞ –µ –ü–æ-–î–æ–±—Ä–æ

### 1. –ù—è–º–∞ –î—É–±–ª–∏—Ä–∞–Ω–µ
- **–ü—Ä–µ–¥–∏:** –ü—Ä–æ–º–ø—Ç–∏—Ç–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ö–∞ –Ω–∞ 2 –º–µ—Å—Ç–∞ (KV —Ñ–∞–π–ª–æ–≤–µ + worker.js)
- **–°–ª–µ–¥:** –ü—Ä–æ–º–ø—Ç–∏—Ç–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç –°–ê–ú–û –≤ KV storage

### 2. –ü–æ-–õ–µ—Å–Ω–∞ –ü–æ–¥–¥—Ä—ä–∂–∫–∞
- **–ü—Ä–µ–¥–∏:** –ü—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ –ø—Ä–æ–º–ø—Ç —Ç—Ä—è–±–≤–∞—à–µ –¥–∞ —Å–µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞—Ç 2 –º–µ—Å—Ç–∞
- **–°–ª–µ–¥:** –ü—Ä–æ–º—è–Ω–∞—Ç–∞ —Å–µ –ø—Ä–∞–≤–∏ —Å–∞–º–æ –≤ KV/prompts/*.txt –∏ —Å–µ upload-–≤–∞

### 3. –ü–æ-–ú–∞–ª—ä–∫ worker.js
- **–ü—Ä–µ–¥–∏:** 7,419 —Ä–µ–¥–∞
- **–°–ª–µ–¥:** 6,657 —Ä–µ–¥–∞ (-10.3%)

### 4. –ü–æ-–ß–∏—Å—Ç –ö–æ–¥
- –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ –∏–∑–ª–∏—à–Ω–æ –¥—É–±–ª–∏—Ä–∞–Ω–µ
- –ü–æ-—è—Å–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- Single source of truth

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

### –ò–∑–∏—Å–∫–≤–∞–Ω–∏—è
–ó–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ admin panel "View Default Prompt", –ø—Ä–æ–º–ø—Ç–∏—Ç–µ –¢–†–Ø–ë–í–ê –¥–∞ —Å–∞ upload-–Ω–∞—Ç–∏ –≤ KV:
```bash
cd KV
./upload-kv-keys.sh
```

### –ê–∫–æ –ü—Ä–æ–º–ø—Ç–∏—Ç–µ –õ–∏–ø—Å–≤–∞—Ç –≤ KV
`handleGetDefaultPrompt()` —â–µ –≤—ä—Ä–Ω–µ 404 error —Å —è—Å–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ:
```json
{
  "error": "Prompt not found in KV storage. Please upload prompts using ./KV/upload-kv-keys.sh",
  "hint": "Missing key: admin_analysis_prompt"
}
```

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –û—Ç–≥–æ–≤–æ—Ä –Ω–∞ –ü—Ä–æ–±–ª–µ–º–∞
‚úÖ **–°–ø—Ä—è—Ö –¥–∞ –¥–æ–±–∞–≤—è–º –∫–æ–¥ –±–µ–∑–∫–æ–Ω—Ç—Ä–æ–ª–Ω–æ**  
‚úÖ **–ü—Ä–µ–º–∞—Ö–Ω–∞—Ö 762 —Ä–µ–¥–∞ –∏–∑–ª–∏—à–µ–Ω –∫–æ–¥ (10.3% —Ä–µ–¥—É–∫—Ü–∏—è)**  
‚úÖ **–ï–ª–∏–º–∏–Ω–∏—Ä–∞—Ö –¥—É–±–ª–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ–º–ø—Ç–∏—Ç–µ**  
‚úÖ **–ü–æ–¥–æ–±—Ä–∏—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ç–∞ - single source of truth**  

### –°–ª–µ–¥–≤–∞—â–∏ –°—Ç—ä–ø–∫–∏
- ‚úÖ –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç getDefaultPromptTemplates() - –ì–û–¢–û–í–û
- ‚è≥ Consolidate meal plan prompt functions (—Å–ª–µ–¥–≤–∞—â–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- ‚è≥ Extract variable replacement utility (—Å–ª–µ–¥–≤–∞—â–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- ‚è≥ Split handleGeneratePlan() (—Å–ª–µ–¥–≤–∞—â–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–™–†–í–ê –§–ê–ó–ê –ó–ê–í–™–†–®–ï–ù–ê - worker.js –µ 10% –ø–æ-–º–∞–ª—ä–∫ –∏ –ø–æ-—á–∏—Å—Ç

---

**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–î–∞—Ç–∞:** 13.02.2026  
**Commit:** 5a05c80
