# Актуализация: Точни дозировки и разширени категории храни

## Обобщение

Корекция на форматиращите правила за:
1. **Дозировки на добавки**: От диапазони към точни стойности
2. **Категории храни**: Разширени от само "риба" и "зеленчуци" към всички основни категории

## Проблем

Предишните правила бяха неправилни:

### 1. Дозировки (грешно)
```
❌ "Dosages approximate ranges (e.g. "300-400mg", "2-3g") not exact values"
```

Това беше грешно! Дозировките трябва да са **точни**, не диапазони.

### 2. Категории храни (непълни)
```
❌ "Use general food terms: "fish", "vegetables""
```

Липсваха:
- Плодове
- Ядки
- Уточнения/спецификации

## Решение

### 1. Точни дозировки ✅

**Нови правила:**
```
- Supplement dosages: EXACT values (e.g. "400mg", "2g"), NOT ranges like "300-400mg" or "2-3g"
- Supplements must be prescribed specifically for THIS client based on deficiencies/needs, not generic rules
```

**Примери:**

❌ **Грешно (диапазони):**
- "Магнезий 300-400mg"
- "Витамин D 2000-4000 IU"
- "Омега-3 1-2g"

✅ **Правилно (точни):**
- "Магнезий 400mg вечер (заради ниския сън 5ч и високия стрес)"
- "Витамин D 2000 IU дневно (заради недостиг, установен от анализ)"
- "Омега-3 2g дневно (заради хронично възпаление)"

**Ключови принципи:**
1. ✅ Точна доза (не диапазон)
2. ✅ Конкретна обосновка за ТОЗИ клиент
3. ✅ Базирано на дефицити/нужди от анализа
4. ✅ НЕ по общо правило

### 2. Разширени категории храни ✅

**Нови правила:**
```
- Use general food categories unless specific type is medically critical:
  * "fish" (NOT "cod/mackerel/bonito")
  * "vegetables" (NOT "broccoli/cauliflower")
  * "fruits" (NOT "apples/bananas")
  * "nuts" with specification "raw, unsalted" (NOT "peanuts/almonds")
```

**Примери:**

#### Риба
❌ НЕ: "треска", "скумрия", "паламуд"
✅ ДА: "риба"

#### Зеленчуци
❌ НЕ: "броколи", "карфиол", "спанак"
✅ ДА: "зеленчуци", "зелени листни зеленчуци" (ако е по-конкретно)

#### Плодове (НОВО)
❌ НЕ: "ябълки", "банани", "портокали"
✅ ДА: "плодове", "цитрусови плодове" (ако е медицински важно)

#### Ядки (НОВО)
❌ НЕ: "фъстъци", "бадеми", "орехи"
✅ ДА: "ядки (сурови, без сол)"

**Спецификации/уточнения:**
- "ядки (сурови, без сол)" - добавяме уточнение за обработка
- "зелени листни зеленчуци" - по-конкретна подкатегория
- "цитрусови плодове" - ако е важно за витамин C

**Изключение:**
Ако е **медицински критично** (алергия, специфична нужда), може да се използва конкретен вид:
- "избягвай фъстъци (алергия)"
- "използвай броколи (за сулфорафан при детоксикация)"

## Актуализирани промпти

Променени са **IMPORTANT FORMATTING RULES** във:

### 1. Analysis Prompt
```javascript
IMPORTANT FORMATTING RULES:
- NO specific meal times (NOT "12:00", "19:00") - use meal type names ("breakfast", "lunch", "dinner")
- Portions approximate, in ~50g increments (50g, 100g, 150g, 200g, 250g, 300g)
- Use general food categories unless specific type is medically critical:
  * "fish" (NOT "cod/mackerel/bonito")
  * "vegetables" (NOT "broccoli/cauliflower")
  * "fruits" (NOT "apples/bananas")
  * "nuts" with specification "raw, unsalted" (NOT "peanuts/almonds")
- Supplement dosages: EXACT values (e.g. "400mg", "2g"), NOT ranges like "300-400mg" or "2-3g"
- Supplements must be prescribed specifically for THIS client based on deficiencies/needs, not generic rules
```

### 2. Strategy Prompt
Същите правила като Analysis Prompt

### 3. Meal Plan Prompt
Същите правила, без секцията за добавки (защото не се предписват тук)

### 4. Chunk Prompt
Същите правила, без секцията за добавки

## Сравнение преди/след

| Аспект | Преди | След |
|--------|-------|------|
| **Дозировки** | Диапазони (300-400mg) | ✅ Точни (400mg) |
| **Обосновка за добавки** | Не специфицирана | ✅ Конкретна за клиента |
| **Риба** | Общо | ✅ Общо (запазено) |
| **Зеленчуци** | Общо | ✅ Общо (запазено) |
| **Плодове** | ❌ Липсва | ✅ Добавено общо |
| **Ядки** | ❌ Липсва | ✅ Добавено с уточнение |

## Примери от практиката

### Пример 1: Магнезий за сън и стрес

❌ **Преди (грешно):**
```
"Магнезий 300-400mg вечер"
```

✅ **След (правилно):**
```
"Магнезий 400mg вечер (заради недостатъчен сън 5ч, висок стрес 8/10, и мускулни крампи)"
```

### Пример 2: Витамин D при недостиг

❌ **Преди (грешно):**
```
"Витамин D 2000-4000 IU"
```

✅ **След (правилно):**
```
"Витамин D 2000 IU дневно (заради установен недостиг от анализ, зимен сезон, и офис работа)"
```

### Пример 3: Хранене със зеленчуци и плодове

❌ **Преди (непълно):**
```
"Обяд: Пилешко филе със зеленчуци"
```

✅ **След (пълно с всички категории):**
```
"Обяд: Пилешко филе със зеленчуци
Следобедна закуска: Ядки (сурови, без сол) и плодове"
```

## Технически детайли

**Променен файл:** `worker.js`

**Променени функции:**
1. `generateAnalysisPrompt()` - Актуализирани IMPORTANT FORMATTING RULES
2. `generateStrategyPrompt()` - Актуализирани IMPORTANT FORMATTING RULES
3. `generateMealPlanPrompt()` - Актуализирани IMPORTANT FORMATTING RULES
4. `generateMealPlanChunkPrompt()` - Актуализирани IMPORTANT FORMATTING RULES

**Актуализирана документация:**
- `FORMATTING_CORRECTIONS_BG.md` - Актуализирани секции 3 и 4

## Обосновка

### Защо точни дозировки?

1. **Яснота**: Клиентът знае точно колко да взема
2. **Безопасност**: Избягва се свръхдозиране
3. **Ефективност**: Оптималната доза е определена конкретно за него
4. **Индивидуализация**: Базирано на неговите конкретни нужди

### Защо общи категории храни?

1. **Гъвкавост**: Клиентът избира конкретния вид
2. **Наличност**: Различни видове според сезон и магазин
3. **Разнообразие**: Може да варира различни видове
4. **Простота**: По-лесно за следване
5. **Реалистичност**: Не е твърде ограничаващо

### Защо "ядки (сурови, без сол)"?

Уточнението е важно защото:
- Пържените ядки имат различен нутриентен профил
- Солта може да е проблем при хипертония
- Сурови = по-здравословни
- Без сол = по-добро за здравето

## Резултат

Системата сега правилно:

1. ✅ **Предписва точни дозировки** на добавки, конкретни за клиента
2. ✅ **Използва общи категории** за всички видове храни (риба, зеленчуци, плодове, ядки)
3. ✅ **Добавя уточнения** когато е необходимо (напр. "сурови, без сол")
4. ✅ **Позволява гъвкавост** на клиента в избора на конкретни видове
5. ✅ **Запазва индивидуализацията** чрез конкретни обосновки

---

*Дата: 2026-02-04*
*Статус: ✅ Завършено и документирано*
*Автор: AI Diet Development Team*
