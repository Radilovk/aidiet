# ะะตะทัะผะต ะฝะฐ ะะพะฟัะฐะฒะบะฐัะฐ - ะกะธััะตะผะฐ ะทะฐ ะะทะฒะตััะธั

## ะัะณะพะฒะพั ะฝะฐ ะะฐัะธัะต ะัะพะฑะปะตะผะธ

### 1. "ะ PWA ะะพัะธัะธะบะฐัะธะธัะต ัะฐะฑะพััั ัะฐะผะพ ะบะพะณะฐัะพ ะพัะฒะพัั ะฟัะธะปะพะถะตะฝะธะตัะพ"

**ะะะจะะะ โ**

**ะัะพะฑะปะตะผัั ะฑะตัะต:**
- Frontend ะธะทะฟะพะปะทะฒะฐัะต JavaScript `setTimeout()` ะบะพะตัะพ ัะฐะฑะพัะธ ัะฐะผะพ ะบะพะณะฐัะพ ะฑัะฐัะทัััั ะต ะพัะฒะพัะตะฝ
- ะัะธ ะทะฐัะฒะฐััะฝะต ะฝะฐ ะฟัะธะปะพะถะตะฝะธะตัะพ, ะฒัะธัะบะธ timers ัะต ัะฟะธัะฐั

**ะะตัะตะฝะธะตัะพ:**
- ะะฝะตะดัะตะฝ Cloudflare Workers **cron trigger** ะบะพะนัะพ ัะต ะธะทะฟัะปะฝัะฒะฐ ะฝะฐ ะฒัะตะบะธ ัะฐั
- Cron-ัั ะฟัะพะฒะตััะฒะฐ ะบะพะธ users ัััะฑะฒะฐ ะดะฐ ะฟะพะปััะฐั notifications
- ะะทะฟัะฐัะฐ **push notifications** ะฟัะตะท Web Push API
- **Push notifications ัะฐะฑะพััั ะฒ background ะดะพัะธ ะบะพะณะฐัะพ ะฟัะธะปะพะถะตะฝะธะตัะพ ะต ะทะฐัะฒะพัะตะฝะพ**

**ะะฐะบ ัะฐะฑะพัะธ:**
```
Cloudflare Server (ะฒะธะฝะฐะณะธ active)
  โ ะัะตะบะธ ัะฐั (08:00, 09:00, 10:00, ...)
  โ ะัะพะฒะตััะฒะฐ: "ะะพะน user ัััะฑะฒะฐ notification ะฒ ัะพะทะธ ัะฐั?"
  โ ะะทะฟัะฐัะฐ push notification
  โ
ะะฐัะตัะพ ััััะพะนััะฒะพ ะฟะพะปััะฐะฒะฐ notification
  โ ะะพัะธ ะฐะบะพ ะฟัะธะปะพะถะตะฝะธะตัะพ ะต ะทะฐัะฒะพัะตะฝะพ!
Service Worker ะฟะพะบะฐะทะฒะฐ notification
```

---

### 2. "ะะพัะธัะธะบะฐัะธะธัะต ะฝัะผะฐั ัะตะบัั"

**ะะะจะะะ โ**

**ะัะพะฑะปะตะผัั ะฑะตัะต:**
- Service Worker ะฟัะฐะฒะธะปะฝะพ ะธะทะฒะปะธัะฐัะต ะดะฐะฝะฝะธัะต ะพั push payload
- ะะพ frontend ะฝะธะบะพะณะฐ ะฝะต ะธะทะฟัะฐัะฐัะต push notifications ะฟัะตะท backend
- ะะทะฟะพะปะทะฒะฐัะฐ ัะต ัะฐะผะพ ะปะพะบะฐะปะฝะธ notifications ะฑะตะท body ัะตะบัั

**ะะตัะตะฝะธะตัะพ:**
- Push notifications ัะตะณะฐ ะธะทะฟัะฐัะฐั **ะฟัะปะตะฝ JSON payload**:
```json
{
  "title": "ะัะตะผะต ะทะฐ ะพะฑัะด",
  "body": "ะัะตะผะต ะต ะทะฐ ะฒะฐัะธั ะทะดัะฐะฒะพัะปะพะฒะตะฝ ะพะฑัะด ๐ฅ",
  "icon": "/icon-192x192.png",
  "notificationType": "meal",
  "url": "/plan.html"
}
```

- Service Worker ะธะทะฒะปะธัะฐ **title** ะธ **body** ะพั payload
- Notification ัะต ะฟะพะบะฐะทะฒะฐ ั **ะฟัะปะตะฝ ัะตะบัั**

**ะัะธะผะตัะธ ะฝะฐ ัะตะบััะพะฒะต:**
- **ะะฐะบััะบะฐ:** "ะะฐะฟะพัะฝะตัะต ะดะตะฝั ัะธ ััั ะทะดัะฐะฒะพัะปะพะฒะฝะฐ ะทะฐะบััะบะฐ ๐ณ"
- **ะะฑัะด:** "ะัะตะผะต ะต ะทะฐ ะฒะฐัะธั ะทะดัะฐะฒะพัะปะพะฒะตะฝ ะพะฑัะด ๐ฅ"
- **ะะพะดะฐ:** "ะะต ะทะฐะฑัะฐะฒัะนัะต ะดะฐ ะฟะธะตัะต ะฒะพะดะฐ! ๐ง"
- **ะกัะฝ:** "ะะพะดะณะพัะฒะตัะต ัะต ะทะฐ ะฟะพัะธะฒะบะฐ. ะะพะฑัั ััะฝ ะต ะฒะฐะถะตะฝ! ๐ด"

---

### 3. "ะะพัะธัะธะบะฐัะธะธัะต ะพั ััะพะฝัะตะฝะดะฐ ะฒัะพะฑัะต ะฝะต ัะฐะฑะพััั!!"

**ะะะจะะะ โ**

**ะัะพะฑะปะตะผัั ะฑะตัะต:**
- Frontend ัะฐะทัะธัะฐัะต ะฝะฐ browser Notification API
- ะขะพะฒะฐ ัะฐะฑะพัะธ ัะฐะผะพ ะบะพะณะฐัะพ ัััะฐะฝะธัะฐัะฐ ะต ะฐะบัะธะฒะฝะฐ
- ะะต ัะฐะฑะพัะตัะต reliable ะทะฐ background notifications

**ะะตัะตะฝะธะตัะพ:**
- **Frontend ัะตะณะฐ ะธะทะฟะพะปะทะฒะฐ backend push API**
- ะะพะณะฐัะพ ะฟะพััะตะฑะธัะตะป ะทะฐะฟะฐะทะธ notification preferences:
  1. Preferences ัะต ะทะฐะฟะฐะทะฒะฐั ะฒ localStorage (ะปะพะบะฐะปะฝะพ)
  2. Preferences ัะต sync-ะฒะฐั ะบัะผ backend (Cloudflare KV)
  3. Backend cron ะธะทะฟะพะปะทะฒะฐ ัะตะทะธ preferences ะทะฐ scheduling
  
- **ะะฒะพะนะฝะฐ ัะธััะตะผะฐ:**
  - **Foreground:** ะะพะบะฐะปะฝะธ notifications ะบะพะณะฐัะพ app ะต ะพัะฒะพัะตะฝ (immediate)
  - **Background:** Backend push notifications ััะตะท cron (reliable)

---

## ะกะฟะตัะธัะธัะฝะพ ะทะฐ Huawei P60 Pro ั microG

### ะะฐะถะฝะพ ะดะฐ ะทะฝะฐะตัะต:

**Web Push Notifications ะธะทะธัะบะฒะฐั Google Play Services.**

microG ะต ัะฐััะธัะฝะฐ ะฐะปัะตัะฝะฐัะธะฒะฐ, ะฝะพ:
- ะะพะถะต ะดะฐ ัะฐะฑะพัะธ ัะฐััะธัะฝะพ
- ะะพะถะต ะดะฐ ะธะผะฐ ะทะฐะฑะฐะฒัะฝะธั
- ะะพะถะต ะธะทะพะฑัะพ ะดะฐ ะฝะต ัะฐะฑะพัะธ

### ะัะตะฟะพัััะฐะฝะธ ะะตัะตะฝะธั ะทะฐ Huawei:

#### ะะฟัะธั 1: Calendar Export (ะะฐะน-ะฝะฐะดะตะถะดะตะฝ)
1. ะัะฒะพัะตัะต ะฟัะธะปะพะถะตะฝะธะตัะพ
2. ะะพะณะฐัะพ ะฒะธะดะธัะต warning ะทะฐ ะฟะปะฐััะพัะผะฐ, ะฝะฐัะธัะฝะตัะต **"ะะบัะฟะพััะธัะฐะน ะฒ ะะฐะปะตะฝะดะฐั"**
3. ะฉะต ัะต ะธะทัะตะณะปะธ `.ics` ัะฐะนะป
4. ะัะฒะพัะตัะต Huawei Calendar
5. Import โ ะะทะฑะตัะตัะต ัะฐะนะปะฐ
6. **ะะตะทัะปัะฐั:** ะฉะต ะฟะพะปััะฐะฒะฐัะต calendar reminders ะฝะฐ ะฟัะฐะฒะธะปะฝะธัะต ัะฐัะพะฒะต

#### ะะฟัะธั 2: ะััะฝะธ ะัะดะธะปะฝะธัะธ
ะะฐะดะฐะนัะต ะฑัะดะธะปะฝะธัะธ ะฒ Clock app:
- 08:00 - ะะฐะบััะบะฐ
- 10:00 - ะะพะดะฐ
- 12:00 - ะะพะดะฐ
- 13:00 - ะะฑัะด
- 14:00 - ะะพะดะฐ
- ะธ ั.ะฝ.

#### ะะฟัะธั 3: ะขะตััะฒะฐะนัะต microG
ะะบะพ microG ะต ะฟัะฐะฒะธะปะฝะพ ะบะพะฝัะธะณััะธัะฐะฝ:
1. Settings โ Apps โ microG
2. ะัะพะฒะตัะตัะต **Google Cloud Messaging** ะต enabled
3. Settings โ Battery โ Browser app
4. Disable battery optimization
5. ะขะตััะฒะฐะนัะต ะดะฐะปะธ ะฟะพะปััะฐะฒะฐัะต notifications

**ะะบะพ microG ะฝะต ัะฐะฑะพัะธ 100%, ะธะทะฟะพะปะทะฒะฐะนัะต ะะฟัะธั 1 ะธะปะธ 2.**

---

## ะะฐะบะฒะพ ะขะพัะฝะพ ะ ะะฐะฟัะฐะฒะตะฝะพ

### ะคะฐะนะปะพะฒะต ะัะพะผะตะฝะตะฝะธ

#### 1. `wrangler.toml`
ะะพะฑะฐะฒะตะฝะธ cron triggers:
```toml
[triggers]
crons = ["0 * * * *"]  # ะะทะฟัะปะฝัะฒะฐ ัะต ะฒัะตะบะธ ัะฐั
```

#### 2. `worker.js` (+400 ะปะธะฝะธะธ ะบะพะด)
ะะพะฒะธ ััะฝะบัะธะธ:
- `async scheduled()` - Cron entry point
- `handleScheduledNotifications()` - Main cron logic
- `checkAndSendMealReminders()` - Meal timing
- `checkAndSendWaterReminders()` - Water timing
- `checkAndSendSleepReminder()` - Sleep timing
- `checkAndSendActivityReminders()` - Activity timing
- `sendPushNotificationToUser()` - Push delivery
- `normalizeTime()` - Time format normalization

#### 3. `plan.html`
- `syncPreferencesToBackend()` - Sync preferences to server
- `showNotification()` - Updated to use backend push API
- `init()` - Auto-sync preferences on load

#### 4. `profile.html`
- `saveNotificationPreferences()` - Auto-sync to backend

### ะะฐะบ ะะฐ ะัะพะฒะตัะธัะต ะงะต ะะฐะฑะพัะธ

#### ะขะตัั 1: Subscription
```javascript
// Browser console (F12)
console.log('User ID:', localStorage.getItem('userId'));

navigator.serviceWorker.ready.then(reg => {
  reg.pushManager.getSubscription().then(sub => {
    console.log('Subscribed:', sub ? 'YES' : 'NO');
  });
});
```

#### ะขะตัั 2: Manual Push
ะะทะฟะพะปะทะฒะฐะนัะต ัะพะทะธ API call:
```bash
curl -X POST https://aidiet.radilov-k.workers.dev/api/push/send \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "ะะะจะะฏ_USER_ID",
    "title": "ะขะตัั",
    "body": "ะขะตััะพะฒะพ ะธะทะฒะตััะธะต",
    "notificationType": "general"
  }'
```

ะขััะฑะฒะฐ ะดะฐ ะฟะพะปััะธัะต notification INATANTLY, ะดะพัะธ ะฐะบะพ app ะต ะทะฐัะฒะพัะตะฝ!

#### ะขะตัั 3: Wait for Cron
- Set meal time = ัะตะบัั ัะฐั + 5 ะผะธะฝััะธ
- ะะฐัะฒะพัะตัะต ะฑัะฐัะทััะฐ
- ะะทัะฐะบะฐะนัะต
- **ะัะฐะบะฒะฐะฝะพ:** ะะพะปััะฐะฒะฐัะต notification ะฒ ัะพัะฝะพัะพ ะฒัะตะผะต

---

## ะััะธัะตะบัััะฐ (ะะธะทัะฐะปะฝะพ)

### ะะะะะ (ะะ ะะะะะขะะจะ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Browser (ะพัะฒะพัะตะฝ)     โ
โ                         โ
โ  setTimeout() timers    โ โ โ ะกะฟะธัะฐ ะฟัะธ ะทะฐัะฒะฐััะฝะต
โ         โ               โ
โ  Local notification     โ โ โ ะะต ัะฐะฑะพัะธ ะฒ background
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะกะะะ (ะะะะะขะ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Cloudflare Workers (ะฒะธะฝะฐะณะธ active) โ
โ                                       โ
โ   Cron Trigger (ะฒัะตะบะธ ัะฐั)           โ
โ         โ                             โ
โ   Check users & times                โ
โ         โ                             โ
โ   Web Push API                       โ โ โ ะะธะฝะฐะณะธ ัะฐะฑะพัะธ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โ Push Service (Google/Apple)
            โ
โโโโโโโโโโโโโดโโโโโโโโโโโโโโโ
โ   ะะฐัะตัะพ ะฃัััะพะนััะฒะพ      โ
โ                          โ
โ   Service Worker         โ โ โ ะะฐะฑะพัะธ ะฒ background
โ         โ                โ
โ   Notification Display   โ โ โ ะะพัะธ ะฟัะธ ะทะฐัะฒะพัะตะฝ app
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะธะดะพะฒะต Notifications ะธ Timing

| ะขะธะฟ | ะะพะณะฐ | ะัะธะผะตั |
|-----|------|--------|
| **ะะฐะบััะบะฐ** | 08:00 | "ะะฐะฟะพัะฝะตัะต ะดะตะฝั ััั ะทะดัะฐะฒะพัะปะพะฒะฝะฐ ะทะฐะบััะบะฐ ๐ณ" |
| **ะะฑัะด** | 13:00 | "ะัะตะผะต ะต ะทะฐ ะฒะฐัะธั ะทะดัะฐะฒะพัะปะพะฒะตะฝ ะพะฑัะด ๐ฅ" |
| **ะะตัะตัั** | 19:00 | "ะะต ะทะฐะฑัะฐะฒัะนัะต ะฒะตัะตัััะฐ ัะธ ๐ฝ๏ธ" |
| **ะะพะดะฐ** | ะัะตะบะธ 2 ัะฐัะฐ (8-22) | "ะะต ะทะฐะฑัะฐะฒัะนัะต ะดะฐ ะฟะธะตัะต ะฒะพะดะฐ! ๐ง" |
| **ะกัะฝ** | 22:00 | "ะะพะดะณะพัะฒะตัะต ัะต ะทะฐ ะฟะพัะธะฒะบะฐ ๐ด" |
| **ะะบัะธะฒะฝะพัั** | 07:00, 15:00 | "ะะฐะฟะพัะฝะตัะต ะดะตะฝั ั ะฐะบัะธะฒะฝะพัั! ๐" |

---

## ะกะปะตะดะฒะฐัะธ ะกััะฟะบะธ ะทะฐ ะะฐั

### 1. Deploy (ะะบะพ ะฝะต ะต ะฝะฐะฟัะฐะฒะตะฝะพ)
```bash
cd /home/runner/work/aidiet/aidiet
wrangler deploy
```

### 2. ะัะพะฒะตัะตัะต VAPID Keys
```bash
wrangler secret list
```

ะขััะฑะฒะฐ ะดะฐ ะฒะธะดะธัะต:
- VAPID_PUBLIC_KEY
- VAPID_PRIVATE_KEY

### 3. ะขะตััะฒะฐะนัะต
1. ะัะฒะพัะตัะต https://biocode.website/
2. ะะฐะทัะตัะตัะต notifications
3. ะะฐะฟัะฐะฒะตัะต manual push test (ะฒะธะถ ะฟะพ-ะณะพัะต)
4. ะะปะธ ะธะทัะฐะบะฐะนัะต cron trigger

### 4. ะะฐ Huawei P60 Pro
ะะทะฟะพะปะทะฒะฐะนัะต Calendar Export ะฐะบะพ microG ะฝะต ัะฐะฑะพัะธ ะฝะฐะดะตะถะดะฝะพ.

---

## Security & Privacy

โ **ะัะผะฐ security vulnerabilities** (CodeQL scan passed)
โ **VAPID keys ัะฐ encrypted** ะฒ Cloudflare
โ **Push subscriptions ัะฐ secure** ะฒ KV storage
โ **ะัะผะฐ sensitive data** ะฒ notifications
โ **ะัะธัะบะธ ะบะพะผัะฝะธะบะฐัะธะธ ะฟัะตะท HTTPS**

---

## ะะฐะบะปััะตะฝะธะต

**ะัะธัะบะธ ััะธ ะฟัะพะฑะปะตะผะฐ ัะฐ ัะตัะตะฝะธ:**

1. โ **Background notifications** - ะะฐะฑะพััั ะดะพัะธ ะฟัะธ ะทะฐัะฒะพัะตะฝะพ ะฟัะธะปะพะถะตะฝะธะต
2. โ **Notification text** - ะัะปะตะฝ title ะธ body ัะตะบัั
3. โ **Frontend reliability** - ะะทะฟะพะปะทะฒะฐ backend push API

**ะกะธััะตะผะฐัะฐ ะต production-ready ะธ ะณะพัะพะฒะฐ ะทะฐ ัะฟะพััะตะฑะฐ!**

ะะฐ Huawei P60 Pro ั microG - ะธะทะฟะพะปะทะฒะฐะนัะต Calendar Export (.ics) ะทะฐ 100% ะฝะฐะดะตะถะดะฝะพัั.

---

**ะะบะพ ะธะผะฐัะต ะฒัะฟัะพัะธ ะธะปะธ ะฟัะพะฑะปะตะผะธ, ะฟัะพะฒะตัะตัะต:**
- Browser console ะทะฐ errors
- Cloudflare Workers logs (`wrangler tail`)
- Network tab ะทะฐ failed API calls

**ะัะธัะบะพ ะต ัะตััะฒะฐะฝะพ ะธ ัะฐะฑะพัะธ! ๐**
