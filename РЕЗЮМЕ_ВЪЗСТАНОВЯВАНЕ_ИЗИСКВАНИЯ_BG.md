# Възстановяване на изисквания в промптовете - Кратко резюме (BG)

## Проблем
След последните промени в промптовете при PR#145 не са въведени всички правила и изисквания, които са били изрично въведени преди това. Планът коректор (validatePlan функция) хваща много грешки, което е сигнал, че не се извежда планът и анализа според изискванията.

## Какво беше направено

### ✅ КРИТИЧНИ корекции:

1. **Брой хранения: 1-6 → 1-5**
   - Проблем: Промптът казваше "1-6 хранения на ден", но валидацията позволява само до 5
   - Корекция: Променено на "1-5 хранения" във всички промпти
   - Премахнат редът за 6-то хранене

2. **Минимални дневни калории**
   - Проблем: Не се споменаваше минимум от 800 kcal
   - Корекция: Добавено "minimum 800 kcal/day" като изрично изискване

3. **Пълен списък с LOW-GI храни за късни закуски**
   - Проблем: Промптът казваше само "yogurt, nuts, berries, avocado, seeds"
   - Корекция: Разширен с пълния списък от 23 LOW-GI храни на български и английски:
     - кисело мляко/yogurt, кефир, ядки (бадеми/almonds, орехи/walnuts, кашу/cashews, лешници/hazelnuts)
     - ягоди/berries (боровинки/blueberries, малини/raspberries, черници/blackberries)
     - ябълка/apple, круша/pear, авокадо/avocado
     - семена/seeds (чиа/chia, ленено/flax, тиквени/pumpkin)
     - краставица/cucumber, домат/tomato, хумус/hummus

4. **Задължителни обосновки с минимални дължини**
   - Проблем: Полетата се споменаваха, но не минималните дължини
   - Корекция: Направени ЗАДЪЛЖИТЕЛНИ с точни минимуми:
     - planJustification: минимум 100 символа
     - welcomeMessage: минимум 100 символа (150-250 думи)
     - mealCountJustification: минимум 20 символа
     - afterDinnerMealJustification: минимум 20 символа ИЛИ "Не са необходими"

5. **КРИТИЧНИ МЕДИЦИНСКИ ПРАВИЛА** (липсваха!)
   - Проблем: Общи медицински фактори, но не конкретните правила
   - Корекция: Добавена нова секция "CRITICAL MEDICAL RULES":
     - Диабет + медикаменти → НИКОГА "високовъглехидратно" (използвай Low-carb или Balanced)
     - PCOS/СПКЯ → ИЗБЯГВАЙ "високовъглехидратно" и стандартно "балансирано"
     - IBS/IBD → ЗАДЪЛЖИТЕЛНО "щадящ/gentle" в modifier
     - Анемия + Вегетарианство/Веганство → ЗАДЪЛЖИТЕЛНА добавка с желязо
     - Warfarin + Vitamin K → ОПАСНА ИНТЕРАКЦИЯ - НЕ препоръчвай Vitamin K
     - Антибиотици + Calcium/Magnesium → Разделяне на времето (2+ часа)
     - Антацидни + Желязо → Разделяне на времето (2+ часа)

6. **Толеранс при изчисление на макроси**
   - Проблем: Казваше "PRECISE CALORIES" но не толеранса
   - Корекция: Добавено "(calculated must match declared within ±10% or ±50 kcal tolerance)"

7. **Лимити на порциите**
   - Проблем: Споменаваше 50g инкременти, но не максимум
   - Корекция: Добавено "practical portion sizes (typically 50-800g per component)"

8. **Минимум за recommendations/forbidden списъци**
   - Проблем: Не се споменаваше минимум
   - Корекция: Добавено "MINIMUM 3-5 specific food types" за двата списъка

9. **"Normal" severity СТРОГО ЗАБРАНЕНА**
   - Проблем: Казваше "(Borderline/Risky/Critical only)" но не достатъчно строго
   - Корекция: Променено на "(CRITICAL: ONLY Borderline/Risky/Critical severity - NEVER "Normal" severity)"

### ✅ Допълнителни подобрения:

10. Добавени минимални дължини в анализ TASK секцията:
    - metabolicProfile ≥50 символа
    - psychologicalProfile ≥50 символа
    - всяко reasoning поле ≥20 символа

11. Актуализиран коригиращият промпт (generateCorrectionPrompt) със всички нови изисквания

## Променени функции в worker.js

1. **generateAnalysisPrompt()** (ред ~1813)
   - Добавено: Строга забрана за "Normal" severity
   - Добавено: Минимални дължини на полета

2. **generateStrategyPrompt()** (ред ~1954)
   - Добавено: Секция "TASKS - MANDATORY OUTPUTS" с точни минимуми
   - Добавено: Секция "CRITICAL MEDICAL RULES" с 7 правила
   - Разширено: OUTPUT секция с всички задължителни полета и минимуми

3. **generateMealPlanChunkPrompt()** (ред ~2273)
   - Променено: 1-6/day → 1-5/day
   - Премахнат: Ред за 6-то хранене
   - Добавено: Минимум 800 kcal/day
   - Разширено: LOW-GI храни с пълен списък
   - Добавено: Толеранс за макроси
   - Добавено: Лимити на порциите

4. **generateMealPlanSummaryPrompt()** (ред ~2495)
   - Добавено: "REQUIRED OUTPUT" с минимуми за recommendations/forbidden
   - Добавено: CRITICAL секция за специфичност

5. **generateCorrectionPrompt()** (ред ~1528)
   - Актуализирано: 1-5 хранения (не 6)
   - Добавено: Всички минимални дължини
   - Разширено: Медицински правила
   - Разширено: LOW-GI храни

## Резултат

След тези промени, промптовете сега:

✅ Налагат ВСИЧКИ правила, които validatePlan проверява  
✅ Имат експлицитни минимални изисквания за всички полета  
✅ Съдържат всички критични медицински правила  
✅ Използват точни константи (MAX_MEALS_PER_DAY=5, MIN_DAILY_CALORIES=800, MAX_LATE_SNACK_CALORIES=200)  
✅ Имат пълния LOW_GI_FOODS списък  
✅ Указват толеранси и лимити ясно  

Планът коректор вече НЕ трябва да хваща толкова много грешки, защото промптовете налагат същите изисквания, които валидацията проверява.

## Документация

Пълно резюме на английски: **PROMPT_REQUIREMENTS_RESTORATION_SUMMARY.md**

---

**Дата:** 2026-02-05  
**Статус:** ✅ ЗАВЪРШЕНО  
**Променени файлове:** worker.js  
**Commits:** 3  
**Нови документи:** 2 (този + PROMPT_REQUIREMENTS_RESTORATION_SUMMARY.md)
