<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NutriPlan">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <title>Здравословен Анализ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #10b981;
            --primary-red-hover: #059669;
            --soft-red: #d1fae5;
            --accent-yellow: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-light-red: #f87171;
            --text-dark: #1e3a20;
            --text-gray: #6b7280;
            --bg-color: #fefce8;
            --card-bg: #ffffff;
            --input-bg: #f3f4f6;
            --shadow: 0 10px 30px rgba(16,185,129,0.12);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* Severity colors */
            --severity-normal: #10b981;
            --severity-borderline: #fbbf24;
            --severity-risky: #f97316;
            --severity-critical: #ef4444;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --primary-red: #34d399;
            --primary-red-hover: #10b981;
            --soft-red: #064e3b;
            --accent-yellow: #fcd34d;
            --accent-blue: #60a5fa;
            --accent-light-red: #fca5a5;
            --text-dark: #e5f3e8;
            --text-gray: #9ca3af;
            --bg-color: #0f1419;
            --card-bg: #1a2028;
            --input-bg: #252b35;
            --shadow: 0 10px 30px rgba(52,211,153,0.25);
            
            --severity-normal: #34d399;
            --severity-borderline: #fcd34d;
            --severity-risky: #fb923c;
            --severity-critical: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-dark);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 100px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--text-gray);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .theme-toggle:hover {
            border-color: var(--primary-red);
            transform: scale(1.05);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
            animation: fadeIn 0.6s ease;
        }

        .header-icon {
            font-size: 4rem;
            color: var(--primary-red);
            margin-bottom: 20px;
            display: inline-block;
            background: var(--soft-red);
            padding: 30px;
            border-radius: 50%;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2rem;
            color: var(--text-dark);
            font-weight: 800;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-gray);
            line-height: 1.6;
        }

        .problems-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease;
        }

        .problem-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 6px solid var(--primary-red);
            animation: slideUp 0.5s ease;
        }

        .problem-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(16,185,129,0.2);
        }

        .problem-card.severity-normal {
            border-left-color: var(--severity-normal);
        }

        .problem-card.severity-borderline {
            border-left-color: var(--severity-borderline);
        }

        .problem-card.severity-risky {
            border-left-color: var(--severity-risky);
        }

        .problem-card.severity-critical {
            border-left-color: var(--severity-critical);
        }

        .problem-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .problem-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 200px;
        }

        .problem-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .problem-icon.category-sleep { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .problem-icon.category-nutrition { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .problem-icon.category-hydration { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .problem-icon.category-stress { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .problem-icon.category-activity { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .problem-icon.category-medical { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .problem-title h3 {
            font-size: 1.3rem;
            color: var(--text-dark);
            font-weight: 700;
            margin: 0;
        }

        .severity-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .severity-badge.normal {
            background: var(--severity-normal);
            color: white;
        }

        .severity-badge.borderline {
            background: var(--severity-borderline);
            color: #1e3a20;
        }

        .severity-badge.risky {
            background: var(--severity-risky);
            color: white;
        }

        .severity-badge.critical {
            background: var(--severity-critical);
            color: white;
        }

        .problem-description {
            color: var(--text-gray);
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .severity-meter {
            margin-top: 16px;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-gray);
            font-weight: 600;
        }

        .meter-track {
            height: 12px;
            background: var(--input-bg);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .meter-fill.normal { background: linear-gradient(90deg, var(--severity-normal), #059669); }
        .meter-fill.borderline { background: linear-gradient(90deg, var(--severity-borderline), #f59e0b); }
        .meter-fill.risky { background: linear-gradient(90deg, var(--severity-risky), #ea580c); }
        .meter-fill.critical { background: linear-gradient(90deg, var(--severity-critical), #dc2626); }

        .problem-impact {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--soft-red);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-dark);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .problem-impact i {
            color: var(--primary-red);
            margin-top: 2px;
        }

        .overall-score-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow);
            margin-top: 40px;
            animation: fadeIn 1s ease;
        }

        .overall-score-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .overall-score-header h2 {
            font-size: 1.8rem;
            color: var(--text-dark);
            margin-bottom: 12px;
            font-weight: 800;
        }

        .overall-score-header p {
            color: var(--text-gray);
            font-size: 1rem;
        }

        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .score-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            transition: var(--transition);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 2px solid transparent;
        }

        [data-theme="dark"] .score-card {
            background: linear-gradient(135deg, #1a2028 0%, #252b35 100%);
        }

        .score-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            border-color: var(--primary-red);
        }

        .score-card-header {
            text-align: center;
            padding: 20px 20px 12px;
            background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(16,185,129,0.02) 100%);
        }

        .score-icon-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .score-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            position: relative;
            animation: pulse-icon 2s ease-in-out infinite;
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .score-icon.health {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .score-icon.success {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            animation: trophy-pulse 2s ease-in-out infinite;
        }

        @keyframes trophy-pulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            }
            50% { 
                transform: scale(1.08) rotate(5deg);
                box-shadow: 0 6px 25px rgba(245, 158, 11, 0.6);
            }
        }

        .score-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .score-card-subtitle {
            font-size: 0.85rem;
            color: var(--text-gray);
            font-weight: 500;
            margin-bottom: 0;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            padding: 24px 12px;
        }

        .comparison-side {
            padding: 0 16px;
            text-align: center;
            position: relative;
        }

        .comparison-side.current {
            border-right: 2px solid var(--input-bg);
        }

        .comparison-side.future {
            background: linear-gradient(135deg, rgba(16,185,129,0.03) 0%, rgba(16,185,129,0.08) 100%);
        }

        .comparison-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .comparison-side.current .comparison-label {
            color: #6b7280;
        }

        .comparison-side.future .comparison-label {
            color: var(--primary-red);
        }

        .score-value-container {
            margin-bottom: 16px;
        }

        .score-value {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--text-dark) 0%, var(--text-gray) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .comparison-side.future .score-value {
            background: linear-gradient(135deg, var(--primary-red) 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow-text 2s ease-in-out infinite;
        }

        @keyframes glow-text {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .score-delta {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-red);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .vertical-bar-chart {
            height: 120px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            margin: 16px auto 0;
            position: relative;
        }

        .bar-column {
            width: 40px;
            background: linear-gradient(to top, var(--primary-red) 0%, #34d399 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: height 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -2px 10px rgba(16,185,129,0.3);
            animation: shimmer-bar 3s infinite;
            overflow: hidden;
        }

        .bar-column::before {
            content: '';
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 100%;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.3) 50%,
                rgba(255,255,255,0) 100%);
            animation: bar-shine 2s infinite;
        }

        @keyframes shimmer-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        @keyframes bar-shine {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }

        .comparison-side.current .bar-column {
            background: linear-gradient(to top, #9ca3af 0%, #d1d5db 100%);
            box-shadow: 0 -2px 10px rgba(156,163,175,0.3);
        }



        .cta-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-top: 40px;
            animation: fadeIn 1s ease;
        }

        .cta-section h2 {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 16px;
        }

        .cta-section p {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            /* Touch-friendly improvements */
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary:hover {
            background-color: var(--primary-red-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--input-bg);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--text-gray);
        }

        .error-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .error-icon {
            font-size: 4rem;
            color: var(--severity-critical);
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .header-icon {
                font-size: 3rem;
                padding: 20px;
            }

            .problem-card {
                padding: 20px;
            }

            .problem-title h3 {
                font-size: 1.1rem;
            }

            .problem-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .severity-badge {
                align-self: flex-start;
            }

            .score-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .score-icon {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }

            .score-value {
                font-size: 2.2rem;
            }

            .overall-score-header h2 {
                font-size: 1.5rem;
            }

            .score-card-title {
                font-size: 1rem;
            }

            .score-card-subtitle {
                font-size: 0.8rem;
            }

            .comparison-container {
                padding: 20px 6px;
            }

            .comparison-side {
                padding: 0 10px;
            }

            .comparison-label {
                font-size: 0.7rem;
                letter-spacing: 0.3px;
                margin-bottom: 10px;
            }

            .vertical-bar-chart {
                height: 90px;
            }

            .bar-column {
                width: 32px;
            }

            .score-delta {
                font-size: 0.7rem;
            }
        }

        /* Extra optimizations for very small screens (< 360px) */
        @media (max-width: 360px) {
            .container {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .problem-card {
                padding: 16px;
            }

            .problem-description {
                font-size: 0.9rem;
            }

            .comparison-container {
                padding: 16px 4px;
            }

            .comparison-side {
                padding: 0 8px;
            }

            .score-value {
                font-size: 2rem;
            }

            .comparison-label {
                font-size: 0.65rem;
            }

            .vertical-bar-chart {
                height: 80px;
            }

            .bar-column {
                width: 28px;
            }

            .btn-primary {
                padding: 14px 32px;
                font-size: 1rem;
            }

            .cta-section h2 {
                font-size: 1.3rem;
            }

            .cta-section p {
                font-size: 0.9rem;
            }
        }

        /* Reduce animations on low-end devices for better performance */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Optimize for touch devices */
        @media (hover: none) and (pointer: coarse) {
            .problem-card:hover,
            .score-card:hover {
                transform: none;
            }
            
            .theme-toggle:hover,
            .btn-primary:hover {
                transform: none;
            }
            
            /* Ensure adequate touch targets */
            .theme-toggle {
                min-width: 48px;
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Смени тема">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p class="loading-text">Зареждане на анализа...</p>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <div class="header-icon">
                <i class="fas fa-heartbeat"></i>
            </div>
            <h1>Вашият Здравословен Анализ</h1>
            <p>Идентифицирахме ключови области за подобрение, които могат да повлияят на вашето здраве и целите ви</p>
        </div>

        <div class="problems-container" id="problemsContainer">
            <!-- Problems will be inserted here by JavaScript -->
        </div>

        <!-- Overall Health Score Section -->
        <div class="overall-score-section" id="overallScoreSection" style="display: none;">
            <div class="overall-score-header">
                <h2>Обща Оценка на Здравето</h2>
                <p>Базирана на всички идентифицирани показатели</p>
            </div>

            <div class="score-grid">
                <div class="score-card">
                    <div class="score-card-header">
                        <div class="score-icon-wrapper">
                            <div class="score-icon health">
                                <i class="fas fa-heart-pulse"></i>
                            </div>
                        </div>
                        <div class="score-card-title">Здравословен Статус</div>
                        <div class="score-card-subtitle">Текущо срещу Прогноза</div>
                    </div>
                    <div class="comparison-container">
                        <div class="comparison-side current">
                            <div class="comparison-label">СЕГА</div>
                            <div class="score-value-container">
                                <div class="score-value" id="healthScoreValue">--</div>
                            </div>
                            <div class="vertical-bar-chart">
                                <div class="bar-column" id="healthScoreBarCurrent" style="height: 0%"></div>
                            </div>
                        </div>
                        <div class="comparison-side future">
                            <div class="comparison-label">СЛЕД 3 МЕС</div>
                            <div class="score-value-container">
                                <div class="score-value" id="healthScoreValueFuture">--</div>
                                <div class="score-delta" id="healthScoreDelta">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>--</span>
                                </div>
                            </div>
                            <div class="vertical-bar-chart">
                                <div class="bar-column" id="healthScoreBarFuture" style="height: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="score-card">
                    <div class="score-card-header">
                        <div class="score-icon-wrapper">
                            <div class="score-icon success">
                                <i class="fas fa-trophy"></i>
                            </div>
                        </div>
                        <div class="score-card-title">Постигане на Целта</div>
                        <div class="score-card-subtitle">Шанс за Успех</div>
                    </div>
                    <div class="comparison-container">
                        <div class="comparison-side current">
                            <div class="comparison-label">СЕГА</div>
                            <div class="score-value-container">
                                <div class="score-value" id="successChanceValue">--</div>
                            </div>
                            <div class="vertical-bar-chart">
                                <div class="bar-column" id="successChanceBarCurrent" style="height: 0%"></div>
                            </div>
                        </div>
                        <div class="comparison-side future">
                            <div class="comparison-label">СЛЕД 3 МЕС</div>
                            <div class="score-value-container">
                                <div class="score-value" id="successChanceValueFuture">--</div>
                                <div class="score-delta" id="successChanceDelta">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>--</span>
                                </div>
                            </div>
                            <div class="vertical-bar-chart">
                                <div class="bar-column" id="successChanceBarFuture" style="height: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cta-section">
            <h2>Готови ли сте за промяна?</h2>
            <p>Създадохме персонализиран хранителен план, който ще ви помогне да преодолеете тези предизвикателства и да постигнете целите си.</p>
            <button class="btn-primary" onclick="goToPlan()">
                Виж Хранителния План
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen" style="display: none;">
        <div class="error-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <h2 style="color: var(--text-dark); margin-bottom: 16px;">Грешка</h2>
        <p id="errorMessage" style="color: var(--text-gray); margin-bottom: 24px;">Не може да се зареди анализът. Моля, опитайте отново.</p>
        <div id="errorDetails" style="display: none; background: var(--input-bg); padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <h3 style="color: var(--text-dark); font-size: 0.9rem; margin-bottom: 8px;">
                <i class="fas fa-info-circle"></i> Детайли за грешката:
            </h3>
            <p id="errorDetailsText" style="color: var(--text-gray); font-size: 0.85rem; line-height: 1.5;"></p>
        </div>
        <button class="btn-primary" onclick="window.location.href='questionnaire.html'">
            Назад към въпросника
        </button>
    </div>

    <script>
        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        initializeTheme();

        // Category Icons Mapping
        const categoryIcons = {
            'Sleep': 'fa-bed',
            'Nutrition': 'fa-utensils',
            'Hydration': 'fa-tint',
            'Stress': 'fa-brain',
            'Activity': 'fa-running',
            'Medical': 'fa-heartbeat'
        };

        // Severity Labels in Bulgarian
        const severityLabels = {
            'Normal': 'Нормално',
            'Borderline': 'Гранично',
            'Risky': 'Рисково',
            'Critical': 'Критично'
        };

        // Load and display analysis
        function loadAnalysis() {
            try {
                // Get plan data from localStorage
                const planData = localStorage.getItem('dietPlan');
                
                if (!planData) {
                    showError('Няма налични данни за план. Моля, започнете отначало.');
                    return;
                }

                const plan = JSON.parse(planData);
                
                // Check if there's an error in the plan (from API)
                if (plan.error) {
                    console.error('Plan contains error:', plan.error);
                    showError(plan.error);
                    return;
                }
                
                // Check if analysis and keyProblems exist
                if (!plan.analysis || !plan.analysis.keyProblems || !Array.isArray(plan.analysis.keyProblems)) {
                    console.error('No keyProblems found in analysis');
                    
                    // Check if there's an error message in the analysis
                    let errorMsg = 'Анализът не съдържа информация за здравословни проблеми.';
                    if (plan.analysis && plan.analysis.error) {
                        errorMsg = plan.analysis.error;
                    }
                    
                    showError(errorMsg);
                    return;
                }

                const problems = plan.analysis.keyProblems;
                
                // Display problems
                displayProblems(problems, plan.analysis);
                
                // Hide loading, show content
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading analysis:', error);
                showError('Грешка при зареждането на анализа: ' + error.message);
            }
        }

        function displayProblems(problems, analysis) {
            const container = document.getElementById('problemsContainer');
            container.innerHTML = '';

            // REQUIREMENT 2: Filter out "Normal" severity problems
            const filteredProblems = problems.filter(problem => 
                problem.severity !== 'Normal'
            );
            
            // Show message if no problematic areas found
            if (filteredProblems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow);">
                        <div style="font-size: 3rem; color: var(--primary-red); margin-bottom: 20px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2 style="color: var(--text-dark); margin-bottom: 15px;">Отлично!</h2>
                        <p style="color: var(--text-gray); font-size: 1.1rem;">Не са открити проблемни области, които изискват специално внимание.</p>
                    </div>
                `;
                return;
            }

            filteredProblems.forEach((problem, index) => {
                const card = createProblemCard(problem, index);
                container.appendChild(card);
            });

            // Calculate and display overall scores using filtered problems
            calculateOverallScores(filteredProblems, analysis);
        }

        function calculateOverallScores(problems, analysis) {
            if (!problems || problems.length === 0) return;

            // Health score constants
            // MIN_HEALTH_SCORE: Minimum health score value. 0 represents death, so we use 15 as the minimum
            // for even critical health cases to indicate that the person is alive but in poor health.
            const MIN_HEALTH_SCORE = 15;
            const MAX_HEALTH_SCORE = 100;
            
            // Success chance constants for fallback calculation
            // These match the AI model's range to ensure consistency
            // MIN_SUCCESS_CHANCE: Negative values indicate contradictory goals
            const MIN_SUCCESS_CHANCE = -100;
            const MAX_SUCCESS_CHANCE = 100;

            // Calculate average severity value
            let totalSeverity = 0;
            let criticalCount = 0;
            let riskyCount = 0;
            let borderlineCount = 0;
            
            problems.forEach(problem => {
                totalSeverity += (problem.severityValue || 50);
                const severity = (problem.severity || 'Normal').toLowerCase();
                if (severity === 'critical') criticalCount++;
                else if (severity === 'risky') riskyCount++;
                else if (severity === 'borderline') borderlineCount++;
            });

            const avgSeverity = totalSeverity / problems.length;
            
            // ===== CURRENT SCORES (strategically slightly lower) =====
            // Note: As per product requirements, current scores are strategically adjusted
            // to show a more conservative baseline, making the improvement more impactful
            // for marketing/motivational purposes while maintaining realistic ranges.
            
            // Calculate base health score
            const cappedSeverity = Math.min(avgSeverity, MAX_HEALTH_SCORE);
            const rawHealthScore = MAX_HEALTH_SCORE - cappedSeverity;
            let healthScore = Math.max(MIN_HEALTH_SCORE, Math.min(MAX_HEALTH_SCORE, Math.round(rawHealthScore)));
            
            // Strategic adjustment: Slightly lower current health score (5-10% reduction)
            const healthReduction = Math.floor(healthScore * 0.08); // 8% reduction
            healthScore = Math.max(MIN_HEALTH_SCORE, healthScore - healthReduction);
            
            // Calculate base success chance
            let successChance;
            
            if (analysis && typeof analysis.successChance === 'number') {
                successChance = Math.max(MIN_SUCCESS_CHANCE, Math.min(MAX_SUCCESS_CHANCE, analysis.successChance));
            } else {
                // Fallback calculation
                successChance = 100;
                successChance -= problems.length * 5;
                successChance -= criticalCount * 20;
                successChance -= riskyCount * 12;
                successChance -= borderlineCount * 6;
                successChance = Math.max(MIN_SUCCESS_CHANCE, Math.min(MAX_SUCCESS_CHANCE, successChance));
            }
            
            // Strategic adjustment: Slightly lower current success chance (8-12% reduction)
            const successReduction = Math.floor(Math.abs(successChance) * 0.10); // 10% reduction
            successChance = successChance >= 0 
                ? Math.max(0, successChance - successReduction)
                : successChance; // Keep negative values as-is
            
            // ===== FUTURE SCORES (after 3 months with plan, optimistic) =====
            // Note: Future projections assume strict adherence to the personalized plan
            // and represent achievable improvements with dedication and consistency.
            
            // Assume significant improvement with plan adherence
            // Health improvement: 15-25% increase
            const healthImprovement = Math.floor((MAX_HEALTH_SCORE - healthScore) * 0.35); // 35% of gap to perfect
            const futureHealthScore = Math.min(MAX_HEALTH_SCORE, healthScore + healthImprovement);
            
            // Success chance improvement: 20-35% increase
            let futureSuccessChance;
            if (successChance < 0) {
                // For negative values, move towards positive territory
                futureSuccessChance = Math.min(MAX_SUCCESS_CHANCE, successChance + 40);
            } else {
                const successImprovement = Math.floor((MAX_SUCCESS_CHANCE - successChance) * 0.40); // 40% of gap to perfect
                futureSuccessChance = Math.min(MAX_SUCCESS_CHANCE, successChance + successImprovement);
            }
            
            // Calculate deltas
            const healthDelta = futureHealthScore - healthScore;
            const successDelta = futureSuccessChance - successChance;
            
            // Update UI - Current scores
            document.getElementById('healthScoreValue').textContent = healthScore + '%';
            document.getElementById('successChanceValue').textContent = successChance + '%';
            
            // Update UI - Future scores
            document.getElementById('healthScoreValueFuture').textContent = futureHealthScore + '%';
            document.getElementById('successChanceValueFuture').textContent = futureSuccessChance + '%';
            
            // Update UI - Deltas
            const healthDeltaEl = document.getElementById('healthScoreDelta');
            healthDeltaEl.innerHTML = `
                <i class="fas fa-arrow-up"></i>
                <span>+${healthDelta}%</span>
            `;
            
            const successDeltaEl = document.getElementById('successChanceDelta');
            successDeltaEl.innerHTML = `
                <i class="fas fa-arrow-up"></i>
                <span>+${successDelta}%</span>
            `;
            
            // Store bar heights as percentages (0-100 for visual representation)
            document.getElementById('healthScoreBarCurrent').setAttribute('data-height', healthScore + '%');
            document.getElementById('healthScoreBarFuture').setAttribute('data-height', futureHealthScore + '%');
            
            const successBarWidthCurrent = successChance < 0 ? 0 : successChance;
            const successBarWidthFuture = futureSuccessChance < 0 ? 0 : futureSuccessChance;
            
            document.getElementById('successChanceBarCurrent').setAttribute('data-height', successBarWidthCurrent + '%');
            document.getElementById('successChanceBarFuture').setAttribute('data-height', successBarWidthFuture + '%');
            
            // Show the overall score section
            document.getElementById('overallScoreSection').style.display = 'block';
            
            // Animate bars after a short delay
            setTimeout(() => {
                document.getElementById('healthScoreBarCurrent').style.height = healthScore + '%';
                document.getElementById('healthScoreBarFuture').style.height = futureHealthScore + '%';
                document.getElementById('successChanceBarCurrent').style.height = successBarWidthCurrent + '%';
                document.getElementById('successChanceBarFuture').style.height = successBarWidthFuture + '%';
            }, 300);
        }

        function createProblemCard(problem, index) {
            const card = document.createElement('div');
            const severity = (problem.severity || 'Normal').toLowerCase();
            const severityClass = `severity-${severity}`;
            
            card.className = `problem-card ${severityClass}`;
            card.style.animationDelay = `${index * 0.1}s`;

            const categoryClass = `category-${(problem.category || 'medical').toLowerCase()}`;
            const categoryIcon = categoryIcons[problem.category] || 'fa-heartbeat';
            const severityLabel = severityLabels[problem.severity] || problem.severity;
            const severityValue = problem.severityValue || 50;

            card.innerHTML = `
                <div class="problem-header">
                    <div class="problem-title">
                        <div class="problem-icon ${categoryClass}">
                            <i class="fas ${categoryIcon}"></i>
                        </div>
                        <h3>${problem.title || 'Проблем'}</h3>
                    </div>
                    <div class="severity-badge ${severity}">
                        ${severityLabel}
                    </div>
                </div>
                <p class="problem-description">${problem.description || 'Няма описание'}</p>
                ${problem.impact ? `
                <div class="problem-impact">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${problem.impact}</span>
                </div>
                ` : ''}
                <div class="severity-meter">
                    <div class="meter-label">
                        <span>Ниво на риск</span>
                        <span>${severityValue}%</span>
                    </div>
                    <div class="meter-track">
                        <div class="meter-fill ${severity}" style="width: 0%" data-width="${severityValue}%"></div>
                    </div>
                </div>
            `;

            return card;
        }

        function animateMeters() {
            // Animate severity meters after cards are rendered
            setTimeout(() => {
                const meters = document.querySelectorAll('.meter-fill');
                meters.forEach(meter => {
                    const width = meter.getAttribute('data-width');
                    meter.style.width = width;
                });
            }, 100);
        }

        function showError(errorMessage = null) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            
            const errorScreen = document.getElementById('errorScreen');
            errorScreen.style.display = 'block';
            
            // If we have a detailed error message, show it
            if (errorMessage && errorMessage !== 'Generic error') {
                const errorMessageEl = document.getElementById('errorMessage');
                const errorDetailsEl = document.getElementById('errorDetails');
                const errorDetailsText = document.getElementById('errorDetailsText');
                
                // Set main error message
                errorMessageEl.textContent = 'Анализът не можа да бъде създаден.';
                
                // Show error details
                errorDetailsEl.style.display = 'block';
                errorDetailsText.textContent = errorMessage;
            }
        }

        function goToPlan() {
            window.location.href = 'plan.html';
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadAnalysis();
            // Animate meters after a short delay
            setTimeout(animateMeters, 500);
        });
    </script>
</body>
</html>
