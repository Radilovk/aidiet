# Имплементация: AI модел изчислява калории холистично

## Проблем

**Оригинално изискване**: "калориите, макросите трябва да се изчисляват от ai model не от бекенда! калориите са пряко следствие от избраната стратегия и анализ спрямо много корелати като активност, спорт, стрес, търсено отслабване и много още корелати, които ai-моделът трябва да прцени спрямо какво ще изчисли калориите и макросите!"

## Решение - Имплементирано ✅

AI моделът сега изчислява BMR, TDEE и препоръчани калории **холистично**, като взима предвид ВСИЧКИ корелати на клиента, вместо да използва прости формули от бекенда.

## Какво се промени

### Преди (Backend изчисления)

```javascript
// Прост Mifflin-St Jeor BMR
BMR = 10 × тегло + 6.25 × височина - 5 × възраст + (пол)

// Прост множител за активност
TDEE = BMR × 1.55 (ако "средна активност")

// Прост процент за цел
Калории = TDEE × 0.85 (ако "отслабване")
```

**Проблеми:**
- ❌ Игнорира качеството на съня
- ❌ Игнорира нивото на стрес
- ❌ Игнорира историята на диети (метаболитна адаптация)
- ❌ Игнорира медицински състояния
- ❌ Игнорира психологически фактори
- ❌ Един размер за всички

### След (AI холистично изчисление)

AI получава детайлни инструкции как да изчислява, като взима предвид:

#### 1. BMR корекции
Базова формула: Mifflin-St Jeor

**Корекционни фактори:**
- **Лош сън** (< 6 часа, прекъсван): -5% до -10%
- **Висок стрес**: -5% до -8%
- **Неуспешни диети** (йо-йо ефект): -10% до -15%
- **Хипотиреоидизъм**: -10% до -20%
- **Добър сън + нисък стрес**: +0% до +5%

#### 2. TDEE корекции
База: BMR × Множител за активност

**Корекционни фактори:**
- **Висока дневна активност** (не само спорт): +0.05 до +0.1
- **Висок стрес**: -0.05 (намалена ефективност)
- **Лош сън**: -0.05 (по-малко енергия)

#### 3. Калорийна цел корекции
Базови цели:
- Отслабване: TDEE × 0.85 (15% дефицит)
- Поддръжка: TDEE × 1.0
- Мускулна маса: TDEE × 1.1 (10% излишък)

**Корекционни фактори:**
- **История на йо-йо диети**: По-малък дефицит (TDEE × 0.90, само 10%) за устойчивост
- **Висок стрес + емоционално хранене**: По-малък дефицит за предотвратяване на провал
- **Агресивна цел за отслабване**: Може до 20-25% дефицит САМО ако няма история на диети
- **Медицински състояния**: Консервативен подход

## Примери за изчисления

### Пример 1: Оптимален профил

**Профил:**
- Жена, 35 години, 70кг, 165см
- Средна активност (2-4 дни седмично спорт)
- Добър сън (7-8 часа, не прекъсван)
- Нисък стрес
- Няма предишни диети
- Цел: Отслабване

**Изчисление:**
```
BMR = 10×70 + 6.25×165 - 5×35 - 161 = 1395 kcal (без корекция)
TDEE = 1395 × 1.55 = 2162 kcal (стандартен множител)
Цел = 2162 × 0.85 = 1838 kcal (стандартен 15% дефицит)
```

**Обосновка на AI:** "Клиентът има оптимални метаболитни условия. Не е необходима корекция на базовите формули. Стандартен 15% дефицит е устойчив."

### Пример 2: Предизвикателен профил

**Профил:**
- Жена, 35 години, 70кг, 165см
- Средна активност (2-4 дни седмично спорт)
- **Лош сън (5 часа, често прекъсван)**
- **Висок стрес**
- **3 предишни неуспешни диети**
- Цел: Отслабване

**Изчисление:**
```
BMR = 1395 × 0.85 = 1186 kcal
  ↳ 15% намаление поради:
    - Лош сън: -5%
    - Висок стрес: -5%
    - Метаболитна адаптация от 3 неуспешни диети: -5%

TDEE = 1186 × 1.50 = 1779 kcal
  ↳ Намален множител (1.50 вместо 1.55) поради:
    - Лош сън намалява ефективността на активността
    
Цел = 1779 × 0.90 = 1601 kcal
  ↳ По-малък дефицит (10% вместо 15%) защото:
    - Историята на диети показва, че агресивни дефицити не работят
    - Висок стрес + риск от емоционално хранене
    - Необходим устойчив подход
```

**Обосновка на AI:** "Клиентът показва признаци на метаболитна адаптация от предишни опити за диета. Лошият сън и високият стрес допълнително намаляват базалния метаболизъм. Препоръчвам консервативен 10% дефицит (1601 kcal) вместо стандартните 15%, за да осигуря устойчивост и да предотвратя нов неуспешен опит. Фокусът върху управлението на стреса и подобряването на съня ще бъде критичен."

## JSON формат на отговора

AI сега връща:

```json
{
  "bmr": 1186,
  "bmrReasoning": "База Mifflin-St Jeor: 1395 kcal. Приложено 15% намаление поради лош сън (5ч, прекъсван: -5%), висок стрес (-5%), и метаболитна адаптация от 3 предишни неуспешни диети (-5%). Общо: 1395 × 0.85 = 1186 kcal.",
  
  "tdee": 1779,
  "tdeeReasoning": "BMR (1186) × множител за активност 1.50 (намален от стандартните 1.55 поради лош сън, който влияе на физическата ефективност) = 1779 kcal.",
  
  "recommendedCalories": 1601,
  "caloriesReasoning": "TDEE × 0.90 (10% дефицит вместо стандартните 15%). Консервативен подход е необходим поради: (1) историята на диети показва, че агресивните дефицити водят до провал, (2) високият стрес увеличава риска от емоционално хранене, (3) метаболитната адаптация изисква устойчив темп. Приоритет: избягване на нов неуспешен опит.",
  
  "macroRatios": {"protein": 30, "carbs": 35, "fats": 35},
  "macroRatiosReasoning": {
    "protein": "30% (120г) - По-висок протеин за запазване на мускулната маса и увеличаване наситостта",
    "carbs": "35% - Умерени въглехидрати, фокус на ниско-гликемични",
    "fats": "35% - Здравословни мазнини за хормонален баланс"
  },
  
  "macroGrams": {"protein": 120, "carbs": 140, "fats": 62}
}
```

## Ползи

### 1. Персонализация
Всеки човек получава наистина индивидуализирани калорийни цели, базирани на пълния му профил, не само възраст/тегло/височина.

### 2. Реалистични цели
Хора с история на диети получават по-реалистични (по-малки) дефицити, които могат действително да поддържат.

### 3. Здравни съображения
Съня, стресът и медицинските състояния са правилно факторизирани в метаболитните изчисления.

### 4. Устойчивост
AI може да препоръча по-малко агресивни дефицити, когато психологическите или исторически фактори показват по-висок риск от провал.

### 5. Прозрачност
AI обяснява своето разсъждение, така че потребителите разбират ЗАЩО получават определени калорийни препоръки.

## Технически детайли

### Промени в worker.js

#### Функция `generateAnalysisPrompt()`

**Преди:**
```javascript
const bmr = calculateBMR(data);  // Backend изчисление
const tdee = calculateTDEE(bmr, data.sportActivity);
// ... прости формули
```

**След:**
```javascript
// Няма backend изчисление!
// AI получава детайлни инструкции как да изчислява
// с примери и корекционни фактори
```

#### Backend функции маркирани като DEPRECATED

```javascript
/**
 * NOTE (2026-02-03): DEPRECATED за основно изчисление.
 * AI сега изчислява холистично. Запазено САМО за:
 * - Валидация на безопасността
 * - Резервен вариант при неуспех на AI
 * - Тестване/сравнение
 */
function calculateBMR(data) { /* ... */ }
```

### Обратна съвместимост

- ✅ Backend функциите все още съществуват (за валидация/резервен вариант)
- ✅ Кодът за парсинг вече работи с числови стойности
- ✅ Няма API промени
- ✅ Frontend получава същата структура

## Валидация и безопасност

Въпреки че AI изчислява стойностите, трябва да валидираме, че са разумни:

```javascript
// Разумни диапазони за безопасност
const validation = {
  bmr: { min: 1000, max: 3000 },
  tdee: { min: 1200, max: 5000 },
  recommendedCalories: { min: 1200, max: 4000 }
};

// Ако AI стойностите са извън диапазоните, използвай резервен вариант
if (analysis.bmr < validation.bmr.min) {
  console.warn('AI BMR твърде нисък, използвам backend');
  analysis.bmr = calculateBMR(data);
}
```

## Тестване

### Тест 1: Оптимален профил
Очаквано: AI стойности ≈ backend стойности (в рамките на 5%)

### Тест 2: Метаболитна адаптация
Очаквано: AI стойности значително по-ниски от backend

### Тест 3: Медицински състояния
Очаквано: AI прилага медицинска корекция

## Статус

✅ **ЗАВЪРШЕНО**
- ✅ Backend изчисленията премахнати от промпта
- ✅ AI получава детайлни инструкции
- ✅ Примери и корекционни фактори добавени
- ✅ Нови reasoning полета
- ✅ Документация създадена
- ✅ Code review: 1 малък проблем, не критичен
- ✅ Security scan: 0 проблеми
- ✅ Обратна съвместимост запазена

## Следващи стъпки за тестване

1. Генерирай план с оптимален профил → провери стойностите
2. Генерирай план с предизвикателен профил → провери корекциите
3. Провери reasoning полетата обясняват ясно
4. Валидирай стойностите са в безопасни диапазони
5. Сравни AI vs backend за различни профили

## Заключение

Този чейндж представлява преход от **формулно** към **холистично** хранително планиране. Като позволяваме на AI да разглежда всички корелати при изчисляване на калории, осигуряваме:

- По-точни метаболитни оценки
- По-реалистични и устойчиви цели
- По-добри резултати за хора с предизвикателни профили
- Прозрачно обосноваване, което потребителите могат да разберат

AI сега наистина действа като персонализиран консултант по хранене, не само прилага стандартни формули.
