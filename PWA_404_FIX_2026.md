# PWA 404 Fix - January 2026

## Проблем (Problem)
След инсталация или добавяне на началния екран на телефона, инсталираната апликация не се отваря и показва "404 there isn't a github pages site here".

**English**: After installation or adding to the phone's home screen, the installed application does not open and shows "404 there isn't a github pages site here".

## Причина (Root Cause)
Service worker (`sw.js`) и иконите в `manifest.json` използваха относителни пътища, започващи с `./`, които не работят правилно когато PWA е инсталиран. При стартиране от началния екран, тези пътища се интерпретират спрямо грешната база URL (root `/` вместо `/aidiet/`).

**English**: The service worker (`sw.js`) and icons in `manifest.json` used relative paths starting with `./` which don't work correctly when the PWA is installed. When launched from the home screen, these paths resolve relative to the wrong base URL (root `/` instead of `/aidiet/`).

## Решение (Solution)
Променени са всички относителни пътища (`./`) на абсолютни пътища с `/aidiet/` префикс във:

**English**: Changed all relative paths (`./`) to absolute paths with `/aidiet/` prefix in:

### 1. Service Worker (`sw.js`)
- **STATIC_CACHE масив**: Всички HTML файлове, икони и manifest.json
- **404 fallback handler**: Препращане към index.html
- **Navigation fallback**: Добавени допълнителни проверки за `/aidiet/` и `/aidiet`
- **Push notification**: Icon и badge пътища
- **Notification click handler**: Отваряне на index.html

**English**:
- **STATIC_CACHE array**: All HTML files, icons and manifest.json
- **404 fallback handler**: Redirect to index.html
- **Navigation fallback**: Added additional checks for `/aidiet/` and `/aidiet`
- **Push notification**: Icon and badge paths
- **Notification click handler**: Opening index.html

### 2. Manifest (`manifest.json`)
- Променени всички 4 икони пътища от `./icon-*` на `/aidiet/icon-*`

**English**: Changed all 4 icon paths from `./icon-*` to `/aidiet/icon-*`

## Променени Файлове (Changed Files)
```
manifest.json  - 4 icon paths updated
sw.js          - 17 path references updated
```

## Преди и След (Before and After)

### Преди (Before):
```javascript
// sw.js
const STATIC_CACHE = [
  './index.html',           // ❌ Relative path
  './icon-192x192.png',     // ❌ Relative path
  // ...
];
```

```json
// manifest.json
{
  "icons": [
    {
      "src": "./icon-192x192.png"  // ❌ Relative path
    }
  ]
}
```

### След (After):
```javascript
// sw.js
const STATIC_CACHE = [
  '/aidiet/index.html',           // ✅ Absolute path
  '/aidiet/icon-192x192.png',     // ✅ Absolute path
  // ...
];
```

```json
// manifest.json
{
  "icons": [
    {
      "src": "/aidiet/icon-192x192.png"  // ✅ Absolute path
    }
  ]
}
```

## Тестване (Testing)

### Важно! (Important!)
След deploy на промените на GitHub Pages, трябва да:

**English**: After deploying the changes to GitHub Pages, you must:

1. **Деинсталирайте старата PWA** (ако е инсталирана)
   - Android: Дълго натискане на икона → Деинсталация
   - iOS: Дълго натискане на икона → Премахване на приложение
   
   **English**: Uninstall the old PWA (if installed)
   - Android: Long press icon → Uninstall
   - iOS: Long press icon → Remove App

2. **Изчистете кеша на браузъра**
   - Android Chrome: Настройки → Поверителност и сигурност → Изчистване на данни
   - iOS Safari: Настройки → Safari → Изчистване на история и данни
   
   **English**: Clear browser cache
   - Android Chrome: Settings → Privacy and security → Clear browsing data
   - iOS Safari: Settings → Safari → Clear History and Website Data

3. **Отворете приложението отново**
   - Отидете на https://radilovk.github.io/aidiet/
   - Изчакайте service worker да се регистрира
   
   **English**: Open the application again
   - Go to https://radilovk.github.io/aidiet/
   - Wait for service worker to register

4. **Инсталирайте PWA отново**
   - Android: Menu (⋮) → "Install app"
   - iOS: Share (⬆️) → "Add to Home Screen"
   
   **English**: Install PWA again
   - Android: Menu (⋮) → "Install app"
   - iOS: Share (⬆️) → "Add to Home Screen"

5. **Отворете от началния екран**
   - Натиснете иконата на NutriPlan
   - **Очаквано**: Приложението се отваря правилно (БЕЗ 404 грешка)
   
   **English**: Open from home screen
   - Tap the NutriPlan icon
   - **Expected**: App opens correctly (WITHOUT 404 error)

## Валидация (Validation)
Създаден е скрипт за валидация на пътищата:

**English**: Created a validation script for the paths:

```bash
cd /home/runner/work/aidiet/aidiet
node << 'EOF'
const fs = require('fs');
const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
const sw = fs.readFileSync('sw.js', 'utf8');

console.log('manifest.json start_url:', manifest.start_url);
console.log('manifest.json scope:', manifest.scope);
console.log('manifest.json icons:', manifest.icons.map(i => i.src));
console.log('sw.js contains relative paths (./):', sw.includes("'./") || sw.includes('"./')); 
EOF
```

## Защо Това Е Важно? (Why Is This Important?)

Когато PWA е инсталирана на устройство, тя работи като самостоятелно приложение. При отваряне, браузърът:

**English**: When a PWA is installed on a device, it works as a standalone application. When opening, the browser:

1. Зарежда `start_url` от manifest.json (`/aidiet/`)
2. Регистрира service worker от тази локация
3. Service worker се опитва да кешира файлове от `STATIC_CACHE`

Ако service worker използва относителни пътища (`./`), те се интерпретират като:
- `./index.html` → `/index.html` (ГРЕШНО, трябва `/aidiet/index.html`)
- Това води до 404 грешка защото файлът е на `/aidiet/index.html`

**English**: If the service worker uses relative paths (`./`), they are interpreted as:
- `./index.html` → `/index.html` (WRONG, should be `/aidiet/index.html`)
- This leads to 404 error because the file is at `/aidiet/index.html`

## Допълнителна Информация (Additional Information)

### Защо `manifest.json` вече беше правилен?
Преди тази промяна, `start_url` и `scope` в manifest.json вече бяха коректни (`/aidiet/`). Това е било поправено в по-ранна версия (виж `PWA_FIX_2025_ICON_AND_URL.md`).

**English**: Before this change, `start_url` and `scope` in manifest.json were already correct (`/aidiet/`). This was fixed in an earlier version (see `PWA_FIX_2025_ICON_AND_URL.md`).

### Защо HTML файловете използват относителни пътища?
HTML файловете (`index.html`, `plan.html` и др.) използват относителни пътища за:
- `<link rel="manifest" href="./manifest.json">`
- Service worker регистрация: `navigator.serviceWorker.register('./sw.js')`

Това е **правилно** защото HTML файловете се зареждат от браузъра от правилната локация (`/aidiet/`), и относителните пътища се интерпретират правилно спрямо локацията на HTML файла.

**English**: HTML files use relative paths for:
- `<link rel="manifest" href="./manifest.json">`
- Service worker registration: `navigator.serviceWorker.register('./sw.js')`

This is **correct** because HTML files are loaded by the browser from the correct location (`/aidiet/`), and relative paths are interpreted correctly relative to the HTML file's location.

## Статус (Status)
✅ **Поправено и готово за тестване на GitHub Pages**

**English**: ✅ **Fixed and ready for testing on GitHub Pages**

## Дата (Date)
**29 януари 2026** / **January 29, 2026**

## Автор (Author)
GitHub Copilot

## Свързани Документи (Related Documents)
- `PWA_FIX_2025_ICON_AND_URL.md` - Previous PWA path fix (start_url, scope)
- `PWA_MOBILE_FIX_2025.md` - PWA installation banner improvements
- `РЕШЕНИЕ_PWA_МОБИЛЕН.md` - PWA mobile solution (Bulgarian)
- `РЕЗУЛТАТ_PWA_ИНСТАЛАЦИЯ.md` - PWA installation results (Bulgarian)
