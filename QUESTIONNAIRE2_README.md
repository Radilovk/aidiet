# Въпросник 2.0 - Детайлна Консултация

## Описание

Въпросник 2.0 е независима версия на оригиналния въпросник, създадена специално за събиране на детайлна информация от клиенти за последваща обработка от екипа.

## Основни различия от оригиналния въпросник

### 1. Съхранение на данни
- **Оригинален въпросник**: Изпраща данни директно към API (`/api/generate-plan`) за моментална обработка и генериране на план
- **Въпросник 2.0**: Съхранява данните локално и предоставя възможност за изтегляне като JSON файл

### 2. Прикачване на файлове
Добавено е ново поле в секцията "Допълнителна информация":
- **Тип**: File upload (множествен избор)
- **ID**: `medicalFiles`
- **Описание**: "Прикачете файлове или снимки с изследвания (по желание)"
- **Поддържани формати**: Снимки (image/*), PDF, Word документи (.doc, .docx)
- **Функционалност**: 
  - Визуализация на избраните файлове с имена и размер
  - Конвертиране на файловете в base64 формат за съхранение
  - Включване в съхранените данни

### 3. Финален екран
Вместо пренасочване към анализ и план, показва информативен екран с:
- Благодарствено съобщение
- Информация, че данните ще бъдат изпратени на екипа
- Уведомление, че планът ще бъде готов скоро
- Информация за контакт чрез посочения имейл
- Бутон за връщане към началната страница
- Връзка към началната страница

### 4. Независимост
- Напълно отделен HTML файл (`questionnaire2.html`)
- Не е интегриран с останалата част от проекта
- Не използва външен API или backend
- Работи изцяло на клиентска страна

## Структура на съхранените данни

Данните се съхраняват в следния формат:

```json
{
  "id": "client_1234567890_abc123",
  "timestamp": "2026-02-13T12:00:00.000Z",
  "answers": {
    "name": "Име на клиента",
    "email": "email@example.com",
    "age": "35",
    "gender": "Жена",
    ...
  },
  "files": [
    {
      "name": "test-result.pdf",
      "type": "application/pdf",
      "size": 102400,
      "data": "data:application/pdf;base64,..."
    }
  ]
}
```

## Как да използвате

1. Отворете `questionnaire2.html` в браузър
2. Попълнете всички полета на въпросника
3. По желание прикачете файлове/снимки с изследвания
4. Завършете въпросника
5. Вижте съобщението за успех с информация за следващите стъпки
6. Данните се съхраняват автоматично в localStorage на браузъра за вътрешни цели

## Технически детайли

### Промени в кода

1. **Метаданни**:
   - Променено заглавие: "Въпросник 2.0 - Детайлна Консултация"
   - Актуализирани Open Graph и Twitter Card метаданни

2. **Въпроси**:
   - Добавено поле `medicalFiles` с тип `file`

3. **Рендериране**:
   - Добавена логика за рендериране на file input тип
   - Визуален дизайн със стилизиран upload контейнер
   - Показване на списък с избрани файлове

4. **Валидация**:
   - Полето `medicalFiles` е маркирано като optional (винаги валидно)

5. **Submission**:
   - Премахнато извикването към API
   - Добавена логика за конвертиране на файлове в base64
   - Генериране на уникален client ID
   - Съхранение в localStorage за вътрешни цели

### Съвместимост

- Работи във всички модерни браузъри
- Поддържа PWA функционалност (можепо желание)
- Responsive дизайн за мобилни устройства
- Файловете се обработват изцяло на клиента (не се изпращат към сървър)

## Бъдещи подобрения

~~Възможни разширения на функционалността:~~
~~- Автоматично изпращане на данните по имейл~~
~~- Интеграция с облачно хранилище~~
~~- Backend API за директно записване в clients папката~~
~~- Админ панел за преглед на подадените въпросници~~

**АКТУАЛИЗАЦИЯ (Февруари 2026)**: Добавени следните функционалности:
- ✅ Backend API за директно записване на данните (`/api/save-questionnaire2-data`)
- ✅ Страница за възстановяване на данни от локален кеш (`questionnaire2-recovery.html`)

## Възстановяване на данни от кеш

### Страница за възстановяване: `questionnaire2-recovery.html`

Създадена е специална страница за възстановяване на данни от въпросник 2.0, които са били запазени в localStorage на браузъра, но не са били изпратени към сървъра.

#### Функционалност:

**АВТОМАТИЧНО ЗАПАЗВАНЕ** - Всичко се случва автоматично при отваряне на страницата!

1. **Автоматично откриване и изпращане**
   - Страницата автоматично търси всички записи с ключ `questionnaire2_*` в localStorage
   - **Незабавно** ги изпраща към API endpoint `/api/save-questionnaire2-data`
   - Данните се съхраняват в KV хранилището с ключ `questionnaire2_data:{clientId}`
   - След успешно запазване, данните се **автоматично изтриват** от localStorage

2. **Показване на резултата**
   - ✅ **Успешно** - показва брой запазени записи
   - ❌ **Грешка** - показва брой неуспешни опити (данните остават в кеша)
   - ℹ️ **Няма данни** - ако не са открити данни в localStorage

3. **Минимален UI**
   - Без бутони за потребителя (освен връзка към началото)
   - Само показване на резултата: успех или грешка
   - Всичко останало е автоматично

#### Как да използвате:

1. Отворете `questionnaire2-recovery.html` в **същия браузър**, където са били попълнени въпросниците
2. **Изчакайте 1-2 секунди** - всичко се случва автоматично
3. **Виждате резултата** на екрана - дали е успешно или не
4. **Готово!** Никакви действия не са нужни

#### API Endpoint:

**POST** `/api/save-questionnaire2-data`

**Request Body:**
```json
{
  "id": "client_1234567890_abc123",
  "timestamp": "2026-02-13T12:00:00.000Z",
  "answers": {
    "name": "Име на клиента",
    "email": "email@example.com",
    ...
  },
  "files": [...]
}
```

**Response:**
```json
{
  "success": true,
  "id": "client_1234567890_abc123",
  "message": "Questionnaire data saved successfully"
}
```

#### Техническа информация:

- Данните се съхраняват в Cloudflare KV с ключ `questionnaire2_data:{clientId}`
- Поддържа се списък с всички ID-та на подадени въпросници в ключ `questionnaire2_data_list`
- След успешно запазване в KV, данните се премахват от localStorage
- Всички операции са асинхронни и показват статус на потребителя

## Папка clients

Създадена е папка `clients` в root на проекта, където могат да се архивират изтеглените JSON файлове.
- Папката е конфигурирана в `.gitignore` да не следи JSON файлове
- Включва README.md с документация
- Включва .gitkeep за запазване на папката в Git

## Забележки

- Този въпросник е напълно независим от основния проект
- Не заменя оригиналния въпросник
- Предназначен е за случаи, където се иска ръчна обработка на данните от екип
- Подходящ за VIP клиенти или специални консултации

## ВАЖНО: Възстановяване на загубени данни

Ако данните от въпросник 2.0 са останали само в локалния кеш на браузъра и не са били записани на сървъра:

1. **НЕ ЗАТВАРЯЙТЕ БРАУЗЪРА** и не изчиствайте кеша
2. Отворете в **същия браузър** страницата: `questionnaire2-recovery.html`
3. Страницата автоматично ще намери и покаже данните от localStorage
4. Използвайте бутона "Запази в сървъра" за да ги запазите постоянно в KV хранилището
5. Алтернативно, използвайте "Изтегли като файл" за локално архивиране

**Забележка**: Данните в localStorage се запазват само докато не се изчисти кеша на браузъра или докато не се изтрият ръчно.
