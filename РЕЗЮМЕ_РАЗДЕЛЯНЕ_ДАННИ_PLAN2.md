# Резюме: Разделяне на данните в Plan2 промпти

## ВАЖНО УТОЧНЕНИЕ - Какво точно е Сектор 3?

**❗ КРИТИЧНО ЗА РАЗБИРАНЕ:**

**Сектор 3 НЕ е "всички данни които се предават към следващата стъпка".**

**Сектор 3 е "данни от АНАЛИЗА на текущата стъпка, които са полезни за следващата стъпка".**

### Пълната формула:

```
Вход на Стъпка N = 
  userData (отговори от въпросника) +
  Сектор 3 от Стъпка N-1 (анализ) +
  Сектор 3 от Стъпка N-2 (ако е нужно) +
  Допълнителни елементи (whitelists, blacklists и др.)
```

### Конкретни примери:

**Стъпка 2 (Стратегия) получава:**
- ✅ userData (клиентски данни от въпросника - name, age, goal, preferences и др.)
- ✅ Сектор 3 от Стъпка 1 (metabolicProfile, psychoProfile, healthRisks и др.)

**Стъпка 3 (Хранителен план) получава:**
- ✅ userData (клиентски данни от въпросника - name, age, goal, dietDislike, dietLove и др.)
- ✅ Сектор 3 от Стъпка 1 (macroGrams, recommendedCalories)
- ✅ Сектор 3 от Стъпка 2 (weeklyScheme, keyPrinciples, foodsToInclude, foodsToAvoid и др.)
- ✅ dynamicWhitelistSection (от KV storage)
- ✅ dynamicBlacklistSection (от KV storage)
- ✅ previousDays (за разнообразие при chunk генериране)

**Стъпка 4 (Резюме) получава:**
- ✅ userData (частични клиентски данни - name, goal, medications и др.)
- ✅ Избрани данни от Стъпка 1 (BMR, keyProblems)
- ✅ Избрани данни от Стъпка 2 (psychologicalSupport, hydrationStrategy)
- ✅ Агрегирани данни от Стъпка 3 (avgCalories, avgMacros)
- ✅ dynamicWhitelistSection (от KV storage)
- ✅ dynamicBlacklistSection (от KV storage)

---

## Изпълнени промени

### ✅ Постигнато

Успешно имплементирано **ясно разделяне на 3 сектора** във всички промпти от Plan2 и KV storage:

#### 1. СЕКТОР 1: Обработка и анализ на входни данни от бекенда
- Данни за вътрешна обработка
- Валидация и корекции на изчисления
- Стратегически решения

#### 2. СЕКТОР 2: Отговор за frontend парсване
- Данни за директно показване на потребителя
- UI елементи, съобщения, графики
- Готови за визуализация без допълнителна обработка

#### 3. СЕКТОР 3: Отговор за следваща стъпка
- Контекст за предаване към следващата стъпка на анализ
- Предава се в КОМПАКТЕН формат за оптимизация
- Ясно дефинирано какво се предава накъде

---

## Структура на промените

### План2 файл
Всички 4 стъпки са структурирани с:
- Хедър с документация (вход, цели, изход)
- JSON формат с ясно разделение на секторите
- Коментари в JSON за обяснение на всяко поле

**Стъпка 1 (Анализ):**
```
Вход: Клиентски данни + Backend изчисления
Сектор 1 → BMR, TDEE, макроси, психопрофил (обработка)
Сектор 2 → Здравен статус, проблеми, прогнози (frontend)
Сектор 3 → Метаболитен профил, рискове (за стъпка 2)
```

**Стъпка 2 (Стратегия):**
```
Вход: Клиентски данни + КОМПАКТЕН анализ от стъпка 1
Сектор 1 → Диетичен модификатор, обосновки (обработка)
Сектор 2 → Welcome message, психология (frontend)
Сектор 3 → Седмична схема, правила за храни (за стъпка 3)
```

**Стъпка 3 (Хранителен план):**
```
Вход: Клиентски данни + КОМПАКТНА стратегия + МИНИМАЛЕН анализ
Сектор 1 → (използва входни данни за генериране)
Сектор 2 → Хранения по дни с макроси (frontend)
Сектор 3 → Средни стойности (изчислени от backend за стъпка 4)
```

**Стъпка 4 (Резюме):**
```
Вход: Агрегирани данни от стъпки 1-3
Сектор 1 → Summary validation (обработка)
Сектор 2 → Препоръки, забрани, добавки, психология (frontend)
Сектор 3 → (няма - финална стъпка)
```

### KV/prompts/ файлове
Синхронизирани идентично с Plan2:
- `admin_analysis_prompt.txt` (Стъпка 1)
- `admin_strategy_prompt.txt` (Стъпка 2)
- `admin_meal_plan_prompt.txt` (Стъпка 3)
- `admin_summary_prompt.txt` (Стъпка 4)

### Документация
- `PLAN2_DATA_SEPARATION_DOCUMENTATION.md` (английски)
- `РЕЗЮМЕ_РАЗДЕЛЯНЕ_ДАННИ_PLAN2.md` (български - този файл)

---

## Предимства на новата структура

### 1. Яснота
- Всеки промпт ясно показва какви данни очаква
- Ясно е какви данни връща
- Ясно е къде отиват данните

### 2. Оптимизация
- Виждаме къде данните се компактират (стъпка 1→2, стъпка 2→3)
- Избягваме изпращане на излишни данни
- Запазена е съществуващата оптимизация (76% редукция за strategy, 37.6% за analysis)

### 3. Поддръжка
- Лесно добавяне на нови полета в правилния сектор
- Ясна документация за всяко поле
- Синхронизация между Plan2 и KV промптове

### 4. Образование
- Нови разработчици лесно разбират data flow
- Документацията обяснява целта на всяко поле
- Примери и описания за всяка стъпка

---

## Спазени принципи

✅ **Минимални промени**: Само коментари и документация, нула промени в JSON полета

✅ **Запазена функционалност**: Системата работи идентично както преди

✅ **Без излишен код**: Само необходимата структура и документация

✅ **Прецизност**: Точно разграничение на секторите според предназначение

✅ **Икономичност**: Компактни формати където е необходимо

✅ **Без объркване**: Ясна структура, лесна за разбиране

---

## Статистика

- **Променени файлове**: 6 (Plan2 + 4 KV промпта + 2 документации)
- **Добавени редове**: ~550 (документация и коментари)
- **Променени JSON полета**: 0
- **Променени функционалности**: 0
- **Качество на кода**: Подобрено (документация)

---

## Употреба

### При четене на промптите:
1. Погледнете хедъра (═══) за вход и цели
2. В JSON формата следвайте коментарите СЕКТОР 1/2/3
3. Разберете къде отиват данните според секторите

### При промяна на промптите:
1. Запазете структурата на секторите
2. Добавяйте полета в правилния сектор
3. Синхронизирайте промените между Plan2 и KV

### При debugging:
1. Проверете входа в хедъра на стъпката
2. Проверете какъв сектор трябва да върне данните
3. Проверете дали данните се предават към следващата стъпка

---

## Заключение

Промените постигат **точно исканото**:

✅ Ясно разделяне между:
1. Данни за обработка и анализ от бекенда
2. Данни за директно парсване към фронтенда
3. Данни за предаване към следващата стъпка

✅ Прецизна и икономична намеса:
- Без излишно писане на код
- Без повторения
- Без объркване
- Без ненужни данни

✅ Подобрена структура:
- До момента структурата беше подобна
- Сега е изчистена и прецизирана
- Лесна за поддръжка и разширение

---

**Дата**: 18 февруари 2026  
**Статус**: ✅ Завършено  
**Качество**: Проверено с code review (0 проблема)  
**Сигурност**: Проверено с CodeQL (0 проблема)
